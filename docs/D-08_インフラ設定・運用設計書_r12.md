# D-08 インフラ設定・運用設計書 (r12)

## 1. 概要

### 1.1 目的

本ドキュメントは、EAP-AKA RADIUS PoC環境のインフラストラクチャ設定内容および運用手順を定義する。Docker Compose環境、Valkey設定、Fluent Bit設定、ホストOS設定を対象とする。

### 1.2 スコープ

**本書で扱う範囲：**

- Valkey設定内容（永続化、メモリ、ACL）
- Fluent Bit設定内容（ログ収集、ローテーション）
- Docker Compose設定内容（サービス定義、ヘルスチェック）
- ホストOS設定内容（タイムゾーン、NTP、UFW、SSH）
- 運用手順（状態確認、ログ確認、トラブルシューティング）

**デプロイ手順書（B-02）で扱う範囲：**
- リポジトリのクローン（`git clone`）
- 環境変数ファイル（`.env`）の作成手順
- `docker compose up -d` による起動
- Admin TUIのビルド・配置手順
- logrotate設定ファイルの配置
- バックアップスクリプトの初回設定手順
- lnavフォーマットファイルの配置

**本書で扱わない範囲：**
- アプリケーションの詳細設計（各詳細設計書を参照）
- テスト手順（テスト仕様書を参照）
- 障害時の詳細なエスカレーションフロー（PoC完了後に作成）

### 1.3 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| ミニPC版EAP-AKA RADIUS PoC環境設計仕様書 (r9) | システム構成、パッケージ利用 |
| Valkeyデータ設計仕様書 (r10) | データ構造、TTL設定、SQN競合制御方針 |
| ログ仕様設計書 (r13) | ログフォーマット、event_id定義、IMSIマスキング |
| エラーハンドリング詳細設計書 (r6) | タイムアウト設定、リトライ戦略、SQN競合エラー |
| Auth Server詳細設計書 (r9) | Auth Server環境変数、IMSIマスキング |
| Acct Server詳細設計書 (r5) | Acct Server環境変数、IMSIマスキング |
| Vector API詳細設計書 (r6) | Vector API環境変数、IMSIマスキング、テストベクターモード |
| Vector Gateway詳細設計書 (r4) | Vector Gateway環境変数、IMSIマスキング |
| アプリケーションデプロイ手順書 (B-02) | 初期設定手順、Admin TUI配置 |

### 1.4 ハードウェア想定

| 項目 | 想定スペック |
|------|-------------|
| CPU | 4コア以上（Intel N100相当） |
| メモリ | 8GB以上 |
| ストレージ | 256GB SSD以上 |
| ネットワーク | 1GbE有線LAN |
| OS | Ubuntu Server 24.04 LTS |

---

## 2. Valkey設定

### 2.1 設定概要

| 項目 | 設定値 | 備考 |
|------|-------|------|
| 永続化方式 | AOF（Append Only File） | RDB併用なし |
| AOF fsync | `everysec` | 1秒ごとにディスク同期（デフォルト） |
| メモリ上限 | 512MB | PoC規模では十分 |
| メモリ超過ポリシー | `noeviction` | 超過時は書き込みエラー |
| ACL | 単一ユーザー（default） | パスワード認証のみ |
| 接続元制限 | 127.0.0.1のみ（TUI用） + Dockerネットワーク内 | 外部からのアクセス不可 |

### 2.2 Valkey起動オプション

docker-compose.ymlでの設定：

```yaml
valkey:
  image: valkey/valkey:9.0
  ports:
    - "127.0.0.1:6379:6379"
  volumes:
    - valkey_data:/data
  command: >
    valkey-server
    --appendonly yes
    --appendfsync everysec
    --maxmemory 512mb
    --maxmemory-policy noeviction
    --requirepass ${VALKEY_PASSWORD}
  environment:
    - TZ=Asia/Tokyo
  restart: always
```

### 2.3 永続化データの保存場所

| 項目 | パス | 説明 |
|------|------|------|
| Dockerボリューム | `valkey_data` | 名前付きボリューム |
| ホスト上の実体 | `/var/lib/docker/volumes/プロジェクト名_valkey_data/_data` | AOFファイル格納 |
| AOFファイル | `appendonlydir/appendonly.aof.*` | 実際のデータファイル |

### 2.4 バックアップ・リストア

#### バックアップ実行手順

```bash
# バックアップディレクトリ確認
ls -la ~/backups/valkey/

# 手動バックアップ実行
~/scripts/backup_valkey.sh

# バックアップ確認
ls -la ~/backups/valkey/
```

#### リストア手順

```bash
# 1. コンテナ停止
cd ~/eapaka-radius-server-poc/deployments
docker compose stop valkey

# 2. 既存データ削除（必要に応じて退避）
docker volume rm eapaka-radius-server-poc_valkey_data

# 3. ボリューム再作成
docker volume create eapaka-radius-server-poc_valkey_data

# 4. バックアップからリストア
docker run --rm -v eapaka-radius-server-poc_valkey_data:/data -v ~/backups/valkey:/backup alpine \
  sh -c 'cd /data && tar xzf /backup/backup_YYYYMMDD_HHMMSS.tar.gz --strip-components=1'

# 5. コンテナ起動
docker compose start valkey

# 6. データ確認
docker compose exec valkey valkey-cli -a ${VALKEY_PASSWORD} dbsize
```

#### バックアップスクリプト内容

**ファイルパス:** `~/scripts/backup_valkey.sh`

```bash
#!/bin/bash
set -e

BACKUP_DIR="${HOME}/backups/valkey"
RETENTION_DAYS=7
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# バックアップディレクトリ作成
mkdir -p "${BACKUP_DIR}"

# バックアップ実行
cd ~/eapaka-radius-server-poc/deployments
docker compose exec -T valkey sh -c 'tar czf - /data' > "${BACKUP_DIR}/backup_${TIMESTAMP}.tar.gz"

# 古いバックアップの削除
find "${BACKUP_DIR}" -name "backup_*.tar.gz" -mtime +${RETENTION_DAYS} -delete

echo "Backup completed: backup_${TIMESTAMP}.tar.gz"
```

> **注記:** スクリプトの初回配置およびcrontab設定はデプロイ手順書（B-02）を参照。

---

## 3. Fluent Bit設定

### 3.1 設定概要

| 項目 | 設定値 | 備考 |
|------|-------|------|
| 入力 | Fluentdプロトコル（forward） | Docker log driver経由 |
| 出力 | ファイル（アプリ別分割） | `/output_logs/{app}.log` |
| ローテーション | 日次 | logrotate連携 |
| 保持期間 | 30日 | |
| バッファ | メモリ 5MB | `Mem_Buf_Limit` |

### 3.1.1 Fluent Bitイメージ方針

**統一イメージ:** `fluent/fluent-bit:4.2`

| 項目           | 内容                                                  |
| -------------- | ----------------------------------------------------- |
| 採用理由       | AWS固有機能は不要、公式イメージで十分                 |
| 非採用         | `amazon/aws-for-fluent-bit`（AWS CloudWatch連携不要） |
| バージョン固定 | `4.2` を明示（latest回避）                            |
| ベースイメージ | Distrolessベース（v4.x系のデフォルト）                |

> **注記:** D-01のdocker-compose.ymlも同一イメージを使用すること。

> **注記:** Fluent Bit v4.x系のデフォルトイメージはDistrolessベースのため、`docker exec` でシェルに入ることができない。デバッグ時は `-debug` タグ付きイメージ（`fluent/fluent-bit:4.2-debug`）を使用すること。

### 3.2 設定ファイル

**ファイルパス:** `configs/fluent-bit/fluent-bit.yaml`

Fluent Bit v4.x系ではYAML形式の設定ファイルを使用する。Classic config形式（`.conf`）は2026年末に廃止予定のため、YAML形式に移行済み。パーサー設定もYAMLファイル内に統合されている。

```yaml
service:
  flush: 1
  daemon: false
  log_level: info

parsers:
  - name: json
    format: json
    time_key: false

pipeline:
  inputs:
    - name: forward
      listen: 0.0.0.0
      port: 24224
      mem_buf_limit: 5MB

  filters:
    - name: parser
      match: "app.*"
      key_name: log
      parser: json
      reserve_data: false

  outputs:
    - name: file
      match: app.auth-server
      path: /output_logs
      file: auth-server.log
      format: plain

    - name: file
      match: app.acct-server
      path: /output_logs
      file: acct-server.log
      format: plain

    - name: file
      match: app.vector-gateway
      path: /output_logs
      file: vector-gateway.log
      format: plain

    - name: file
      match: app.vector-api
      path: /output_logs
      file: vector-api.log
      format: plain

    - name: file
      match: app.valkey
      path: /output_logs
      file: valkey.log
      format: plain

    - name: file
      match: "*"
      path: /output_logs
      file: others.log
      format: plain
```

### 3.3 パーサー設定

パーサー設定は `fluent-bit.yaml` の `parsers` セクションに統合されている（§3.2を参照）。従来の個別ファイル（`parsers.conf`）は廃止済み。

`time_key: false` を指定し、Fluent Bitによるタイムスタンプ解析を無効化している。アプリケーション側のJSON出力に含まれるタイムスタンプをそのまま保持する。

### 3.4 ログローテーション設定

**ファイルパス:** `/etc/logrotate.d/eapaka-radius-server-poc`

```
/home/admin/eapaka-radius-server-poc/deployments/logs_on_host/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    dateext
    dateformat -%Y%m%d
}
```

> **注記:** logrotate設定ファイルの初回配置はデプロイ手順書（B-02）を参照。

### 3.5 ログファイル一覧

| ファイル | 内容 | 想定サイズ/日 |
|---------|------|--------------|
| `auth-server.log` | 認証サーバーログ | 〜10MB |
| `acct-server.log` | 課金サーバーログ | 〜5MB |
| `vector-gateway.log` | ゲートウェイログ | 〜5MB |
| `vector-api.log` | ベクターAPIログ | 〜5MB |
| `valkey.log` | Valkeyログ | 〜1MB |
| `others.log` | その他 | 〜1MB |

---

## 4. Docker Compose設定

### 4.1 完全なdocker-compose.yml

**ファイルパス:** `deployments/docker-compose.yml`

```yaml
version: '3.8'

x-logging: &fluent-bit-logging
  driver: fluentd
  options:
    fluentd-address: localhost:24224
    fluentd-async: "true"
    fluentd-buffer-limit: "1048576"

x-timezone: &timezone
  TZ: Asia/Tokyo

services:
  # ==========================================================================
  # Logic Layer
  # ==========================================================================
  auth-server:
    build: ../apps/auth-server
    ports:
      - "1812:1812/udp"
    environment:
      <<: *timezone
      REDIS_HOST: valkey
      REDIS_PORT: "6379"
      REDIS_PASS: ${VALKEY_PASSWORD}
      VECTOR_API_URL: http://vector-gateway:8080/api/v1/vector
      RADIUS_SECRET: ${RADIUS_SECRET}
      LOG_MASK_IMSI: ${LOG_MASK_IMSI:-true}
    depends_on:
      valkey:
        condition: service_healthy
      vector-gateway:
        condition: service_started
    healthcheck:
      test: ["CMD", "pgrep", "-x", "auth-server"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: always
    logging:
      <<: *fluent-bit-logging
      options:
        fluentd-address: localhost:24224
        fluentd-async: "true"
        fluentd-buffer-limit: "1048576"
        tag: "app.auth-server"

  acct-server:
    build: ../apps/acct-server
    ports:
      - "1813:1813/udp"
    environment:
      <<: *timezone
      REDIS_HOST: valkey
      REDIS_PORT: "6379"
      REDIS_PASS: ${VALKEY_PASSWORD}
      RADIUS_SECRET: ${RADIUS_SECRET}
      LOG_MASK_IMSI: ${LOG_MASK_IMSI:-true}
    depends_on:
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-x", "acct-server"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: always
    logging:
      <<: *fluent-bit-logging
      options:
        fluentd-address: localhost:24224
        fluentd-async: "true"
        fluentd-buffer-limit: "1048576"
        tag: "app.acct-server"

  vector-gateway:
    build: ../apps/vector-gateway
    expose:
      - "8080"
    environment:
      <<: *timezone
      VECTOR_GATEWAY_MODE: ${VECTOR_GATEWAY_MODE:-gateway}
      VECTOR_GATEWAY_INTERNAL_URL: http://vector-api:8080/api/v1/vector
      VECTOR_GATEWAY_PLMN_MAP: ${VECTOR_GATEWAY_PLMN_MAP:-}
      VECTOR_GATEWAY_INTERNAL_TIMEOUT: ${VECTOR_GATEWAY_INTERNAL_TIMEOUT:-5s}
      LOG_MASK_IMSI: ${LOG_MASK_IMSI:-true}
    depends_on:
      vector-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: always
    logging:
      <<: *fluent-bit-logging
      options:
        fluentd-address: localhost:24224
        fluentd-async: "true"
        fluentd-buffer-limit: "1048576"
        tag: "app.vector-gateway"

  vector-api:
    build: ../apps/vector-api
    expose:
      - "8080"
    environment:
      <<: *timezone
      REDIS_HOST: valkey
      REDIS_PORT: "6379"
      REDIS_PASS: ${VALKEY_PASSWORD}
      LOG_MASK_IMSI: ${LOG_MASK_IMSI:-true}
    depends_on:
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: always
    logging:
      <<: *fluent-bit-logging
      options:
        fluentd-address: localhost:24224
        fluentd-async: "true"
        fluentd-buffer-limit: "1048576"
        tag: "app.vector-api"

  # ==========================================================================
  # Data Layer
  # ==========================================================================
  valkey:
    image: valkey/valkey:9.0
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - valkey_data:/data
    command: >
      valkey-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy noeviction
      --requirepass ${VALKEY_PASSWORD}
    environment:
      <<: *timezone
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "${VALKEY_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: always
    logging:
      <<: *fluent-bit-logging
      options:
        fluentd-address: localhost:24224
        fluentd-async: "true"
        fluentd-buffer-limit: "1048576"
        tag: "app.valkey"

  # ==========================================================================
  # Logging Layer
  # ==========================================================================
  fluent-bit:
    image: fluent/fluent-bit:4.2
    command: ["/fluent-bit/bin/fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.yaml"]
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    volumes:
      - ../configs/fluent-bit/fluent-bit.yaml:/fluent-bit/etc/fluent-bit.yaml:ro
      - ./logs_on_host:/output_logs
    environment:
      <<: *timezone
    restart: always

volumes:
  valkey_data:
```

> **注記:** Fluent Bit 4.x系のデフォルトコマンドは `-c /fluent-bit/etc/fluent-bit.conf`（Classic config）を指定しているため、YAML設定ファイルを使用する場合は `command` で明示的に `-c /fluent-bit/etc/fluent-bit.yaml` を指定する必要がある。

### 4.2 環境変数ファイル

**ファイルパス:** `deployments/.env.example`

```bash
# =============================================================================
# EAP-AKA RADIUS PoC 環境変数設定
# =============================================================================
# 本ファイルを .env にコピーして値を設定してください。
# cp .env.example .env
# =============================================================================

# -----------------------------------------------------------------------------
# 認証情報（必須）
# -----------------------------------------------------------------------------
# Valkey (Redis) 接続パスワード
VALKEY_PASSWORD=your_secure_password_here

# RADIUSデフォルト共有シークレット（フォールバック用）
RADIUS_SECRET=your_radius_secret_here

# -----------------------------------------------------------------------------
# Vector Gateway設定（オプション）
# -----------------------------------------------------------------------------
# 動作モード: gateway（デフォルト）または passthrough
# VECTOR_GATEWAY_MODE=gateway

# PLMNマッピング（カンマ区切り）
# 形式: "PLMN:ID,PLMN:ID,..."
# 例: VECTOR_GATEWAY_PLMN_MAP="44010:01,44020:01"
# VECTOR_GATEWAY_PLMN_MAP=

# 内部API呼び出しタイムアウト
# VECTOR_GATEWAY_INTERNAL_TIMEOUT=5s

# -----------------------------------------------------------------------------
# ログ設定（オプション）
# -----------------------------------------------------------------------------
# IMSIマスキング有効化（デフォルト: true）
# - true : IMSI中央部分をマスク（440101********0）- 本番環境推奨
# - false: IMSI全桁表示（440101234567890）- デバッグ用
#
# 対象コンポーネント（4つのみ）:
#   - auth-server
#   - acct-server
#   - vector-gateway
#   - vector-api
#
# 注記: Admin TUIは対象外（常にIMSI全桁を表示/記録）
#       管理操作・監査証跡でIMSIを確実に識別できる運用を優先するため
#
# 注意: false設定はログファイルへのアクセス制御が適切に行われている
#       環境でのみ使用すること。調査完了後は速やかにtrueに戻すこと。
# LOG_MASK_IMSI=true

# -----------------------------------------------------------------------------
# テストベクターモード設定（開発・テスト環境専用）
# -----------------------------------------------------------------------------
# ※ 本番環境では以下の環境変数を設定しない、または明示的に false を指定すること
#
# テストベクターモードが有効な場合:
#   - 特定のIMSIプレフィックスに対して固定の認証ベクター（3GPP TS 35.208）を返却
#   - Valkey上の加入者データを参照せずにテストが可能
#   - セキュリティリスクがあるため、本番環境では絶対に有効にしないこと
#
# TEST_VECTOR_ENABLED=false
# TEST_VECTOR_IMSI_PREFIX=00101
```

> **警告:** `TEST_VECTOR_ENABLED=true` は**開発・テスト環境専用**の設定です。本番環境でこの設定を有効にすると、固定の認証ベクターが返却され、**重大なセキュリティリスク**となります。

> **注記:** `.env` ファイルの作成手順はデプロイ手順書（B-02）を参照。

### 4.3 ヘルスチェック設定

#### 4.3.1 ヘルスチェック方針

**HTTPエンドポイント用コマンド:** `curl -fsS http://localhost:8080/health`

| 項目 | 内容 |
|------|------|
| 採用コマンド | `curl -fsS` |
| 非採用 | `wget -q --spider`（4xx/5xxを失敗扱いにできない場合がある） |
| 理由 | `curl -fsS` はHTTP 4xx/5xxを失敗扱いにでき、より安定したヘルスチェックが可能 |

**ベースイメージ要件:**
- ランタイムベースイメージ: `debian:bookworm-slim`
- 共通必須パッケージ: `curl`, `ca-certificates`
- UDPサービス追加必須: `procps`（`pgrep`コマンド用、auth-server/acct-serverのみ）

> **注記:** すべてのGoアプリケーション（auth-server, acct-server, vector-gateway, vector-api）のDockerfileは、ランタイムステージで `debian:bookworm-slim` をベースとし、`curl` と `ca-certificates` を導入すること。

> **UDPサービスの追加要件:** auth-server および acct-server は `pgrep` によるヘルスチェックを行うため、`procps` パッケージも必須となる。

#### 4.3.2 サービス別設定

| サービス | チェック方法 | 間隔 | タイムアウト | リトライ |
|---------|-------------|------|------------|---------|
| auth-server | プロセス存在確認 (`pgrep`) | 30秒 | 5秒 | 3回 |
| acct-server | プロセス存在確認 (`pgrep`) | 30秒 | 5秒 | 3回 |
| vector-gateway | `curl -fsS http://localhost:8080/health` | 30秒 | 5秒 | 3回 |
| vector-api | `curl -fsS http://localhost:8080/health` | 30秒 | 5秒 | 3回 |
| valkey | `valkey-cli ping` | 10秒 | 3秒 | 3回 |

**UDPサービスのヘルスチェックについて：**

auth-server、acct-serverはUDPプロトコルを使用するため、TCP接続確認やHTTPエンドポイント確認ができない。PoC段階ではプロセス存在確認（`pgrep`）を採用し、アプリケーション内部状態の確認はログ監視で補完する。

**`pgrep`コマンドの依存パッケージ:**

| コマンド | 提供パッケージ | 対象サービス |
|---------|---------------|-------------|
| `pgrep` | `procps` | auth-server, acct-server |

> **重要:** `pgrep` コマンドは `procps` パッケージに含まれる。Dockerfileのランタイムステージで `procps` を導入しないと、ヘルスチェックが常時失敗（unhealthy）となる。

### 4.4 サービス依存関係

```
fluent-bit (独立起動)
    ↑
valkey ────────────────────┐
    ↑                      │
vector-api                 │
    ↑                      │
vector-gateway             │
    ↑                      │
auth-server ───────────────┤
                           │
acct-server ───────────────┘
```

---

## 5. ホストOS設定

本セクションでは設定内容と確認方法を記載する。初期設定手順はデプロイ手順書（B-02）を参照。

### 5.1 設定一覧

| 項目 | 設定内容 | 確認コマンド |
|------|---------|-------------|
| タイムゾーン | `Asia/Tokyo` (JST) | `timedatectl status` |
| NTP同期 | `systemd-timesyncd` 有効 | `timedatectl show-timesync` |
| UFW | 10022/tcp, 1812/udp, 1813/udp許可 | `sudo ufw status` |
| SSH | Port 10022、公開鍵認証のみ | `sudo sshd -T \| grep -E 'port\|passwordauth'` |
| Docker | 自動起動有効 | `systemctl is-enabled docker` |
| アプリ自動起動 | systemdサービス登録 | `systemctl is-enabled eapaka-radius-server-poc` |

### 5.2 タイムゾーン設定

**設定内容:** `Asia/Tokyo` (JST, +0900)

**確認方法:**

```bash
timedatectl status

# 期待される出力:
#                Local time: Mon 2026-01-06 21:00:00 JST
#            Universal time: Mon 2026-01-06 12:00:00 UTC
#                  RTC time: Mon 2026-01-06 12:00:00
#                 Time zone: Asia/Tokyo (JST, +0900)
# System clock synchronized: yes
#               NTP service: active
```

### 5.3 NTP同期設定

**設定内容:** `systemd-timesyncd` によるNTP同期

**確認方法:**

```bash
# NTPサービス状態確認
systemctl status systemd-timesyncd

# 同期状態詳細確認
timedatectl show-timesync --all

# 期待される出力（抜粋）:
# NTPSynchronized=yes
# ServerName=ntp.ubuntu.com
```

**オプション設定（NTPサーバー変更時）:**

```
# /etc/systemd/timesyncd.conf
[Time]
NTP=ntp.nict.jp
FallbackNTP=ntp.ubuntu.com
```

### 5.4 UFW設定

**設定内容:**

| ルール | 用途 |
|-------|------|
| DENY (incoming) | デフォルトポリシー |
| ALLOW (outgoing) | デフォルトポリシー |
| 10022/tcp ALLOW | SSH（カスタムポート） |
| 1812/udp ALLOW | RADIUS認証 |
| 1813/udp ALLOW | RADIUS課金 |

**確認方法:**

```bash
sudo ufw status verbose

# 期待される出力:
# Status: active
# Logging: on (low)
# Default: deny (incoming), allow (outgoing), disabled (routed)
#
# To                         Action      From
# --                         ------      ----
# 10022/tcp                  ALLOW IN    Anywhere
# 1812/udp                   ALLOW IN    Anywhere
# 1813/udp                   ALLOW IN    Anywhere
```

### 5.5 SSH設定

**設定内容:**

| 項目 | 設定値 |
|------|-------|
| Port | 10022 |
| PermitRootLogin | no |
| PasswordAuthentication | no |
| PubkeyAuthentication | yes |

**確認方法:**

```bash
sudo sshd -T | grep -E '^(port|permitrootlogin|passwordauthentication|pubkeyauthentication)'

# 期待される出力:
# port 10022
# permitrootlogin no
# passwordauthentication no
# pubkeyauthentication yes
```

### 5.6 Docker設定

**設定内容:**

| 項目 | 設定 |
|------|------|
| Dockerサービス | 自動起動有効 |
| eapaka-radius-server-pocサービス | systemd登録、自動起動有効 |

**確認方法:**

```bash
# Docker自動起動確認
systemctl is-enabled docker
# 期待される出力: enabled

# アプリケーション自動起動確認
systemctl is-enabled eapaka-radius-server-poc
# 期待される出力: enabled
```

**systemdサービスファイル:**

`/etc/systemd/system/eapaka-radius-server-poc.service`

```ini
[Unit]
Description=EAP-AKA RADIUS PoC
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/admin/eapaka-radius-server-poc/deployments
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
User=admin
Group=docker

[Install]
WantedBy=multi-user.target
```

---

## 6. 運用手順

### 6.1 起動・停止手順

#### 通常起動

```bash
cd ~/eapaka-radius-server-poc/deployments

# 全サービス起動
docker compose up -d

# 起動確認
docker compose ps
```

#### 通常停止

```bash
cd ~/eapaka-radius-server-poc/deployments

# 全サービス停止
docker compose down
```

#### 再起動

```bash
cd ~/eapaka-radius-server-poc/deployments

# 特定サービスのみ再起動
docker compose restart auth-server

# 全サービス再起動
docker compose restart
```

#### systemd経由での操作

```bash
# 起動
sudo systemctl start eapaka-radius-server-poc

# 停止
sudo systemctl stop eapaka-radius-server-poc

# 状態確認
sudo systemctl status eapaka-radius-server-poc
```

### 6.2 状態確認手順

#### コンテナ状態確認

```bash
# 全コンテナの状態一覧
docker compose ps

# 期待される出力（正常時）
# NAME                STATUS              PORTS
# auth-server         Up (healthy)        0.0.0.0:1812->1812/udp
# acct-server         Up (healthy)        0.0.0.0:1813->1813/udp
# vector-gateway      Up (healthy)        8080/tcp
# vector-api          Up (healthy)        8080/tcp
# valkey              Up (healthy)        127.0.0.1:6379->6379/tcp
# fluent-bit          Up                  0.0.0.0:24224->24224/tcp,udp
```

#### ヘルスチェック詳細確認

```bash
# 個別コンテナのヘルスチェック詳細
docker inspect --format='{{json .State.Health}}' auth-server | jq

# 全コンテナのヘルス状態サマリ
docker compose ps --format "table {{.Name}}\t{{.Status}}"
```

#### リソース使用状況確認

```bash
# コンテナごとのCPU/メモリ使用状況
docker stats --no-stream

# 期待される出力例
# CONTAINER ID   NAME             CPU %   MEM USAGE / LIMIT   MEM %   NET I/O       BLOCK I/O
# abc123         auth-server      0.50%   45MiB / 8GiB        0.55%   1.2MB/800KB   0B/0B
# def456         acct-server      0.30%   35MiB / 8GiB        0.43%   500KB/300KB   0B/0B
# ...
```

#### Valkey接続確認

```bash
# Valkey CLIで接続確認
docker compose exec valkey valkey-cli -a ${VALKEY_PASSWORD} ping
# 期待される出力: PONG

# データ件数確認
docker compose exec valkey valkey-cli -a ${VALKEY_PASSWORD} dbsize
# 期待される出力: (integer) 123

# メモリ使用状況
docker compose exec valkey valkey-cli -a ${VALKEY_PASSWORD} info memory | grep used_memory_human
# 期待される出力: used_memory_human:15.23M
```

#### ディスク使用状況確認

```bash
# ホスト全体のディスク使用状況
df -h

# Dockerボリューム使用状況
docker system df -v

# ログファイルサイズ確認
du -sh ~/eapaka-radius-server-poc/deployments/logs_on_host/*
```

#### ネットワーク疎通確認

```bash
# UFW状態確認
sudo ufw status

# ポート開放確認（外部から）
nc -u -v <ミニPC IP> 1812
nc -u -v <ミニPC IP> 1813
```

### 6.3 ログ確認手順

#### リアルタイムログ確認

```bash
# 特定サービスのログをリアルタイム表示
docker compose logs -f auth-server

# 全サービスのログをリアルタイム表示
docker compose logs -f

# 直近100行を表示
docker compose logs --tail 100 auth-server
```

#### ログファイル直接確認

```bash
# ログディレクトリへ移動
cd ~/eapaka-radius-server-poc/deployments/logs_on_host

# 最新ログ確認
tail -f auth-server.log

# 特定event_idの検索
grep "AUTH_OK" auth-server.log

# jqによるJSON解析
cat auth-server.log | jq 'select(.event_id == "AUTH_OK")'
```

#### lnavによる高度なログ解析

```bash
# lnavでログファイルを開く
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log

# lnav内操作
# /  : 検索
# :  : コマンド入力
# ;  : SQLクエリ
# q  : 終了
```

**lnav SQLクエリ例：**

```sql
-- 認証成功件数（時間別）
;SELECT strftime('%Y-%m-%d %H:00', log_time) as hour, count(*) as count 
 FROM logline 
 WHERE event_id = 'AUTH_OK' 
 GROUP BY hour

-- エラー一覧
;SELECT log_time, event_id, msg 
 FROM logline 
 WHERE log_level = 'ERROR' 
 ORDER BY log_time DESC 
 LIMIT 20
```

### 6.4 トラブルシューティング

#### コンテナが起動しない場合

```bash
# 詳細ログ確認
docker compose logs --tail 50 <サービス名>

# コンテナ内部の確認
docker compose exec <サービス名> sh

# イメージ再ビルド
docker compose build --no-cache <サービス名>
docker compose up -d <サービス名>
```

#### Valkey接続エラーの場合

```bash
# Valkeyコンテナ状態確認
docker compose ps valkey
docker compose logs valkey

# パスワード確認
echo $VALKEY_PASSWORD

# 手動接続テスト
docker compose exec valkey valkey-cli -a <password> ping
```

#### ログが出力されない場合

```bash
# Fluent Bit状態確認
docker compose ps fluent-bit
docker compose logs fluent-bit

# ログディレクトリ権限確認
ls -la ~/eapaka-radius-server-poc/deployments/logs_on_host/

# Fluent Bit設定確認（ホスト側から直接確認）
cat ~/eapaka-radius-server-poc/configs/fluent-bit/fluent-bit.yaml
```

> **注記:** Fluent Bit v4.x系のデフォルトイメージはDistrolessベースのため、`docker compose exec fluent-bit cat ...` や `docker compose exec fluent-bit sh` は使用できない。設定ファイルの確認はホスト側のマウント元ファイルを直接参照すること。デバッグ目的でコンテナ内部に入る必要がある場合は、`docker-compose.yml` のイメージタグを一時的に `fluent/fluent-bit:4.2-debug` に変更して再起動する。

#### ディスク容量不足の場合

```bash
# Docker不要リソース削除
docker system prune -af

# 古いログファイル削除（手動）
find ~/eapaka-radius-server-poc/deployments/logs_on_host -name "*.log-*" -mtime +30 -delete

# Dockerボリューム確認
docker volume ls
docker volume prune
```

---

## 7. ディレクトリ構成

運用時のホストOS上のディレクトリ構成。

```
/home/admin/
├── eapaka-radius-server-poc/                    # リポジトリクローン先
│   ├── apps/
│   │   ├── auth-server/
│   │   ├── acct-server/
│   │   ├── vector-gateway/
│   │   ├── vector-api/
│   │   └── admin-tui/
│   ├── configs/
│   │   └── fluent-bit/
│   │       └── fluent-bit.yaml
│   ├── deployments/
│   │   ├── docker-compose.yml
│   │   ├── .env                    # 環境変数（.gitignore対象）
│   │   ├── .env.example
│   │   ├── logs_on_host/           # ログ出力先
│   │   │   ├── auth-server.log
│   │   │   ├── acct-server.log
│   │   │   ├── vector-gateway.log
│   │   │   ├── vector-api.log
│   │   │   └── valkey.log
│   │   └── lnav_formats/
│   │       └── eap_aka_log.json
│   └── docs/
├── admin-tui                       # TUIバイナリ（デプロイ手順書参照）
├── scripts/
│   └── backup_valkey.sh
├── backups/
│   └── valkey/
│       └── backup_YYYYMMDD_HHMMSS.tar.gz
└── logs/
    └── backup.log
```

> **注記:** Admin TUIバイナリの配置手順はデプロイ手順書（B-02）を参照。

---

## 8. セキュリティチェックリスト

運用開始前および定期的に確認すべき項目。

| カテゴリ | 確認項目 | 確認コマンド | 状態 |
|---------|---------|-------------|------|
| **認証情報** | `.env` ファイルのパーミッションが600 | `ls -la .env` | □ |
| | VALKEY_PASSWORDが十分に複雑 | - | □ |
| | RADIUS_SECRETが十分に複雑 | - | □ |
| **ネットワーク** | UFWが有効化されている | `sudo ufw status` | □ |
| | 不要なポートが閉じている | `sudo ufw status` | □ |
| | Valkeyが127.0.0.1のみにバインド | `docker compose ps valkey` | □ |
| **SSH** | パスワード認証が無効化されている | `sudo sshd -T \| grep passwordauth` | □ |
| | rootログインが無効化されている | `sudo sshd -T \| grep permitrootlogin` | □ |
| | SSHポートが変更されている | `sudo sshd -T \| grep port` | □ |
| **ログ** | 機密情報がログに出力されていない | ログ目視確認 | □ |
| | ログローテーションが設定されている | `cat /etc/logrotate.d/eapaka-radius-server-poc` | □ |

---

## 9. 未決事項・将来検討

| No. | 項目 | 内容 | 判断時期 |
|-----|------|------|---------|
| 1 | TLS/HTTPS対応 | Vector Gateway/APIへのHTTPS化 | PoC完了後 |
| 2 | メトリクス収集 | Prometheus/Grafana導入 | PoC完了後 |
| 3 | アラート通知 | 障害時のSlack/メール通知 | PoC完了後 |
| 4 | コンテナ非rootユーザー化 | セキュリティ強化 | PoC完了後 |
| 5 | ログ集約基盤 | 外部ログサーバーへの転送 | PoC完了後 |
| 6 | 自動復旧スクリプト | 異常検知時の自動再起動 | PoC完了後 |
| 7 | HTTPヘルスエンドポイント | UDPサービスへのHTTPヘルスチェック追加 | PoC完了後 |

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-01-06 | 初版作成 |
| r2 | 2026-01-18 | IMSIマスキング環境変数追加: セクション4.1のdocker-compose.ymlにauth-server/vector-gateway/vector-apiのLOG_MASK_IMSI追加、セクション4.2の.env.exampleにログ設定セクション新設、関連ドキュメント参照バージョン更新 |
| r3 | 2026-01-20 | IMSIマスキング対象にAcct Server追加: セクション4.1のdocker-compose.ymlにacct-serverのLOG_MASK_IMSI追加 |
| r4 | 2026-01-25 | Valkeyのバージョン変更: セクション2.2とセクション4.1のValkey記載バージョンを 7.2 から 9.0 に変更 |
| r5 | 2026-01-26 | インフラ基盤統一: セクション3.1.1新設（Fluent Bitイメージ方針）、セクション4.3をサブセクション化してヘルスチェック方針追加（curl -fsSに統一、ベースイメージ要件追加）、docker-compose.ymlのヘルスチェックコマンドをwgetからcurlに変更、RADIUS_SECRET_KEY→RADIUS_SECRETに統一（.env.example、docker-compose.yml、セキュリティチェックリスト） |
| r6 | 2026-01-27 | IMSIマスキング適用範囲明確化: セクション4.2の.env.exampleコメントを更新（Admin TUI除外を明記、対象4コンポーネントを列挙） |
| r7 | 2026-01-27 | テストベクターモード環境変数追加: セクション4.2の.env.exampleにTEST_VECTOR_ENABLED/TEST_VECTOR_IMSI_PREFIXを追加（本番無効化の警告付き）、関連ドキュメント参照バージョン更新 |
| r8 | 2026-01-27 | ヘルスチェック整合性修正: セクション4.3.1ベースイメージ要件に`procps`追加（auth-server/acct-server用）、セクション4.3.2にpgrep依存パッケージの補足追加 |
| r9 | 2026-02-07 | セクション1.2「B-02で扱う範囲」修正: ホストOS初期設定手順を削除（B-01で手順化済み）、B-01/B-02の境界に合わせてリポジトリクローン・docker compose起動・logrotate・lnavフォーマット配置を追加 |
| r10 | 2026-02-18 | 関連ドキュメント版数更新 |
| r11 | 2026-02-23 | §3.2 Fluent Bit設定修正（rewrite_tagフィルター廃止→parserフィルター＋タグベースルーティングに変更、Format plain→json_lines）、§4.1 docker-compose.yml修正（各サービスに個別loggingタグ設定） |
| r12 | 2026-02-23 | Fluent Bit 3.0→4.2アップグレード＋YAML移行: §3.1.1イメージ方針を4.2に変更（Distroless注記追加）、§3.2設定ファイルをClassic config→YAML形式に全面書き換え、§3.3パーサー設定をYAML統合に更新、§4.1 docker-compose.ymlのfluent-bitサービス定義を更新（イメージタグ・ボリュームマウント）、§6.4トラブルシューティングのFluent Bit設定確認パスを更新（Distroless対応注記追加）、§7ディレクトリ構成をfluent-bit.yamlに変更 |
