# T-03 結合テスト仕様書 (r4)

**版数:** r4
**作成日:** 2026-02-07
**改版日:** 2026-02-21
**依存:** T-01 テスト戦略書 (r2)

---

## 1. 概要

### 1.1 目的

本仕様書は、EAP-AKA RADIUS PoC環境の結合テスト（Integration Test）の試験項目・実行手順・合格基準を定義する。コンポーネント間連携の正常動作、異常時の縮退動作、データ整合性を検証する。

### 1.2 スコープ

| 範囲内 | 範囲外 |
|:------|:------|
| コンポーネント間連携テスト | E2Eテスト（実SIM・本番相当環境） |
| Docker Compose環境での動作検証 | 単体テスト（各パッケージ内テスト） |
| テストベクターモードでの認証検証 | Admin TUI手動テスト |
| Valkeyデータ整合性検証 | 性能テスト |

### 1.3 参照ドキュメント

| ドキュメント | 参照内容 |
|:------------|:--------|
| T-01 テスト戦略書 (r2) | テスト方針、品質ゲート、必須シナリオ定義 |
| D-02 Valkeyデータ設計仕様書 (r9) | データ構造、TTL、キー形式 |
| D-06 エラーハンドリング詳細設計書 (r5) | 異常系パターン、event_id定義 |
| D-08 インフラ設定・運用設計書 (r9) | Docker Compose構成、環境変数 |
| D-09 Auth Server詳細設計書 (r8) | 認証処理、セッション管理 |
| D-10 Acct Server詳細設計書 (r4) | 課金処理、重複検出 |

### 1.4 シナリオID体系

T-Scenariosベースの命名規則を正式IDとして採用する。

| プレフィックス | カテゴリ | 由来 |
|:-------------|:--------|:-----|
| `INT-AUTH-STATUS-` | Auth Server Status-Server | T-Scenarios |
| `INT-AUTH-IDENTITY-` | Auth Server Identity応答 | T-Scenarios |
| `INT-AUTH-AKA-` | EAP-AKA/AKA' 認証 | T-Scenarios |
| `INT-003-` | SQN再同期 | subdocs (T-01 INT-003対応) |
| `INT-ACCT-` | Accounting処理 | T-Scenarios |
| `INT-GW-PLMN-` | PLMNルーティング | T-Scenarios |
| `INT-POLICY-` | ポリシー評価 | subdocs |
| `INT-FAULT-` | 障害系 | subdocs |
| `INT-FLOW-` | 一連フロー | subdocs |
| `INT-006-` | X-Trace-ID伝搬 | subdocs (T-01 INT-006対応) |
| `INT-TIMEOUT-` | EAPコンテキストTTL | subdocs |
| `INT-VALKEY-` | データ整合性 | subdocs |

### 1.5 T-01必須シナリオとのマッピング

T-01テスト戦略書で定義された必須6シナリオと本仕様書のシナリオIDの対応:

| T-01 ID | T-01シナリオ名 | 本仕様書での対応シナリオ |
|:--------|:-------------|:---------------------|
| INT-001 | EAP-AKA正常認証 | INT-AUTH-AKA-001 |
| INT-002 | EAP-AKA'正常認証 | INT-AUTH-AKA-002 |
| INT-003 | 再同期フロー | INT-003-01, INT-003-02 |
| INT-004 | 認証失敗（XRES不一致） | INT-AUTH-AKA-005 |
| INT-005 | Accountingフロー | INT-ACCT-START-011 〜 INT-ACCT-STOP-013, INT-FLOW-001 |
| INT-006 | Vector Gateway経由 | INT-006-01 〜 INT-006-03 |

---

## 2. テスト環境

### 2.1 Docker Compose構成

> 詳細は D-08 インフラ設定・運用設計書 (r8) および `deployments/docker-compose.yml` を参照。

```
auth-server  (UDP 1812) ──→ vector-gateway ──→ vector-api ──→ valkey
    │                                                           ↑
    └───────────────────────────────────────────────────────────┘
acct-server  (UDP 1813) ──→ valkey
fluent-bit   (TCP/UDP 24224) ← 全サービスからログ収集
```

### 2.2 環境変数

テスト実行に必要な主要環境変数（`deployments/.env` で設定）:

| 変数 | テスト時の値 | 説明 |
|:----|:-----------|:----|
| `TEST_VECTOR_ENABLED` | `true` | テストベクターモード有効化 |
| `TEST_VECTOR_IMSI_PREFIX` | `00101` | テストベクター対象IMSIプレフィックス |
| `LOG_MASK_IMSI` | `false` | IMSI全桁表示（テスト時） |
| `RADIUS_SECRET` | `testing123` | RADIUS共有秘密（フォールバック用） |

> **Secret体系**: Valkeyにクライアント登録されたIPからのリクエストは登録Secret（`TESTSECRET123`等）を使用する。未登録IPの場合のみ `RADIUS_SECRET` 環境変数にフォールバックする。テスト時はDockerゲートウェイIP `172.19.0.1` をValkeyに登録済み（Secret: `TESTSECRET123`）のため、radclient/eapaka_testでは `TESTSECRET123` を使用する。

### 2.3 テストツール

| ツール | 用途 | パス |
|:------|:-----|:----|
| eapaka_test | EAP-AKA/AKA' フル認証テスト | `/home/<username>/devtools/eapaka_test/eapaka_test` |
| radclient | RADIUSパケット個別送信 | システムパス |
| redis-cli | Valkeyデータ直接操作・検証 | Valkeyコンテナ内 |

#### eapaka_test設定ファイル

| 設定ファイル | 対象IMSI | AMF | 用途 |
|:------------|:--------|:----|:-----|
| `config_testvector.yaml` | `001010000000000`（デフォルト） | `B9B9` | 大半のテストシナリオ（EAP-AKA標準） |
| `config_testvector_imsi003.yaml` | `001010000000003` | `8000` | IMSI 003を使用するG4/G5シナリオ |

> **注意（r3）**: IMSI 003（AMF=8000）を使用するテストケースは、デフォルトの`config_testvector.yaml`（AMF=B9B9）ではAMFミスマッチによりeapaka_testが認証中断する。IMSI 003を使用するシナリオ（INT-AUTH-AKA-007、INT-POLICY-003〜005）では必ず`config_testvector_imsi003.yaml`を使用すること。

### 2.4 環境起動・停止

```bash
cd deployments
docker compose up -d
docker compose ps  # 全サービスの起動確認

# テスト完了後
docker compose down
```

---

## 3. テストデータ事前準備

テスト実行前に、以下のデータをValkeyに投入する。

| データ種別 | 投入手順ドキュメント |
|:---------|:------------------|
| 加入者データ（`sub:*`） | [test_subscriber_data_scripts.md](subdocs/test_subscriber_data_scripts.md) |
| RADIUSクライアント（`client:*`） | [test_radius_client_data_scripts.md](subdocs/test_radius_client_data_scripts.md) |
| 認可ポリシー（`policy:*`） | [test_policy_data_scripts.md](subdocs/test_policy_data_scripts.md) |

### 3.1 投入データ概要

#### 加入者データ

| IMSI | 用途 | 備考 |
|:-----|:-----|:-----|
| `001010000000000` | EAP-AKA テストベクター（identity用） | 3GPP TS 35.208 Test Set 1, AMF=B9B9 |
| `001010000000001` | EAP-AKA テストベクター（基本テスト） | 同上 |
| `001010000000002` | ポリシーdeny テスト | 同上 |
| `001010000000003` | NAS/SSIDルール テスト（AMF=8000） | default=deny, Customer01/TESTSSID-01許可 |
| `001010000000006` | ワイルドカードSSID テスト | default=deny, Customer01/SSID=`["*"]` |
| `441999123456789` | PLMNルーティングテスト | PLMN 441999、未実装バックエンド |

> **注意（r2）**: IMSI `001010000000004`/`001010000000005` はポリシーデータのみ登録されており加入者データは未登録。結合テストの対象外。INT-POLICY-007（ポリシー未登録テスト）には、加入者データが登録済みかつポリシーが未登録のIMSI `001010000000007` を使用する（加入者データの事前登録が必要）。

#### RADIUSクライアント

| IP | Secret | Name | 用途 |
|:---|:-------|:-----|:-----|
| `127.0.0.1` | `TESTSECRET123` | Localhost | ローカルテスト用 |
| `192.168.10.1` | `TESTSECRET123` | Customer01 | 正常系テスト |
| `192.168.20.2` | `kamenriderdecade` | Customer02 | 異常系テスト |
| `192.168.1.10` | `test_secret_ap1` | TestAP-01 | 追加テスト用AP |
| `10.0.0.100` | `e2e_secret_nas` | E2E-NAS | E2Eテスト用 |
| `172.19.0.1` | `TESTSECRET123` | DockerGateway | DockerブリッジゲートウェイIP |

### 3.2 投入コマンド

```bash
# Valkeyコンテナ内で投入スクリプトを実行
# 詳細は各投入手順ドキュメントを参照
docker compose exec valkey redis-cli < /path/to/register_script.sh
```

---

## 4. テスト実行グループ

### 4.1 グループ一覧

| Group | 名称 | シナリオ数 | 主要ツール | 依存 | AI自動実行 |
|:-----:|:-----|:---------:|:----------|:-----|:---------:|
| G1 | 事前検証 | 5 | redis-cli, radclient | なし | 可 |
| G2 | 認証正常系 | 7 | eapaka_test, redis-cli | G1 | 可 |
| G3 | SQN再同期 | 3 | eapaka_test | G2 | 可 |
| G4 | 認証異常系 | 4 | eapaka_test | G1 | 可 |
| G5 | ポリシー評価 | 7 | eapaka_test | G1 | 可 |
| G6 | 課金フロー | 6 | radclient, redis-cli | G2 | 可 |
| G7 | 一連フロー + 総合検証 | 3 | eapaka_test, radclient, redis-cli | G1 | 可 |
| G8 | PLMNルーティング | 2 | eapaka_test | G1 | 要確認 |
| G9 | 障害系 + タイムアウト | 8 | eapaka_test, docker compose, redis-cli | G1 | 人間介在 |

### 4.2 実行順序と依存関係

```
G1 (事前検証)
 ├──→ G2 (認証正常系) ──→ G3 (SQN再同期)
 │                    └──→ G6 (課金フロー)
 ├──→ G4 (認証異常系)
 ├──→ G5 (ポリシー評価)
 ├──→ G7 (一連フロー + 総合検証)
 ├──→ G8 (PLMNルーティング)
 └──→ G9 (障害系 + タイムアウト)
```

G4, G5, G7, G8 は G2 と並行実行可能（ただしValkey上のSQN状態が互いに影響する可能性があるため、独立したIMSIを使用すること）。

---

## 5. シナリオ詳細

### 5.1 G1: 事前検証

**目的**: テストデータの投入状態と基盤の応答性を確認する。

| ID | シナリオ名 | ツール | 実行コマンド | PASS条件 |
|:---|:---------|:------|:-----------|:--------|
| INT-VALKEY-001 | マスターデータ形式検証 | redis-cli | 検証スクリプト実行 | 加入者6件・クライアント6件・ポリシー8件の形式・型がD-02準拠 |
| INT-AUTH-STATUS-001 | Auth Server Status-Server (正常) | radclient | `radclient -x $AUTH_ADDR status TESTSECRET123 < status.attrs` | Access-Accept, EAP-Messageなし |
| INT-AUTH-STATUS-002 | Auth Server Status-Server (MA検証失敗) | radclient | 不正Secretで送信 | 無応答（タイムアウト）、`RADIUS_STATUS_AUTH_FAIL` ログ |
| INT-ACCT-STATUS-016 | Acct Server Status-Server | radclient | `radclient -x $ACCT_ADDR status $SECRET < acct_status.attrs` | Accounting-Response |
| INT-AUTH-IDENTITY-003 | Identity応答確認 | radclient | EAP-Response/Identity送信 | Access-Challenge + EAP-Request |

**radclientテンプレート**: [radclient_templates_ja.md](subdocs/radclient_templates_ja.md) を参照。

**INT-VALKEY-001 検証スクリプト**: [T-03_INT-VALKEY_data_integrity_verification.md セクション4](subdocs/T-03_INT-VALKEY_data_integrity_verification.md) を参照。

---

### 5.2 G2: 認証正常系

**目的**: EAP-AKA/AKA' のフル認証フロー、X-Trace-ID伝搬、認証後のValkey状態を検証する。

| ID | シナリオ名 | ツール | テストケース | PASS条件 |
|:---|:---------|:------|:-----------|:--------|
| INT-AUTH-AKA-001 | EAP-AKA 正常認証 | eapaka_test | `success_aka_testvector.yaml` | Access-Accept, MPPE属性あり |
| INT-AUTH-AKA-002 | EAP-AKA' 正常認証 | eapaka_test | `success_aka_prime_testvector.yaml` | Access-Accept, MPPE属性あり |
| INT-AUTH-AKA-003 | Permanent ID要求 | eapaka_test | `perm_id_req_from_pseudonym.yaml` | Access-Accept |
| INT-006-01 | X-Trace-ID (AKA) | ログ検証 | INT-AUTH-AKA-001 実行後のログ確認 | Auth Server/Vector APIで同一trace_id |
| INT-006-02 | X-Trace-ID (AKA') | ログ検証 | INT-AUTH-AKA-002 実行後のログ確認 | 同上 |
| INT-VALKEY-002 | 認証後ステートデータ | redis-cli | INT-AUTH-AKA-001 実行後に検証 | eap:* 削除済み, sess:* 作成済み |
| INT-TIMEOUT-003 | TTLリフレッシュ確認 | redis-cli MONITOR | INT-AUTH-AKA-001 実行中に監視 | EXPIRE eap:{ID} 60 がログに出力 |

#### 実行手順

```bash
# eapaka_testのパス
EAPAKA_TEST="/home/<username>/devtools/eapaka_test"
CONFIG="$EAPAKA_TEST/configs/config_testvector.yaml"
CASES="$EAPAKA_TEST/testdata/cases"

# Step 1: Valkey MONITOR開始（別ターミナル）
docker compose exec valkey redis-cli MONITOR > /tmp/valkey_monitor_g2.log &

# Step 2: EAP-AKA認証
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/success_aka_testvector.yaml

# Step 3: EAP-AKA'認証
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/success_aka_prime_testvector.yaml

# Step 4: Permanent ID要求テスト
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/perm_id_req_from_pseudonym.yaml

# Step 5: X-Trace-ID伝搬確認
docker compose logs auth-server --since=5m | grep trace_id
docker compose logs vector-api --since=5m | grep trace_id

# Step 6: Valkey状態検証
docker compose exec valkey redis-cli KEYS "eap:*"    # 空であること
docker compose exec valkey redis-cli KEYS "sess:*"   # セッション存在

# Step 7: TTLリフレッシュ確認
grep "EXPIRE.*eap:" /tmp/valkey_monitor_g2.log
```

**X-Trace-ID伝搬の詳細手順**: [T-03_INT-006_X-Trace-ID_propagation_scenario.md](subdocs/T-03_INT-006_X-Trace-ID_propagation_scenario.md) を参照。

**Valkey状態検証の詳細スクリプト**: [T-03_INT-VALKEY_data_integrity_verification.md セクション5](subdocs/T-03_INT-VALKEY_data_integrity_verification.md) を参照。

---

### 5.3 G3: SQN再同期

**目的**: SQN不整合時の再同期フロー（AUTS → SQN更新 → 再Challenge → Accept）を検証する。

| ID | シナリオ名 | ツール | テストケース | PASS条件 |
|:---|:---------|:------|:-----------|:--------|
| INT-003-01 | EAP-AKA SQN再同期 | eapaka_test | `resync_aka_testvector.yaml` | Access-Accept |
| INT-003-02 | EAP-AKA' SQN再同期 | eapaka_test | `resync_aka_prime_testvector.yaml` | Access-Accept |
| INT-006-03 | X-Trace-ID (再同期時) | ログ検証 | INT-003-01 実行後のログ確認 | 再同期時もtrace_id伝搬 |

**前提（r2更新）**: Valkey-backed SQN対応により、テストベクターモードでもSQN再同期テストが実行可能。サーバー側SQNをクライアント側より低い値に設定することで、AUTSベースの再同期フローを発生させる。

> **注意（r4追記）: `sqn.reset: true` と Resync 発動条件**
> テストケースの `sqn.reset: true` はクライアント側SQNをリセット（初期値に戻す）するが、これによりクライアントSQN < サーバーSQNとなり、USIM は AUTN 内の SQN を「fresh」と判定する（3GPP TS 33.102）。そのため **Resync は発動せず**、通常の認証フローで成功する。Resync を明示的に発動させるには、サーバー側SQNをクライアント側より小さい値に設定する必要がある（例: サーバーSQN=`000000000001` に対しクライアントが蓄積済みSQN > サーバーSQN）。`sqn.reset: true` を使用したテストケースでは、「SQN不整合を許容した正常認証」が検証されるが、AUTS再同期フロー自体の検証にはならない点に留意すること。

#### 実行手順

```bash
# Step 1: サーバー側SQNを低い値にリセット（再同期フロー発生条件の作成）
docker compose exec valkey redis-cli HSET sub:001010000000000 sqn "000000000001"

# Step 2: EAP-AKA SQN再同期（sqn.reset=true でクライアントSQN=0、サーバーSQN=1で不整合発生）
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/resync_aka_testvector.yaml

# Step 3: EAP-AKA' SQN再同期
docker compose exec valkey redis-cli HSET sub:001010000000000 sqn "000000000001"
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/resync_aka_prime_testvector.yaml

# Step 4: Auth Serverログで再同期イベント確認
docker compose logs auth-server --since=5m | grep -E "EAP_RESYNC|trace_id"

# Step 5: Vector APIログでSQN更新確認
docker compose logs vector-api --since=5m | grep -E "SQN_RESYNC|sqn_old|sqn_new"

# Step 6: Valkey SQN更新確認
docker compose exec valkey redis-cli HGET sub:001010000000000 sqn
```

**詳細手順・ログ検証ポイント**: [T-03_INT-003_SQN_resync_flow_scenario.md](subdocs/T-03_INT-003_SQN_resync_flow_scenario.md) を参照。

---

### 5.4 G4: 認証異常系

**目的**: 認証失敗が発生するケースでの Access-Reject 応答とログ出力を検証する。

| ID | シナリオ名 | ツール | テストケース | PASS条件 |
|:---|:---------|:------|:-----------|:--------|
| INT-AUTH-AKA-004 | EAP方式ミスマッチ拒否 | eapaka_test | `mismatch_strict_fail.yaml` | Access-Reject |
| INT-AUTH-AKA-005 | Ki/OPc不正（XRES不一致） | eapaka_test | 後述 | Access-Reject, `AUTH_RES_MISMATCH` ログ |
| INT-AUTH-AKA-006 | 未登録IMSI | eapaka_test | `reject_imsi_not_found.yaml` | Access-Reject |
| INT-AUTH-AKA-007 | ポリシー違反（SSID/NAS不一致） | eapaka_test | `reject_policy_denied_ssid.yaml` | Access-Reject, `AUTH_POLICY_DENIED` ログ |

#### 実行手順

```bash
# INT-AUTH-AKA-004: 方式ミスマッチ
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/mismatch_strict_fail.yaml

# INT-AUTH-AKA-005: Ki/OPc不正（XRES不一致）
# 注意: テストベクターモードでは固定ベクターを使用するため、
# このシナリオはテストベクター非対象のIMSI（Valkey登録済み、Ki不一致）が必要。
# 代替: reject_imsi_not_found.yaml でIMSI未登録時のRejectを確認可能。
# T-01の INT-004（XRES不一致）は、テストベクターモードでは再現困難なため、
# ユニットテスト（engine_test.go TestHandleSubsequent_RESMismatch）で補完済み。

# INT-AUTH-AKA-006: 未登録IMSI
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/reject_imsi_not_found.yaml

# INT-AUTH-AKA-007: ポリシー違反（IMSI 003専用config使用）
CONFIG_IMSI003="$EAPAKA_TEST/configs/config_testvector_imsi003.yaml"
$EAPAKA_TEST/eapaka_test -c $CONFIG_IMSI003 run $CASES/reject_policy_denied_ssid.yaml

# ログ確認
docker compose logs auth-server --since=5m | grep -E "AUTH_RES_MISMATCH|AUTH_POLICY_DENIED|VECTOR_NOT_FOUND"
```

> **注意 (INT-AUTH-AKA-005)**: テストベクターモードではVector APIが3GPP TS 35.208固定ベクターを返却するため、eapaka_testが同一パラメータで計算するとXRESは常に一致する。XRES不一致の結合テストは、テストベクターモード無効のSIM環境または`engine_test.go`のユニットテストで代替する。

> **注意 (INT-AUTH-AKA-007, r3追記)**: IMSI 003はAMF=8000で登録されているため、デフォルトconfig（AMF=B9B9）ではeapaka_testがAUTN検証時にAMFミスマッチを検出して認証フローを中断する。必ず`config_testvector_imsi003.yaml`（AMF=8000）を使用すること。

---

### 5.5 G5: ポリシー評価

**目的**: 認可ポリシーの各パターン（default allow/deny、NAS/SSID一致/不一致、ワイルドカード、未登録）での動作を検証する。

| ID | シナリオ名 | ツール | テストケース | PASS条件 |
|:---|:---------|:------|:-----------|:--------|
| INT-POLICY-001 | default=allow, ルールなし | eapaka_test | `policy_default_allow_testvector.yaml` (IMSI `001010000000001`) | Accept (VLAN/Timeoutなし) |
| INT-POLICY-002 | default=deny, ルールなし | eapaka_test | `policy_default_deny_testvector.yaml` (IMSI `001010000000002`) | Reject, `AUTH_POLICY_DENIED` ログ |
| INT-POLICY-003 | NAS/SSID一致ルール | eapaka_test | `policy_nas_ssid_match_testvector.yaml` (IMSI `001010000000003`) | Accept (VLAN=100, Timeout=3600) |
| INT-POLICY-004 | NAS一致・SSID不一致 | eapaka_test | `reject_policy_denied_ssid.yaml` (IMSI `001010000000003`) | Reject, `AUTH_POLICY_DENIED` ログ |
| INT-POLICY-005 | NAS不一致 | eapaka_test | `reject_policy_denied_nas.yaml` (IMSI `001010000000003`) | Reject, `AUTH_POLICY_DENIED` ログ |
| INT-POLICY-006 | ワイルドカードSSID | eapaka_test | `policy_wildcard_ssid_testvector.yaml` (IMSI `001010000000006`) | Accept (VLAN=200, Timeout=1800) |
| INT-POLICY-007 | ポリシー未登録 | eapaka_test | `policy_not_found_testvector.yaml` (IMSI `001010000000007`) | Reject, `AUTH_POLICY_NOT_FOUND` ログ |

> **注意（r2）**: INT-POLICY-007で使用するIMSI `001010000000007` は、加入者データの事前登録が必要（ポリシーは登録しない）。加入者データ投入スクリプトに追加すること。

#### 実行手順

```bash
# INT-POLICY-001: default=allow, ルールなし
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/policy_default_allow_testvector.yaml

# INT-POLICY-002: default=deny, ルールなし
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/policy_default_deny_testvector.yaml

# INT-POLICY-003〜005: IMSI 003を使用（AMF=8000専用config必須）
CONFIG_IMSI003="$EAPAKA_TEST/configs/config_testvector_imsi003.yaml"

# INT-POLICY-003: NAS/SSID一致ルール（VLAN/Timeout付与）
$EAPAKA_TEST/eapaka_test -c $CONFIG_IMSI003 run $CASES/policy_nas_ssid_match_testvector.yaml

# INT-POLICY-004: NAS一致・SSID不一致
$EAPAKA_TEST/eapaka_test -c $CONFIG_IMSI003 run $CASES/reject_policy_denied_ssid.yaml

# INT-POLICY-005: NAS不一致
$EAPAKA_TEST/eapaka_test -c $CONFIG_IMSI003 run $CASES/reject_policy_denied_nas.yaml

# INT-POLICY-006: ワイルドカードSSID（IMSI 006使用、SQN事前リセット推奨）
docker compose exec valkey redis-cli -a "$VALKEY_PASSWORD" HSET sub:001010000000006 sqn "000000000001"
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/policy_wildcard_ssid_testvector.yaml

# INT-POLICY-007: ポリシー未登録
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/policy_not_found_testvector.yaml

# ログ確認
docker compose logs auth-server --since=5m | grep -E "AUTH_POLICY|AUTH_SUCCESS|POLICY_DENIED|POLICY_NOT_FOUND"
```

**詳細手順・ポリシー設計方針**: [T-03_INT-POLICY_evaluation_variations.md](subdocs/T-03_INT-POLICY_evaluation_variations.md) を参照。

---

### 5.6 G6: 課金フロー

**目的**: Accounting Start/Interim/Stop の処理、重複検出、不明Status-Typeの動作を検証する。

| ID | シナリオ名 | ツール | PASS条件 |
|:---|:---------|:------|:--------|
| INT-ACCT-START-011 | Accounting-Start | radclient | Accounting-Response, `ACCT_START` ログ |
| INT-ACCT-INTERIM-012 | Accounting-Interim | radclient | Accounting-Response, `ACCT_INTERIM` ログ |
| INT-ACCT-STOP-013 | Accounting-Stop | radclient | Accounting-Response, `ACCT_STOP` ログ |
| INT-ACCT-DUP-014 | 重複Start検出 | radclient | Accounting-Response, `ACCT_DUPLICATE` ログ |
| INT-ACCT-UNKNOWN-015 | 不明Status-Type | radclient | 無応答（破棄） |
| INT-VALKEY-003 | 課金後ステートデータ | redis-cli | `acct:seen:*` 状態遷移確認 |

**前提**: G2の認証成功により `sess:{UUID}` が作成済みであること。Auth Serverログの `AUTH_SUCCESS` からSession UUIDを取得し、radclientのClass属性に設定する。

#### 実行手順

```bash
# Step 1: Session UUIDの取得
SESSION_UUID=$(docker compose logs auth-server --since=10m | \
    grep AUTH_SUCCESS | grep -oP '"session_id":"[^"]*"' | \
    tail -1 | grep -oP '(?<=:")\K[^"]+')
ACCT_SESSION_ID="test-acct-$(date +%s)"

# Step 2: Accounting-Start
echo "Acct-Status-Type=Start
Acct-Session-Id=$ACCT_SESSION_ID
User-Name=0001010000000000@wlan.mnc001.mcc001.3gppnetwork.org
NAS-IP-Address=127.0.0.1
NAS-Identifier=Customer01
Called-Station-Id=00-10-A4-23-19-C0:TESTSSID-01
Class=$SESSION_UUID
Framed-IP-Address=10.0.0.100" | \
radclient -x localhost:1813 acct TESTSECRET123

# Step 3: 重複Start送信（INT-ACCT-DUP-014）
echo "Acct-Status-Type=Start
Acct-Session-Id=$ACCT_SESSION_ID
User-Name=0001010000000000@wlan.mnc001.mcc001.3gppnetwork.org
NAS-IP-Address=127.0.0.1
NAS-Identifier=Customer01
Class=$SESSION_UUID" | \
radclient -x localhost:1813 acct TESTSECRET123

# Step 4: Accounting-Interim
echo "Acct-Status-Type=Interim-Update
Acct-Session-Id=$ACCT_SESSION_ID
User-Name=0001010000000000@wlan.mnc001.mcc001.3gppnetwork.org
NAS-IP-Address=127.0.0.1
NAS-Identifier=Customer01
Class=$SESSION_UUID
Acct-Input-Octets=1048576
Acct-Output-Octets=2097152
Acct-Session-Time=300" | \
radclient -x localhost:1813 acct TESTSECRET123

# Step 5: Accounting-Stop
echo "Acct-Status-Type=Stop
Acct-Session-Id=$ACCT_SESSION_ID
User-Name=0001010000000000@wlan.mnc001.mcc001.3gppnetwork.org
NAS-IP-Address=127.0.0.1
NAS-Identifier=Customer01
Class=$SESSION_UUID
Acct-Input-Octets=5242880
Acct-Output-Octets=10485760
Acct-Session-Time=600
Acct-Terminate-Cause=User-Request" | \
radclient -x localhost:1813 acct TESTSECRET123

# Step 6: 不明Status-Type（INT-ACCT-UNKNOWN-015）
echo "Acct-Status-Type=7
Acct-Session-Id=unknown-test
NAS-IP-Address=127.0.0.1" | \
radclient -x localhost:1813 acct TESTSECRET123
# 期待: タイムアウト（無応答）

# Step 7: Valkey状態検証
docker compose exec valkey redis-cli GET "acct:seen:$ACCT_SESSION_ID"
# 期待: "stop"

# Step 8: ログ確認
docker compose logs acct-server --since=5m | grep -E "ACCT_START|ACCT_INTERIM|ACCT_STOP|ACCT_DUPLICATE"
```

**詳細手順・Valkey状態遷移**: [T-03_INT-005_INT-FLOW_accounting_scenario.md](subdocs/T-03_INT-005_INT-FLOW_accounting_scenario.md) を参照。

**radclientテンプレート**: [radclient_templates_ja.md](subdocs/radclient_templates_ja.md) を参照。

---

### 5.7 G7: 認証→課金一連フロー + 総合検証

**目的**: 認証からAccountingまでの一連フローを通して実行し、Valkeyデータの総合整合性を検証する。

| ID | シナリオ名 | ツール | PASS条件 |
|:---|:---------|:------|:--------|
| INT-FLOW-001 | 認証→課金一連フロー | eapaka_test + radclient | 全ステップ成功、Valkey状態遷移正常 |
| INT-VALKEY-004 | TTLライフサイクル検証 | redis-cli | マスターデータ=永続, ステートデータ=TTL設定済み |
| INT-VALKEY-006 | 総合整合性検証 | redis-cli | データ型・参照整合性・フロー完了後の状態が全てOK |

#### 実行手順

```bash
# Step 1: 認証実行（EAP-AKA）
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/success_aka_testvector.yaml

# Step 2: Session UUID取得
SESSION_UUID=$(docker compose logs auth-server --since=2m | \
    grep AUTH_SUCCESS | grep -oP '"session_id":"[^"]*"' | \
    tail -1 | grep -oP '(?<=:")\K[^"]+')

# Step 3: Accounting Start → Interim → Stop（G6 Step 2〜5 と同様）
# （コマンド省略 — G6セクション参照）

# Step 4: TTLライフサイクル検証
# 検証スクリプト実行 → セクション7.2参照

# Step 5: 総合整合性検証スクリプト実行
# 検証スクリプト → セクション9参照
```

**一連フロー詳細手順**: [T-03_INT-005_INT-FLOW_accounting_scenario.md](subdocs/T-03_INT-005_INT-FLOW_accounting_scenario.md) を参照。

**整合性検証スクリプト**: [T-03_INT-VALKEY_data_integrity_verification.md セクション7, 9](subdocs/T-03_INT-VALKEY_data_integrity_verification.md) を参照。

---

### 5.8 G8: PLMNルーティング

**目的**: Vector GatewayのPLMNマップによるルーティング動作を検証する。gatewayモードでIMSIからPLMNを抽出し、PLMNマップに基づいて適切なバックエンドにルーティングされることを確認する。

| ID | シナリオ名 | ツール | テストケース | PASS条件 |
|:---|:---------|:------|:-----------|:--------|
| INT-GW-PLMN-009 | PLMNマップ一致（内部API） | eapaka_test | `success_aka_testvector.yaml` | Accept（BackendID 00 経由） |
| INT-GW-PLMN-010 | 未実装Backendルーティング | eapaka_test | `reject_plmn_not_implemented.yaml` | Reject（501 Not Implemented） |

> **注意**: 本グループでは `VECTOR_GATEWAY_MODE` と `VECTOR_GATEWAY_PLMN_MAP` 環境変数の変更とdocker compose再起動が必要。テスト完了後は元の設定に復元すること。

#### テストデータ

| IMSI | PLMN | BackendID | ルーティング先 | 状態 |
|:-----|:-----|:----------|:-------------|:-----|
| `001010000000000` | `00101` | `00` | 内部 Vector API | 実装済み |
| `441999123456789` | `441999` | `01` | mediator-carrier-a:8080 | 未実装（501） |

**IMSI `441999123456789` のSIMパラメータ**: 3GPP TS 35.208 Test Set 1 の Ki/OPc/AMF/SQN を流用（Valkey `sub:441999123456789` に登録）。加入者データ投入スクリプトに含まれている。

#### PLMNルーティングの仕組み

```
IMSI → PLMN抽出（先頭5-6桁） → PLMNマップ照合 → BackendID取得
  → BackendID "00": 内部 Vector API（実装済み）→ ベクター返却
  → BackendID "01": 未登録バックエンド → 501 Not Implemented
  → マップ未一致: デフォルト（BackendID "00"）
```

PLMN_MAP形式: `"PLMN:BackendID,PLMN:BackendID,..."` （PLMNは5-6桁数字、BackendIDは2桁数字）

#### 実行手順

```bash
# ===== 環境変更（テスト前） =====

# Step 1: 現在の.env設定をバックアップ
cd /home/<username>/projects/eapaka-radius-server-poc/deployments
cp .env .env.bak.plmn

# Step 2: VECTOR_GATEWAY_MODE を gateway に変更
#   現在の設定: VECTOR_GATEWAY_MODE=passthrough（PLMNルーティング無効）
#   テスト時:   VECTOR_GATEWAY_MODE=gateway（PLMNルーティング有効）
sed -i 's/VECTOR_GATEWAY_MODE=passthrough/VECTOR_GATEWAY_MODE=gateway/' .env

# Step 3: VECTOR_GATEWAY_PLMN_MAP を設定
#   00101:00 → 内部Vector API（テストベクターIMSI用）
#   441999:01 → BackendID 01（未登録、mediator-carrier-a:8080 相当）
echo 'VECTOR_GATEWAY_PLMN_MAP=00101:00,441999:01' >> .env

# Step 4: docker compose 再起動
docker compose up -d

# サービス起動待ち（healthcheck通過確認）
sleep 10
docker compose ps

# ===== INT-GW-PLMN-009: PLMNマップ一致（内部API） =====

# Step 5: テストベクターIMSI（PLMN 00101 → BackendID 00）で認証
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/success_aka_testvector.yaml
# 期待: Access-Accept（内部Vector API経由でベクター取得成功）

# Step 6: Vector Gatewayログでルーティング確認
docker compose logs vector-gateway --since=2m | grep -E "GW_ROUTE|backend_id"
# 期待: event_id=GW_ROUTE, backend_id=00

# ===== INT-GW-PLMN-010: 未実装Backendルーティング =====

# Step 7: 未実装PLMN IMSI（PLMN 441999 → BackendID 01 → 501）で認証
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/reject_plmn_not_implemented.yaml
# 期待: Access-Reject（Gateway が 501 Not Implemented を返却）

# Step 8: Vector Gatewayログでエラー確認
docker compose logs vector-gateway --since=2m | grep -E "GW_ERR|not implemented|backend_id"
# 期待: event_id=GW_ERR, backend_id=01, "backend not implemented"

# Step 9: Auth Serverログでエラー確認
docker compose logs auth-server --since=2m | grep -E "VECTOR_API_ERR|trace_id"
# 期待: VECTOR_API_ERR（Gateway からの501をAuth Serverが受信）

# ===== 環境復元（テスト後） =====

# Step 10: .env を元に戻す
cp .env.bak.plmn .env
rm .env.bak.plmn

# Step 11: docker compose 再起動（passthrough モードに復帰）
docker compose up -d
sleep 10
docker compose ps
```

#### 検証項目

| # | 検証内容 | 確認方法 | PASS条件 |
|:-:|:--------|:--------|:--------|
| 1 | PLMN一致時に正しいBackendIDが選択される | GW ログ `GW_ROUTE` | `backend_id=00` |
| 2 | PLMN一致時に認証が成功する | eapaka_test 結果 | Accept |
| 3 | 未実装BackendID時に501が返却される | GW ログ `GW_ERR` | `backend not implemented` |
| 4 | 未実装Backend時にAuth Serverが Reject を返す | eapaka_test 結果 | Reject |
| 5 | 復元後にpassthroughモードで正常動作する | eapaka_test 再実行 | Accept |

#### 補足: BackendID体系

| BackendID | 名称 | URL | 状態 |
|:---------:|:-----|:----|:-----|
| `00` | 内部 Vector API | `http://vector-api:8080/api/v1/vector` | 実装済み |
| `01` | mediator-carrier-a | `http://mediator-carrier-a:8080` | 未実装（将来対応） |

`mediator-carrier-a:8080` は、将来的に外部キャリア向けの認証ベクター仲介サービスとして実装される想定のバックエンド。現時点ではBackendID `01` がレジストリに未登録のため、`BackendNotImplementedError`（HTTP 501）が返却される。

**シナリオ詳細**: [T-Scenarios_radclient_eapaka_test_ja.md](subdocs/T-Scenarios_radclient_eapaka_test_ja.md) を参照。

---

### 5.9 G9: 障害系 + タイムアウト

**目的**: コンポーネント停止時の縮退動作、Circuit Breaker動作、EAPコンテキストTTL超過時の動作を検証する。

> **重要: 人間介在が必要なグループ。** `docker compose stop/start` による障害注入およびValkey直接操作を含む。AIエージェントでの自動実行時は、各ステップで操作承認が求められる。

| ID | シナリオ名 | ツール | PASS条件 |
|:---|:---------|:------|:--------|
| INT-FAULT-001 | Vector API停止 | eapaka_test + docker compose | Reject（`VECTOR_CONN_ERR`）→ 復旧後Accept |
| INT-FAULT-002 | Valkey停止（認証） | eapaka_test + docker compose | 無応答（`RADIUS_SECRET_ERR`）→ 復旧後Accept（※1） |
| INT-FAULT-003 | Valkey停止（課金） | radclient + docker compose | 無応答（`RADIUS_SECRET_ERR`）→ 復旧後Response（※1） |
| INT-FAULT-004 | Vector Gateway停止 | eapaka_test + docker compose | Reject（`VECTOR_CONN_ERR`）→ 復旧後Accept |
| INT-FAULT-005 | Circuit Breaker動作 | eapaka_test + docker compose | CB Open/Half-Open/Closed遷移ログ確認（※2） |
| INT-TIMEOUT-001 | 疑似タイムアウト（不正State） | radclient + redis-cli | Reject, `EAP_CTX_NOT_FOUND` ログ |
| INT-TIMEOUT-002 | Valkey TTL短縮方式 | redis-cli | キー消滅確認、Reject |
| INT-VALKEY-005 | インデックスクリーンアップ | redis-cli | 孤立インデックス検出可能 |

> **※1 Valkey停止時の挙動（r3追記、r4補足）**: Valkey停止中はRADIUSクライアントのSecret検索が不可能なため（`RADIUS_SECRET_ERR`イベント）、サーバーはReject/Responseパケットを構築できず**無応答（タイムアウト）**となる。これはRejectよりも安全な障害動作であり、PASS判定とする。復旧後はValkeyのAOF永続化により通常データは自動復旧するが、テストデータが消失している場合は再投入が必要。ログ確認時は `VALKEY_CONN_ERR` ではなく `RADIUS_SECRET_ERR` を検索すること（障害はRADIUSプロトコル層のSecret検索段階で顕在化する）。
>
> **※2 Circuit Breaker テスト時の注意（r4追記）**: CBFailureThreshold=5、CBInterval=10秒の設定に対し、Vector API停止中の各リクエストタイムアウトが約4秒かかるため、**逐次実行では10秒ウィンドウ内に5失敗を蓄積できない**。5プロセスを並列実行（バックグラウンド実行 + `wait`）することで10秒以内に5失敗を蓄積し、CB Open遷移を発生させる。CB Half-Open遷移は CBTimeout=30秒後に発生するため、待機後にリクエストを送信して確認する。

#### 障害系の基本パターン

```bash
# 障害注入
docker compose stop <service-name>

# 障害中の動作確認（eapaka_test/radclient実行）
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/success_aka_testvector.yaml
# 期待: Access-Reject

# 復旧
docker compose start <service-name>
sleep 5  # サービス起動待ち

# 復旧後の動作確認
$EAPAKA_TEST/eapaka_test -c $CONFIG run $CASES/success_aka_testvector.yaml
# 期待: Access-Accept

# ログ確認
docker compose logs auth-server --since=5m | grep -E "VECTOR_CONN_ERR|VECTOR_API_ERR|RADIUS_SECRET_ERR|CB_"
```

**障害系シナリオ詳細**: [T-03_INT-FAULT_failure_scenarios.md](subdocs/T-03_INT-FAULT_failure_scenarios.md) を参照。

**タイムアウト検証詳細**: [T-03_INT-TIMEOUT_eap_context_ttl_scenario.md](subdocs/T-03_INT-TIMEOUT_eap_context_ttl_scenario.md) を参照。

**インデックスクリーンアップ検証**: [T-03_INT-VALKEY_data_integrity_verification.md セクション8](subdocs/T-03_INT-VALKEY_data_integrity_verification.md) を参照。

---

## 6. 合格基準

### 6.1 T-01品質ゲート対応

| 品質ゲート項目 | 基準 | 対応グループ |
|:-------------|:----|:-----------|
| テスト成功率 100% | 全シナリオPASS | G1〜G9 |
| 正常系シナリオ全件PASS | 認証成功、課金記録 | G2, G3, G6, G7 |
| 主要異常系シナリオ全件PASS | 認証失敗、再同期、タイムアウト | G3, G4, G9 |
| データ整合性検証PASS | Valkeyデータの期待値一致 | G1(INT-VALKEY-001), G2(INT-VALKEY-002), G6(INT-VALKEY-003), G7(INT-VALKEY-004/006) |

### 6.2 必須シナリオの合格判定

| T-01 ID | 対応シナリオ | 必須 | 代替手段 |
|:--------|:-----------|:----:|:--------|
| INT-001 | INT-AUTH-AKA-001 | 必須 | — |
| INT-002 | INT-AUTH-AKA-002 | 必須 | — |
| INT-003 | INT-003-01, INT-003-02 | 必須 | — |
| INT-004 | INT-AUTH-AKA-005 | 必須 | テストベクター環境ではユニットテストで補完 |
| INT-005 | INT-ACCT-START-011 〜 STOP-013 | 必須 | — |
| INT-006 | INT-006-01 〜 INT-006-03 | 必須 | — |

### 6.3 シナリオ分類別の優先度

| 優先度 | グループ | シナリオ数 | 備考 |
|:------:|:--------|:---------:|:-----|
| 必須 | G1, G2, G3, G6 | 21 | T-01品質ゲート対象 |
| 推奨 | G4, G5, G7 | 14 | 品質向上・網羅性確保 |
| 任意 | G8, G9 | 10 | 環境変更や人間介在が必要 |

---

## 7. AI自動実行ガイド

### 7.1 自動実行可能なグループ

| Group | 自動実行可否 | 備考 |
|:-----:|:----------:|:-----|
| G1 | 可 | radclient, redis-cli のみ |
| G2 | 可 | eapaka_test + ログ確認 |
| G3 | 可 | G2実行後に連続実行 |
| G4 | 可 | eapaka_test のみ |
| G5 | 可 | eapaka_test のみ |
| G6 | 可 | radclient + redis-cli。Session UUIDの取得に注意 |
| G7 | 可 | G2+G6の組み合わせ |
| G8 | 要確認 | .env変更 + docker compose再起動が必要 |
| G9 | 人間介在 | docker compose stop/start の承認が必要 |

### 7.2 AI自動実行時の注意事項

1. **Session UUID取得**: G6・G7ではAuth Serverログから`AUTH_SUCCESS`イベントのsession_idを抽出する必要がある。ログ出力タイミングに依存するため、認証実行後に数秒待機してからログを確認すること。

2. **SQN状態の影響**: 複数グループを順次実行するとSQNがインクリメントされる。G3（SQN再同期）はG2の後に実行すること。異なるIMSIを使用するグループ間では影響なし。

3. **Valkeyデータのリセット**: グループ間でデータ状態がクリーンであることを保証するため、必要に応じてセッション・重複検出データを手動削除する。
   ```bash
   docker compose exec valkey redis-cli KEYS "sess:*" | xargs -r docker compose exec -T valkey redis-cli DEL
   docker compose exec valkey redis-cli KEYS "acct:seen:*" | xargs -r docker compose exec -T valkey redis-cli DEL
   ```

4. **docker compose操作（G9）**: Claude Codeでの`docker compose stop`/`start`は権限承認ダイアログが表示される。自動実行する場合は事前に許可設定を行うか、人間が各ステップで承認する。

5. **ログのタイムスタンプ**: `--since` パラメータで対象期間を適切に絞ること。長時間実行時は前のグループのログと混在する可能性がある。

6. **IMSI別eapaka_test設定の使い分け（r3追記）**: IMSI 003（AMF=8000）を使用するシナリオでは`config_testvector_imsi003.yaml`を使用する。デフォルトの`config_testvector.yaml`（AMF=B9B9）を使用するとAMFミスマッチで認証フローが中断される。対象シナリオ: INT-AUTH-AKA-007, INT-POLICY-003, INT-POLICY-004, INT-POLICY-005。

7. **SQN初期値とリセット運用（r3追記）**: テストベクターモードではSQN increment step = 0x20（32進）であり、テストを繰り返すとSQNが急速に増加する。高SQN値（例: `FF9BB4D0B607`）ではVector APIの「SQN difference exceeds allowed range」チェックに抵触し認証が失敗する場合がある。各IMSI のSQNをテスト開始前に低値（`000000000001`）にリセットすることを推奨する。
   ```bash
   # SQNリセット例（全テストベクターIMSI）
   docker compose exec valkey redis-cli -a "$VALKEY_PASSWORD" HSET sub:001010000000000 sqn "000000000001"
   docker compose exec valkey redis-cli -a "$VALKEY_PASSWORD" HSET sub:001010000000001 sqn "000000000001"
   docker compose exec valkey redis-cli -a "$VALKEY_PASSWORD" HSET sub:001010000000003 sqn "000000000001"
   docker compose exec valkey redis-cli -a "$VALKEY_PASSWORD" HSET sub:001010000000006 sqn "000000000001"
   # eapaka_testのSQNストアファイルも削除
   rm -f /tmp/eapaka_test-sqn-testvector.json
   rm -f /tmp/eapaka_test-sqn-testvector-imsi003.json
   ```

8. **radclient属性入力方式（r3追記）**: radclientへの属性入力にechoパイプ（`echo -e '...' | radclient`）を使用すると、シェル環境によっては属性名解析エラーが発生する場合がある。一時ファイルに属性を書き出してからリダイレクトで入力する方式を推奨する。
   ```bash
   # 推奨方式
   printf 'Message-Authenticator = 0x00\n' > /tmp/status.attrs
   radclient -x -r 1 -t 3 127.0.0.1:1812 status TESTSECRET123 < /tmp/status.attrs

   # 非推奨（環境依存で失敗する可能性あり）
   echo -e 'Message-Authenticator = 0x00' | radclient -x 127.0.0.1:1812 status TESTSECRET123
   ```

9. **Valkey停止テスト後のデータ再投入（r3追記、r4補足）**: INT-FAULT-002/003でValkeyを停止・再起動した際、AOF永続化が有効であればデータは自動復旧する。ただし`FLUSHDB`が実行された場合やAOFファイルが破損した場合はデータが消失する。復旧後の認証テスト（Accept確認）の前に、テストデータ（加入者・クライアント・ポリシー）が残存しているか `DBSIZE` コマンド等で確認し、必要に応じて再投入すること。

10. **Valkey停止時のログイベントID（r4追記）**: Valkey停止時のエラーは `VALKEY_CONN_ERR` ではなく **`RADIUS_SECRET_ERR`** として記録される。これはRADIUSプロトコル層でクライアントSecret検索（Valkey参照）に失敗するためであり、認証/課金の処理ロジックに到達する前にパケットが破棄される。ログ検索時は `grep -E "RADIUS_SECRET_ERR"` を使用すること。

11. **Vector API停止 vs Vector Gateway停止のログイベント（r4追記）**: Vector API単体停止時はVector Gatewayが502 Bad Gatewayを返すため `VECTOR_API_ERR` が記録される。一方、Vector Gateway自体を停止した場合はDNS解決失敗またはコネクション拒否となるため `VECTOR_CONN_ERR` が記録される。障害箇所によってイベントIDが異なる点に注意。

12. **Circuit Breaker テストの並列実行（r4追記）**: INT-FAULT-005（CB動作確認）では、CBInterval=10秒以内にCBFailureThreshold=5回の失敗を蓄積する必要がある。各リクエストのタイムアウトが約4秒のため逐次実行では不可能。以下のように並列実行する:
    ```bash
    # Vector API停止後、5プロセス並列でCB Open遷移を発生させる
    for i in $(seq 1 5); do
      eapaka_test -c $CONFIG run $CASES/success_aka_testvector.yaml &
    done
    wait
    # auth-serverログで CB_OPEN を確認
    docker compose logs auth-server --since=1m | grep CB_OPEN
    ```

13. **eapaka_test SQNストアファイルのIMSI間干渉（r4追記）**: eapaka_testのSQNストアファイルは `sim.imsi` をキーにSQNを管理するが、設定ファイルのIMSIとテストケースのIMSIが異なる場合、設定ファイルのIMSI（デフォルト: `001010000000000`）のSQNが使用される。異なるIMSI（例: `001010000000007`）のテスト実行後にIMSI 000のサーバー側SQNとの不整合が発生する場合がある。テストケース切替時にはSQNストアファイルの削除を推奨する。

### 7.3 推奨実行順序チェックリスト

```
[ ] 1. Docker Compose環境起動
[ ] 2. テストデータ投入（セクション3）
[ ] 3. G1: 事前検証
[ ] 4. G2: 認証正常系
[ ] 5. G3: SQN再同期（G2後に実行）
[ ] 6. G4: 認証異常系（G2と並行可能だが、順次推奨）
[ ] 7. G5: ポリシー評価
[ ] 8. G6: 課金フロー（G2のSession UUID使用）
[ ] 9. G7: 一連フロー + 総合検証
[ ] 10. G8: PLMNルーティング（環境変更を伴う）
[ ] 11. G9: 障害系 + タイムアウト（人間介在）
[ ] 12. Docker Compose環境停止
```

---

## 付録A: 全シナリオ一覧（44件）

| # | ID | シナリオ名 | Group | ツール | 期待結果 |
|:-:|:---|:---------|:-----:|:------|:--------|
| 1 | INT-VALKEY-001 | マスターデータ形式検証 | G1 | redis-cli | 加入者6件・クライアント6件・ポリシー8件OK |
| 2 | INT-AUTH-STATUS-001 | Auth Status-Server (正常) | G1 | radclient | Accept |
| 3 | INT-AUTH-STATUS-002 | Auth Status-Server (MA検証失敗) | G1 | radclient | 無応答 |
| 4 | INT-ACCT-STATUS-016 | Acct Status-Server | G1 | radclient | Response |
| 5 | INT-AUTH-IDENTITY-003 | Identity応答確認 | G1 | radclient | Challenge |
| 6 | INT-AUTH-AKA-001 | EAP-AKA 正常認証 | G2 | eapaka_test | Accept |
| 7 | INT-AUTH-AKA-002 | EAP-AKA' 正常認証 | G2 | eapaka_test | Accept |
| 8 | INT-AUTH-AKA-003 | Permanent ID要求 | G2 | eapaka_test | Accept |
| 9 | INT-006-01 | X-Trace-ID (AKA) | G2 | ログ検証 | 同一trace_id |
| 10 | INT-006-02 | X-Trace-ID (AKA') | G2 | ログ検証 | 同一trace_id |
| 11 | INT-VALKEY-002 | 認証後ステートデータ | G2 | redis-cli | eap削除, sess作成 |
| 12 | INT-TIMEOUT-003 | TTLリフレッシュ確認 | G2 | redis-cli | EXPIRE確認 |
| 13 | INT-003-01 | EAP-AKA SQN再同期 | G3 | eapaka_test | Accept |
| 14 | INT-003-02 | EAP-AKA' SQN再同期 | G3 | eapaka_test | Accept |
| 15 | INT-006-03 | X-Trace-ID (再同期時) | G3 | ログ検証 | trace_id伝搬 |
| 16 | INT-AUTH-AKA-004 | EAP方式ミスマッチ拒否 | G4 | eapaka_test | Reject |
| 17 | INT-AUTH-AKA-005 | Ki/OPc不正 (XRES不一致) | G4 | eapaka_test | Reject |
| 18 | INT-AUTH-AKA-006 | 未登録IMSI | G4 | eapaka_test | Reject |
| 19 | INT-AUTH-AKA-007 | ポリシー違反 | G4 | eapaka_test | Reject |
| 20 | INT-POLICY-001 | default=allow, ルールなし | G5 | eapaka_test | Accept |
| 21 | INT-POLICY-002 | default=deny, ルールなし | G5 | eapaka_test | Reject |
| 22 | INT-POLICY-003 | NAS/SSID一致ルール | G5 | eapaka_test | Accept |
| 23 | INT-POLICY-004 | NAS一致・SSID不一致 | G5 | eapaka_test | Reject |
| 24 | INT-POLICY-005 | NAS不一致 | G5 | eapaka_test | Reject |
| 25 | INT-POLICY-006 | ワイルドカードSSID | G5 | eapaka_test | Accept |
| 26 | INT-POLICY-007 | ポリシー未登録 | G5 | eapaka_test | Reject |
| 27 | INT-ACCT-START-011 | Accounting-Start | G6 | radclient | Response |
| 28 | INT-ACCT-INTERIM-012 | Accounting-Interim | G6 | radclient | Response |
| 29 | INT-ACCT-STOP-013 | Accounting-Stop | G6 | radclient | Response |
| 30 | INT-ACCT-DUP-014 | 重複Start検出 | G6 | radclient | Response + DUPログ |
| 31 | INT-ACCT-UNKNOWN-015 | 不明Status-Type | G6 | radclient | 無応答 |
| 32 | INT-VALKEY-003 | 課金後ステートデータ | G6 | redis-cli | acct:seen状態確認 |
| 33 | INT-FLOW-001 | 認証→課金一連フロー | G7 | eapaka_test + radclient | 全ステップ成功 |
| 34 | INT-VALKEY-004 | TTLライフサイクル検証 | G7 | redis-cli | TTL値正常 |
| 35 | INT-VALKEY-006 | 総合整合性検証 | G7 | redis-cli | 全データ整合性OK |
| 36 | INT-GW-PLMN-009 | PLMN一致（内部API） | G8 | eapaka_test | Accept (BackendID 00) |
| 37 | INT-GW-PLMN-010 | 未実装Backend (PLMN 441999) | G8 | eapaka_test | Reject (501) |
| 38 | INT-FAULT-001 | Vector API停止 | G9 | eapaka_test + docker | Reject→復旧Accept |
| 39 | INT-FAULT-002 | Valkey停止（認証） | G9 | eapaka_test + docker | 無応答→復旧Accept |
| 40 | INT-FAULT-003 | Valkey停止（課金） | G9 | radclient + docker | 無応答→復旧Response |
| 41 | INT-FAULT-004 | Vector Gateway停止 | G9 | eapaka_test + docker | Reject→復旧Accept |
| 42 | INT-FAULT-005 | Circuit Breaker動作 | G9 | eapaka_test + docker | CB状態遷移確認 |
| 43 | INT-TIMEOUT-001 | 疑似タイムアウト | G9 | radclient + redis-cli | Reject |
| 44 | INT-TIMEOUT-002 | Valkey TTL短縮方式 | G9 | redis-cli | キー消滅確認 |

> **注記**: INT-VALKEY-005（インデックスクリーンアップ検証）はG9のINT-TIMEOUT-002に含めて実施可能。INT-TIMEOUT-002実行後にAdmin TUI側クリーンアップ動作を確認する。

---

## 付録B: テストケースファイル対応表

| テストケースファイル | 使用シナリオ | パス |
|:------------------|:-----------|:-----|
| `success_aka_testvector.yaml` | INT-AUTH-AKA-001, INT-006-01, INT-VALKEY-002, INT-FLOW-001 | `testdata/cases/` |
| `success_aka_prime_testvector.yaml` | INT-AUTH-AKA-002, INT-006-02 | `testdata/cases/` |
| `perm_id_req_from_pseudonym.yaml` | INT-AUTH-AKA-003 | `testdata/cases/` |
| `mismatch_strict_fail.yaml` | INT-AUTH-AKA-004 | `testdata/cases/` |
| `reject_imsi_not_found.yaml` | INT-AUTH-AKA-006 | `testdata/cases/` |
| `reject_policy_denied_ssid.yaml` | INT-AUTH-AKA-007, INT-POLICY-004 | `testdata/cases/` ※config_testvector_imsi003.yaml使用 |
| `reject_policy_denied_nas.yaml` | INT-POLICY-005 | `testdata/cases/` ※config_testvector_imsi003.yaml使用 |
| `policy_default_allow_testvector.yaml` | INT-POLICY-001 | `testdata/cases/` |
| `policy_default_deny_testvector.yaml` | INT-POLICY-002 | `testdata/cases/` |
| `policy_nas_ssid_match_testvector.yaml` | INT-POLICY-003 | `testdata/cases/` ※config_testvector_imsi003.yaml使用 |
| `policy_wildcard_ssid_testvector.yaml` | INT-POLICY-006 | `testdata/cases/` |
| `policy_not_found_testvector.yaml` | INT-POLICY-007 | `testdata/cases/` |
| `resync_aka_testvector.yaml` | INT-003-01, INT-006-03 | `testdata/cases/` |
| `resync_aka_prime_testvector.yaml` | INT-003-02 | `testdata/cases/` |
| `reject_plmn_not_implemented.yaml` | INT-GW-PLMN-010 | `testdata/cases/` |

> **テストケースファイルのベースパス**: `/home/<username>/devtools/eapaka_test/testdata/cases/`
> **eapaka_test設定ファイル（デフォルト）**: `/home/<username>/devtools/eapaka_test/configs/config_testvector.yaml`
> **eapaka_test設定ファイル（IMSI 003用）**: `/home/<username>/devtools/eapaka_test/configs/config_testvector_imsi003.yaml`

---

## 付録C: 参照subdocs一覧

| ドキュメント | T-03での参照箇所 |
|:------------|:---------------|
| [test_subscriber_data_scripts.md](subdocs/test_subscriber_data_scripts.md) | セクション3（テストデータ事前準備） |
| [test_radius_client_data_scripts.md](subdocs/test_radius_client_data_scripts.md) | セクション3（テストデータ事前準備） |
| [test_policy_data_scripts.md](subdocs/test_policy_data_scripts.md) | セクション3（テストデータ事前準備） |
| [radclient_templates_ja.md](subdocs/radclient_templates_ja.md) | G1, G6（radclientテンプレート） |
| [T-Scenarios_radclient_eapaka_test_ja.md](subdocs/T-Scenarios_radclient_eapaka_test_ja.md) | セクション1.4（シナリオID体系）, G8 |
| [Parameters_usage_and_Related_test_scenarios(WIP).md](subdocs/Parameters_usage_and_Related_test_scenarios(WIP).md) | パラメータ対応表 |
| [T-03_INT-003_SQN_resync_flow_scenario.md](subdocs/T-03_INT-003_SQN_resync_flow_scenario.md) | G3（SQN再同期詳細） |
| [T-03_INT-005_INT-FLOW_accounting_scenario.md](subdocs/T-03_INT-005_INT-FLOW_accounting_scenario.md) | G6, G7（課金フロー詳細） |
| [T-03_INT-006_X-Trace-ID_propagation_scenario.md](subdocs/T-03_INT-006_X-Trace-ID_propagation_scenario.md) | G2, G3（X-Trace-ID伝搬詳細） |
| [T-03_INT-FAULT_failure_scenarios.md](subdocs/T-03_INT-FAULT_failure_scenarios.md) | G9（障害系詳細） |
| [T-03_INT-POLICY_evaluation_variations.md](subdocs/T-03_INT-POLICY_evaluation_variations.md) | G5（ポリシー評価詳細） |
| [T-03_INT-TIMEOUT_eap_context_ttl_scenario.md](subdocs/T-03_INT-TIMEOUT_eap_context_ttl_scenario.md) | G9（タイムアウト検証詳細） |
| [T-03_INT-VALKEY_data_integrity_verification.md](subdocs/T-03_INT-VALKEY_data_integrity_verification.md) | G1, G2, G6, G7, G9（データ整合性検証） |

---

## 改版履歴

| 版数 | 日付 | 変更内容 |
|:----:|:-----|:---------|
| r1 | 2026-02-07 | 初版作成 |
| r2 | 2026-02-15 | 以下の変更を反映: |
| | | - 参照ドキュメント版数更新（D-08: r8→r9, D-10: r5→r4） |
| | | - Secret体系の明確化（クライアント登録Secret `TESTSECRET123` / フォールバック `RADIUS_SECRET`） |
| | | - テストデータ（加入者・クライアント・ポリシー）を投入スクリプトの実態と整合 |
| | | - RADIUSクライアント表にDockerゲートウェイIP含む全6エントリを記載 |
| | | - INT-AUTH-STATUS-002: Message-Authenticator検証バグを修正（handler.goで`HandleStatusServer()`を使用）、PASS条件に `RADIUS_STATUS_AUTH_FAIL` ログ確認を追加 |
| | | - G3 SQN再同期: Valkey-backed SQN対応を反映、テスト手順をSQN手動設定→再同期フロー発生方式に改訂 |
| | | - G5 INT-POLICY-007: ポリシー未登録テスト用IMSI `001010000000007` の加入者データ事前登録が必要な旨を注記 |
| | | - G6 radclientコマンド例のSecretを `TESTSECRET123` に統一 |
| | | - 結合テスト結果報告（20260207）・再実施報告（20260214）の是正事項を反映 |
| r3 | 2026-02-16 | 結合テスト再実施（20260216）で判明した知見を反映: |
| | | - IMSI 003専用eapaka_test設定ファイル（`config_testvector_imsi003.yaml`, AMF=8000）の追加と使用指示 |
| | | - G4 INT-AUTH-AKA-007、G5 INT-POLICY-003〜005の実行手順をIMSI 003専用config使用に修正 |
| | | - G5 INT-POLICY-006のSQN事前リセット手順を追加 |
| | | - G9 INT-FAULT-002/003のPASS条件を実態（無応答/タイムアウト）に修正し、理由を注記 |
| | | - AI自動実行ガイド（7.2）にSQN管理・AMF設定使い分け・radclient入力方式・Valkey復旧後データ再投入の注意事項を追加 |
| | | - 付録Bにconfig_testvector_imsi003.yamlの参照情報を追加 |
| r4 | 2026-02-21 | 結合テスト再実施（20260221）全44件完了で得られた知見を反映: |
| | | - G3: `sqn.reset: true` と Resync 発動条件の関係を注記（3GPP TS 33.102 SQN検証仕様に基づく説明追加） |
| | | - G9: 障害系PASS条件にログイベントID（`VECTOR_CONN_ERR`, `RADIUS_SECRET_ERR`）を明記 |
| | | - G9: Circuit Breaker テストの並列実行要件（※2注記）を追加 |
| | | - G9: Valkey停止時の障害メカニズム説明を補足（RADIUS_SECRET_ERR経由でのパケット破棄） |
| | | - 付録A: INT-FAULT-002/003の期待結果を「無応答」に修正（Reject/Responseから変更） |
| | | - AI自動実行ガイド（7.2）に以下を追加: |
| | |   - #10: Valkey停止時のログイベントID（RADIUS_SECRET_ERR） |
| | |   - #11: Vector API停止 vs Gateway停止のイベントID区別（VECTOR_API_ERR vs VECTOR_CONN_ERR） |
| | |   - #12: Circuit Breaker テスト並列実行手順 |
| | |   - #13: eapaka_test SQNストアファイルのIMSI間干渉の注意 |
| | | - Valkey AOF永続化によるデータ自動復旧に関する補足追記 |
| | | - ログ確認コマンドのgrepパターンを実態のイベントIDに修正 |
