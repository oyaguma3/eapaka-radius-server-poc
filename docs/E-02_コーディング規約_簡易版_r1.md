# E-02 コーディング規約（簡易版）(r1)

## 1. 概要

### 1.1 目的

本ドキュメントは、EAP-AKA RADIUS PoC環境の開発において、コードの品質・可読性・保守性を統一するためのコーディング規約を定義する。

### 1.2 スコープ

**本書で扱う範囲：**

- Go言語のコーディングスタイル
- 命名規則
- パッケージ構成
- エラーハンドリングパターン
- 構造体タグ規約
- ログ出力規約

**本書で扱わない範囲：**

| 範囲 | 参照先 |
|------|--------|
| インフラ設定（Docker, Valkey等） | D-08 インフラ設定・運用設計書 |
| ログフォーマット・event_id詳細 | D-04 ログ仕様設計書 |
| エラー分類・タイムアウト値詳細 | D-06 エラーハンドリング詳細設計書 |
| 共通ライブラリ(pkg)の詳細設計 | E-03 共通ライブラリ設計書（予定） |

### 1.3 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| D-01 ミニPC版設計仕様書 (r5) | リポジトリ構成、パッケージ利用マップ |
| D-02 Valkeyデータ設計仕様書 (r7) | Go構造体定義、redisタグ |
| D-04 ログ仕様設計書 (r8) | ログレベル、event_id定義 |
| D-06 エラーハンドリング詳細設計書 (r3) | エラー定義パターン、レイヤー別責務 |
| D-09 Auth Server詳細設計書 (r5) | パッケージ構成、インターフェース設計 |
| E-01 開発環境セットアップガイド (r1) | Go環境、ツール設定 |

### 1.4 本規約の適用範囲

本規約は以下のディレクトリ配下のGoコードに適用する。

| ディレクトリ | 対象 |
|-------------|------|
| `apps/auth-server/` | RADIUS認証サーバー |
| `apps/acct-server/` | RADIUS課金サーバー |
| `apps/vector-gateway/` | ベクター取得ルーター |
| `apps/vector-api/` | ベクター計算API |
| `apps/admin-tui/` | 管理コンソール |
| `pkg/` | 共通ライブラリ |

---

## 2. 命名規則

### 2.1 パッケージ名

| 規則 | 説明 |
|------|------|
| 小文字のみ | アンダースコア、ハイフン禁止 |
| 単一単語推奨 | 複合語は避ける |
| 名詞使用 | 動詞は避ける |

```go
// 良い例
package config
package handler
package store
package milenage

// 悪い例
package configLoader    // 複合語
package get_config      // アンダースコア
package handling        // 動詞形
```

### 2.2 型名（構造体・インターフェース）

#### 構造体

| 規則 | 説明 | 例 |
|------|------|-----|
| PascalCase | 先頭大文字、単語区切りも大文字 | `EAPContext`, `PolicyRule` |
| 名詞または名詞句 | 何を表すかが明確 | `Session`, `RadiusClient` |
| 略語は大文字維持 | 一般的な略語 | `HTTPHandler`, `UUIDGenerator` |

```go
// 良い例
type EAPContext struct { ... }
type PolicyRule struct { ... }
type VectorResponse struct { ... }

// 悪い例
type eapContext struct { ... }    // exported型は大文字始まり
type Policy_Rule struct { ... }   // アンダースコア禁止
type Eapcontext struct { ... }    // 略語は大文字維持
```

#### インターフェース

| 規則 | 説明 | 例 |
|------|------|-----|
| 単一メソッド | 動詞 + `er` | `Reader`, `Writer` |
| 複数メソッド | 役割を表す名詞 | `ContextStore`, `VectorClient` |
| 末尾に`er`または役割名 | 動作主を表す | `Evaluator`, `SecretSource` |

```go
// 良い例
type ContextStore interface {
    Get(ctx context.Context, id string) (*EAPContext, error)
    Create(ctx context.Context, id string, data *EAPContext) error
    Delete(ctx context.Context, id string) error
}

type VectorClient interface {
    GetVector(ctx context.Context, req *VectorRequest) (*VectorResponse, error)
}

type Evaluator interface {
    Evaluate(ctx context.Context, imsi string, nasID string) (*Result, error)
}
```

### 2.3 関数・メソッド名

| 区分 | 規則 | 例 |
|------|------|-----|
| Exported | PascalCase、動詞始まり | `GetPolicy()`, `CreateSession()` |
| Unexported | camelCase、動詞始まり | `parseIMSI()`, `validateRequest()` |
| ゲッター | `Get`プレフィックス | `GetSecret()`, `GetConfig()` |
| セッター | `Set`プレフィックス | `SetTimeout()`, `SetLogger()` |
| 真偽値返却 | `Is`/`Has`/`Can`プレフィックス | `IsValid()`, `HasExpired()` |
| コンストラクタ | `New`プレフィックス | `NewServer()`, `NewClient()` |

```go
// 良い例
func NewServer(cfg *Config) *Server { ... }
func (s *Server) Start(ctx context.Context) error { ... }
func (s *Server) IsRunning() bool { ... }
func parseIMSI(identity string) (string, error) { ... }

// 悪い例
func server(cfg *Config) *Server { ... }     // コンストラクタはNew始まり
func (s *Server) running() bool { ... }      // 真偽値はIs/Has/Can始まり
func ParseImsi(identity string) { ... }      // 略語は大文字維持
```

### 2.4 変数・定数名

#### 変数

| 区分 | 規則 | 例 |
|------|------|-----|
| ローカル変数 | camelCase、短く明確に | `ctx`, `err`, `req`, `resp` |
| パッケージ変数 | camelCase（unexported）またはPascalCase（exported） | `defaultTimeout`, `MaxRetries` |
| ループ変数 | 1文字可（スコープが狭い場合） | `i`, `k`, `v` |

```go
// 良い例
func process(ctx context.Context, req *Request) error {
    resp, err := client.Send(ctx, req)
    if err != nil {
        return err
    }
    for i, item := range resp.Items {
        // ...
    }
    return nil
}

// 悪い例
func process(context context.Context, request *Request) error {
    // 標準的な短縮名を使用すべき
    response, error := client.Send(context, request)
    // ...
}
```

#### 定数

| 区分 | 規則 | 例 |
|------|------|-----|
| Exported定数 | PascalCase | `MaxRetries`, `DefaultTimeout` |
| Unexported定数 | camelCase | `maxBufferSize`, `defaultPort` |
| 列挙的定数 | プレフィックス統一 | `StageNew`, `StageChallengeSent` |
| 環境変数キー | ALL_CAPS（文字列値として） | `"AUTH_SERVER_PORT"` |

```go
// 良い例
const (
    // EAP状態定数（D-03/D-09準拠）
    StageNew             = "NEW"
    StageWaitingIdentity = "WAITING_IDENTITY"
    StageIdentityReceived = "IDENTITY_RECEIVED"
    StageWaitingVector   = "WAITING_VECTOR"
    StageChallengeSent   = "CHALLENGE_SENT"
    StageResyncSent      = "RESYNC_SENT"
    StageSuccess         = "SUCCESS"
    StageFailure         = "FAILURE"
)

const (
    defaultTimeout = 5 * time.Second
    maxRetries     = 3
)
```

### 2.5 エラー変数

| 規則 | 説明 | 例 |
|------|------|-----|
| `Err`プレフィックス | センチネルエラー | `ErrNotFound`, `ErrTimeout` |
| PascalCase | Exportedエラー | `ErrIMSINotFound` |
| 具体的な名前 | 何が起きたかが明確 | `ErrPolicyDenied`, `ErrAuthFailed` |

```go
// 良い例（D-06準拠）
var (
    ErrIMSINotFound       = errors.New("IMSI not found")
    ErrPolicyNotFound     = errors.New("policy not found")
    ErrPolicyDenied       = errors.New("policy denied")
    ErrAuthFailed         = errors.New("authentication failed")
    ErrAuthResMismatch    = errors.New("RES mismatch")
    ErrAuthMACInvalid     = errors.New("MAC verification failed")
    ErrAuthTimeout        = errors.New("EAP context timeout")
    ErrValkeyConnection   = errors.New("valkey connection failed")
    ErrVectorAPI          = errors.New("vector API error")
    ErrUnsupportedEAPType = errors.New("unsupported EAP type")
)

// 悪い例
var (
    NotFoundError = errors.New("not found")  // Errプレフィックスなし
    imsiNotFound  = errors.New("...")        // Exportedすべき
)
```

### 2.6 ファイル名

| 規則 | 説明 | 例 |
|------|------|-----|
| 小文字のみ | 大文字禁止 | `config.go`, `handler.go` |
| アンダースコア区切り | 単語区切りに使用 | `proxy_state.go`, `circuit_breaker.go` |
| テストファイル | `_test.go`サフィックス | `handler_test.go` |
| プラットフォーム固有 | `_linux.go`, `_darwin.go` | （本PoCでは不使用） |

```
internal/
├── config/
│   └── config.go
├── server/
│   ├── server.go
│   ├── handler.go
│   └── secret.go
├── radius/
│   ├── packet.go
│   ├── authenticator.go
│   └── proxy_state.go
└── eap/
    ├── aka/
    │   ├── challenge.go
    │   └── challenge_test.go
    └── akaprime/
        └── challenge.go
```

---

## 3. パッケージ構成

### 3.1 ディレクトリ構造規約

各アプリケーションは以下の標準構造に従う。

```
apps/{app-name}/
├── main.go                 # エントリーポイント（最小限の初期化コード）
├── internal/               # アプリケーション固有の非公開パッケージ
│   ├── config/             # 環境変数読み込み、設定構造体
│   ├── server/             # サーバー起動、ハンドラ登録
│   ├── handler/            # リクエストハンドラ（HTTP/RADIUS）
│   ├── usecase/            # ビジネスロジック（任意）
│   ├── store/              # データアクセス層
│   └── {domain}/           # ドメイン固有処理
├── Dockerfile
└── go.mod
```

### 3.2 internal パッケージの分類

| パッケージ | 責務 | 配置基準 |
|-----------|------|---------|
| `config` | 環境変数読み込み、設定値管理 | 必須 |
| `server` | サーバー起動・停止、ルーティング設定 | 必須 |
| `handler` | リクエスト受信、レスポンス生成 | 必須 |
| `usecase` | ビジネスロジック、ユースケース実装 | 複雑な場合 |
| `store` | Valkey等のデータアクセス | データ永続化がある場合 |
| `{domain}` | ドメイン固有処理（eap, radius, milenage等） | ドメインロジックがある場合 |
| `logging` | ログ関連ユーティリティ（IMSIマスキング等） | 必要に応じて |

### 3.3 pkg（共通ライブラリ）の利用方針

| 方針 | 説明 |
|------|------|
| 複数アプリで共有 | 2つ以上のアプリケーションで使用するコードのみ配置 |
| 安定したAPI | 頻繁な変更が予想されるコードは配置しない |
| 依存最小化 | 外部パッケージへの依存を最小限に |

**pkg配置候補：**

- 共通エラー定義（`pkg/apperr`）
- 共通ユーティリティ（`pkg/util`）
- 共通Valkeyクライアント初期化（`pkg/valkey`）

> **注記:** pkg の詳細設計は E-03「共通ライブラリ設計書」で定義する。

### 3.4 パッケージ間依存ルール

#### 依存方向

```
main.go
    │
    └── internal/config
            │
            ▼
        internal/server
            │
            ├── internal/handler
            │       │
            │       ▼
            │   internal/usecase（存在する場合）
            │       │
            │       ▼
            └── internal/store
                    │
                    ▼
                  pkg/*
```

#### 禁止事項

| 禁止事項 | 理由 |
|---------|------|
| 循環参照 | コンパイルエラー、設計の問題を示す |
| handler → handler | ハンドラ間の直接呼び出し禁止 |
| store → handler | 下位層から上位層への依存禁止 |
| config以外 → 環境変数直接参照 | 設定の一元管理のため |

#### 許可事項

| 許可事項 | 条件 |
|---------|------|
| 同一パッケージ内の相互参照 | 同一ディレクトリ内のファイル間 |
| pkg への依存 | 全パッケージから許可 |
| 標準ライブラリへの依存 | 全パッケージから許可 |

---

## 4. エラーハンドリング

### 4.1 エラー定義パターン

本プロジェクトでは以下の3パターンを使用する。

#### パターン1: センチネルエラー

単純な判定に使用。詳細情報不要の場合。

```go
// 定義（apperr パッケージ）
var ErrIMSINotFound = errors.New("IMSI not found")

// 使用
if errors.Is(err, apperr.ErrIMSINotFound) {
    // IMSI未登録時の処理
}
```

#### パターン2: カスタムエラー型

詳細情報が必要な場合。

```go
// 定義
type ValidationError struct {
    Field   string
    Message string
}

func (e *ValidationError) Error() string {
    return fmt.Sprintf("validation error: %s - %s", e.Field, e.Message)
}

// 使用
var valErr *ValidationError
if errors.As(err, &valErr) {
    log.Printf("field=%s, message=%s", valErr.Field, valErr.Message)
}
```

#### パターン3: ラップエラー

コンテキスト情報を追加する場合。

```go
// 定義（呼び出し箇所で）
if err := store.Get(ctx, key); err != nil {
    return fmt.Errorf("get subscriber %s: %w", imsi, err)
}

// 元エラーの判定
if errors.Is(err, redis.Nil) {
    // キー不在時の処理
}
```

### 4.2 エラーラッピング規約

| レイヤー | 責務 | ラッピング例 |
|---------|------|-------------|
| Store層 | 生エラーにキー情報を付加 | `fmt.Errorf("get sub:%s: %w", imsi, err)` |
| Usecase層 | ビジネスエラーへの変換 | `apperr.ErrIMSINotFound` を返却 |
| Handler層 | ログ出力と応答生成 | `slog.Error(...)` + 応答送信 |

```go
// Store層
func (r *SubscriberRepo) Get(ctx context.Context, imsi string) (*Subscriber, error) {
    result, err := r.client.HGetAll(ctx, "sub:"+imsi).Result()
    if err != nil {
        return nil, fmt.Errorf("hgetall sub:%s: %w", imsi, err)
    }
    if len(result) == 0 {
        return nil, fmt.Errorf("subscriber %s: %w", imsi, apperr.ErrIMSINotFound)
    }
    // ...
}

// Usecase層
func (u *AuthUsecase) Authenticate(ctx context.Context, imsi string) error {
    sub, err := u.repo.Get(ctx, imsi)
    if err != nil {
        if errors.Is(err, apperr.ErrIMSINotFound) {
            return apperr.ErrIMSINotFound  // センチネルエラーとして返却
        }
        return fmt.Errorf("get subscriber: %w", err)
    }
    // ...
}

// Handler層
func (h *AuthHandler) Handle(ctx context.Context, req *Request) *Response {
    err := h.usecase.Authenticate(ctx, req.IMSI)
    if err != nil {
        switch {
        case errors.Is(err, apperr.ErrIMSINotFound):
            slog.Info("authentication failed",
                "event_id", "AUTH_IMSI_NOT_FOUND",
                "imsi", maskIMSI(req.IMSI))
            return buildRejectResponse(req)
        default:
            slog.Error("unexpected error",
                "event_id", "SYS_ERR",
                "error", err.Error())
            return buildRejectResponse(req)
        }
    }
    // ...
}
```

### 4.3 レイヤー別責務

| レイヤー | エラー処理責務 | ログ出力 | 応答生成 |
|---------|--------------|---------|---------|
| Store層 | エラーラッピング | しない | しない |
| Usecase層 | ビジネスエラー変換 | しない | しない |
| Handler層 | 最終判定 | する | する |

**重要:** ログ出力は Handler層でのみ行う。下位層でログを出力すると重複ログが発生する。

### 4.4 HTTP APIエラーレスポンス（RFC 7807）

Vector API, Vector Gateway では RFC 7807 準拠の Problem Details 形式を使用する。

```go
// dto/error.go
type ProblemDetail struct {
    Type   string `json:"type"`
    Title  string `json:"title"`
    Detail string `json:"detail"`
    Status int    `json:"status"`
}

func NewProblemDetail(status int, title, detail string) *ProblemDetail {
    return &ProblemDetail{
        Type:   "about:blank",
        Title:  title,
        Detail: detail,
        Status: status,
    }
}
```

**レスポンス例:**

```json
{
    "type": "about:blank",
    "title": "Not Found",
    "detail": "IMSI 440101234567890 not found",
    "status": 404
}
```

---

## 5. 構造体タグ

### 5.1 redis タグ

Valkey（Redis互換）へのハッシュ保存に使用。

| ルール | 説明 |
|--------|------|
| フィールド名はsnake_case | `redis:"field_name"` |
| キー自体はタグ対象外 | `redis:"-"` を指定 |
| 省略可能フィールド | `redis:"field_name,omitempty"` |

```go
type Subscriber struct {
    IMSI      string `redis:"-"`           // Valkeyキー（sub:{IMSI}）の一部
    Ki        string `redis:"ki"`
    OPc       string `redis:"opc"`
    AMF       string `redis:"amf"`
    SQN       string `redis:"sqn"`
    CreatedAt string `redis:"created_at"`
}

type EAPContext struct {
    IMSI                 string `redis:"imsi"`
    EAPType              uint8  `redis:"eap_type"`
    Stage                string `redis:"stage"`
    RAND                 string `redis:"rand"`
    AUTN                 string `redis:"autn"`
    XRES                 string `redis:"xres"`
    K_aut                string `redis:"k_aut"`
    MSK                  string `redis:"msk"`
    ResyncCount          int    `redis:"resync_count"`
    PermanentIDRequested bool   `redis:"permanent_id_requested"`
}
```

### 5.2 json タグ

HTTP API のリクエスト/レスポンスに使用。

| ルール | 説明 |
|--------|------|
| フィールド名はsnake_case | `json:"field_name"` |
| 省略可能フィールド | `json:"field_name,omitempty"` |
| 無視フィールド | `json:"-"` |

```go
// Vector API リクエスト
type VectorRequest struct {
    IMSI       string      `json:"imsi"`
    ResyncInfo *ResyncInfo `json:"resync_info,omitempty"`
}

type ResyncInfo struct {
    RAND string `json:"rand"`
    AUTS string `json:"auts"`
}

// Vector API レスポンス
type VectorResponse struct {
    RAND string `json:"rand"`
    AUTN string `json:"autn"`
    XRES string `json:"xres"`
    CK   string `json:"ck"`
    IK   string `json:"ik"`
}
```

### 5.3 envconfig タグ

環境変数読み込みに使用（kelseyhightower/envconfig）。

| ルール | 説明 |
|--------|------|
| 環境変数名を明示 | `envconfig:"VAR_NAME"` |
| デフォルト値 | `default:"value"` |
| 必須フィールド | `required:"true"` |
| 無視フィールド | `ignored:"true"` |

```go
type Config struct {
    // サーバー設定
    Port int `envconfig:"AUTH_SERVER_PORT" default:"1812"`
    
    // Valkey設定
    ValkeyAddr     string `envconfig:"VALKEY_ADDR" required:"true"`
    ValkeyPassword string `envconfig:"VALKEY_PASSWORD" default:""`
    ValkeyDB       int    `envconfig:"VALKEY_DB" default:"0"`
    
    // Vector Gateway設定
    VectorGatewayURL     string        `envconfig:"VECTOR_GATEWAY_URL" required:"true"`
    VectorGatewayTimeout time.Duration `envconfig:"VECTOR_GATEWAY_TIMEOUT" default:"5s"`
    
    // ログ設定
    LogLevel    string `envconfig:"LOG_LEVEL" default:"INFO"`
    LogMaskIMSI bool   `envconfig:"LOG_MASK_IMSI" default:"true"`
    
    // フォールバック設定
    DefaultSecret string `envconfig:"AUTH_SERVER_DEFAULT_SECRET" default:""`
    
    // パース済みデータ（環境変数からは読み込まない）
    parsedPLMNMap map[string]string `ignored:"true"`
}
```

### 5.4 複合タグ

複数の用途で使用するフィールドには複数タグを付与。

```go
type Session struct {
    IMSI          string `redis:"imsi" json:"imsi"`
    StartTime     int64  `redis:"start_time" json:"start_time"`
    NasIP         string `redis:"nas_ip" json:"nas_ip"`
    ClientIP      string `redis:"client_ip" json:"client_ip"`
    AcctSessionID string `redis:"acct_id" json:"acct_session_id"`
    InputOctets   int64  `redis:"input_octets" json:"input_octets"`
    OutputOctets  int64  `redis:"output_octets" json:"output_octets"`
}
```

---

## 6. インターフェース設計

### 6.1 定義の原則

| 原則 | 説明 |
|------|------|
| 利用側で定義 | 実装側ではなく、利用するパッケージで定義 |
| 最小メソッド | 必要なメソッドのみ定義（Interface Segregation） |
| 具体型より抽象 | 関数パラメータはインターフェースを優先 |

```go
// 良い例: 利用側（handler）で定義
// internal/handler/auth.go
type AuthUsecase interface {
    Authenticate(ctx context.Context, req *AuthRequest) (*AuthResult, error)
}

type AuthHandler struct {
    usecase AuthUsecase  // インターフェースに依存
}

// 悪い例: 実装側で定義し、利用側がそれをimport
// これは避ける（実装と利用が密結合になる）
```

### 6.2 命名規約

| パターン | 命名 | 例 |
|---------|------|-----|
| 単一メソッド | 動詞 + `er` | `Reader`, `Writer`, `Closer` |
| CRUD操作 | 名詞 + `Store` | `ContextStore`, `SessionStore` |
| 外部サービス | 名詞 + `Client` | `VectorClient`, `ValkeyClient` |
| 評価・判定 | 名詞 + `Evaluator` | `PolicyEvaluator` |
| 生成 | 名詞 + `Generator` | `UUIDGenerator` |

### 6.3 テスタビリティ考慮

インターフェースは `mockgen` 等のモック生成ツールとの互換性を考慮する。

```go
// internal/usecase/interfaces.go

//go:generate mockgen -source=interfaces.go -destination=mock_interfaces.go -package=usecase

type SubscriberRepository interface {
    Get(ctx context.Context, imsi string) (*Subscriber, error)
    Create(ctx context.Context, sub *Subscriber) error
    Update(ctx context.Context, sub *Subscriber) error
    Delete(ctx context.Context, imsi string) error
}

type VectorClient interface {
    GetVector(ctx context.Context, req *VectorRequest) (*VectorResponse, error)
}
```

### 6.4 プロジェクト標準インターフェース

本プロジェクトで使用する主要インターフェース（D-09準拠）。

```go
// session/interfaces.go
type ContextStore interface {
    Create(ctx context.Context, traceID string, eapCtx *EAPContext) error
    Get(ctx context.Context, traceID string) (*EAPContext, error)
    Update(ctx context.Context, traceID string, updates map[string]interface{}) error
    Delete(ctx context.Context, traceID string) error
}

type SessionStore interface {
    Create(ctx context.Context, sessionID string, sess *Session) error
    AddUserIndex(ctx context.Context, imsi string, sessionID string) error
}

// vector/interfaces.go
type VectorClient interface {
    GetVector(ctx context.Context, req *VectorRequest) (*VectorResponse, error)
}

// policy/interfaces.go
type PolicyStore interface {
    GetPolicy(ctx context.Context, imsi string) (*Policy, error)
}

// store/interfaces.go
type ClientStore interface {
    GetClientSecret(ctx context.Context, ip string) (string, error)
}
```

---

## 7. ログ出力

### 7.1 slog の使用

本プロジェクトでは Go 標準ライブラリの `log/slog` を使用する。

```go
import "log/slog"

// 基本的な使用
slog.Info("authentication succeeded",
    "event_id", "AUTH_SUCCESS",
    "trace_id", traceID,
    "imsi", maskedIMSI,
)

slog.Error("valkey connection failed",
    "event_id", "VALKEY_CONN_ERR",
    "error", err.Error(),
    "retry_count", retryCount,
)
```

### 7.2 ログレベル使い分け

| レベル | 用途 | 例 |
|--------|------|-----|
| DEBUG | 開発時のみ、詳細トレース | パケットダンプ、変数値 |
| INFO | 正常系イベント、重要マイルストーン | 認証成功、サーバー起動 |
| WARN | 継続可能な異常、非推奨操作 | リトライ発生、設定不備 |
| ERROR | 処理失敗、要調査イベント | 接続失敗、不正パケット |

```go
// DEBUG: 開発時のみ有効化
slog.Debug("received packet",
    "raw_hex", hex.EncodeToString(packet),
)

// INFO: 正常系イベント
slog.Info("server started",
    "event_id", "SERVER_START",
    "port", cfg.Port,
)

// WARN: 継続可能な異常
slog.Warn("circuit breaker opened",
    "event_id", "CB_OPEN",
    "cb_name", "vector-gateway",
    "failure_count", failureCount,
)

// ERROR: 処理失敗
slog.Error("authentication failed",
    "event_id", "AUTH_RES_MISMATCH",
    "trace_id", traceID,
    "imsi", maskedIMSI,
)
```

### 7.3 必須フィールド

全てのログ出力に以下のフィールドを含める（D-04準拠）。

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `event_id` | 必須 | イベント種別識別子（D-04で定義） |
| `trace_id` | 条件付き | リクエスト追跡ID（リクエスト処理中は必須） |
| `imsi` | 条件付き | 加入者識別子（マスキング済み、該当する場合） |
| `error` | 条件付き | エラーメッセージ（エラー発生時） |

```go
// リクエスト処理中のログ
slog.Info("EAP challenge sent",
    "event_id", "EAP_CHALLENGE_SENT",
    "trace_id", traceID,
    "imsi", maskIMSI(imsi),      // マスキング処理
    "eap_type", eapType,
)

// システムイベントのログ（trace_id不要）
slog.Info("valkey connection restored",
    "event_id", "VALKEY_CONN_RESTORED",
    "downtime_ms", downtimeMs,
)
```

### 7.4 IMSIマスキング

プライバシー保護のため、ログ出力時はIMSIをマスキングする（D-04, D-09準拠）。

```go
// internal/logging/imsi.go

func MaskIMSI(imsi string, enabled bool) string {
    if !enabled || len(imsi) < 10 {
        return imsi
    }
    // 先頭5桁（MCC+MNC）と末尾2桁を残し、中間をマスク
    // 例: 440101234567890 → 44010*******90
    return imsi[:5] + strings.Repeat("*", len(imsi)-7) + imsi[len(imsi)-2:]
}
```

---

## 8. コードフォーマット・静的解析

### 8.1 gofmt / goimports

| ツール | 用途 | 実行タイミング |
|--------|------|---------------|
| `gofmt` | コードフォーマット統一 | 保存時自動実行 |
| `goimports` | import文の整理 + gofmt | 保存時自動実行（推奨） |

**エディタ設定例（VS Code）:**

```json
{
    "editor.formatOnSave": true,
    "[go]": {
        "editor.defaultFormatter": "golang.go",
        "editor.codeActionsOnSave": {
            "source.organizeImports": true
        }
    }
}
```

### 8.2 go vet

標準の静的解析ツール。CI/コミット前に実行。

```bash
# 単一モジュール
go vet ./...

# Go Workspace全体
go vet ./apps/... ./pkg/...
```

### 8.3 推奨リンター設定（任意）

将来的にCIで追加の静的解析を行う場合の推奨設定。

| ツール | 用途 | 優先度 |
|--------|------|--------|
| `staticcheck` | 追加の静的解析 | 中 |
| `errcheck` | エラーチェック漏れ検出 | 中 |
| `golangci-lint` | 複合リンター | 低（PoC完了後検討） |

```bash
# staticcheck の実行例
staticcheck ./...
```

### 8.4 コミット前チェックリスト

コミット前に以下を確認する。

- [ ] `go fmt ./...` または `goimports` でフォーマット済み
- [ ] `go vet ./...` でエラーなし
- [ ] `go build ./...` でビルド成功
- [ ] `go test ./...` でテスト成功（テスト実装後）

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-01-25 | 初版作成。D-06, D-09, D-10, D-11, D-12等に散在する規約を集約・整理。 |
