# O-04 バックアップ・リストア手順書 (r1)

## 1. 概要

### 1.1 目的

本手順書は、EAP-AKA RADIUS PoC環境における**データバックアップおよびリストア**の手順を体系的にまとめたものである。Valkeyデータの保全・復旧と、設定ファイル群の手動バックアップ・復元を対象とする。

### 1.2 対象読者

- 運用担当者（日常的なバックアップ運用の確認・管理）
- インフラ担当者（リストア実施、設定ファイルの復元）

### 1.3 前提条件

- B-02に基づくデプロイが完了し、全サービスが正常稼働していること
- B-02 §9に基づくバックアップスクリプトの配置およびcrontab設定が完了していること
- ホストOSへのSSHアクセスが可能であること

### 1.4 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| D-08 インフラ設定・運用設計書 (r12) | Valkey永続化設定、バックアップ方針、リストア手順、バックアップスクリプト仕様 |
| B-02 アプリケーションデプロイ手順書 (r7) | バックアップスクリプト配置手順、crontab設定 |
| O-03 障害対応手順書 (r1) | Valkeyデータ復旧手順（障害対応観点） |

---

## 2. バックアップ方針

### 2.1 バックアップ対象

| 対象 | 内容 | 重要度 | バックアップ方式 |
|------|------|--------|----------------|
| Valkeyデータ | 加入者情報、SQN値、ポリシー、セッションデータ | **高** | 自動（日次スクリプト） |
| 環境変数ファイル（`.env`） | Valkeyパスワード、RADIUSシークレット等の認証情報 | **高** | 手動 |
| `docker-compose.yml` | サービス定義、ヘルスチェック設定 | 中 | リポジトリ管理（git） |
| Fluent Bit設定 | ログ収集設定 | 中 | リポジトリ管理（git） |
| logrotate設定 | ログローテーション設定 | 低 | 手動 |
| crontab設定 | バックアップスケジュール | 低 | 手動 |

> **注記:** `docker-compose.yml` やFluent Bit設定はリポジトリで管理されているため、`git pull` で復元可能である。ただし、`.env` ファイルはリポジトリ管理外のため、手動バックアップが必要。

### 2.2 バックアップ方式

| 方式 | 対象 | 実行方法 |
|------|------|---------|
| 自動バックアップ | Valkeyデータ | `backup_valkey.sh` スクリプトによるcron日次実行 |
| 手動バックアップ | Valkeyデータ | `backup_valkey.sh` スクリプトの手動実行 |
| 手動バックアップ | 設定ファイル群 | tarコマンドによるアーカイブ作成 |

### 2.3 スケジュールと保持期間

| 項目 | 設定値 | 備考 |
|------|-------|------|
| 自動バックアップ実行時刻 | 毎日 03:00 | crontab設定（B-02 §9.4） |
| バックアップ保持期間 | 7日間 | `RETENTION_DAYS=7`（D-08 §2.4） |
| バックアップログ出力先 | `~/logs/backup.log` | cron実行時の標準出力・標準エラー |

### 2.4 バックアップファイル仕様

| 項目 | 内容 |
|------|------|
| ファイル形式 | tar.gz（gzip圧縮） |
| ファイル名規則 | `backup_YYYYMMDD_HHMMSS.tar.gz` |
| 格納ディレクトリ | `~/backups/valkey/` |
| 内容 | Valkeyコンテナの`/data`ディレクトリ（AOFファイル含む） |

---

## 3. バックアップ手順

### 3.1 自動バックアップの確認

日次自動バックアップが正常に動作していることを確認する。

#### crontab登録の確認

```bash
crontab -l
```

以下のエントリが存在することを確認する。

```
0 3 * * * /home/admin/scripts/backup_valkey.sh >> /home/admin/logs/backup.log 2>&1
```

#### バックアップファイルの確認

```bash
# バックアップディレクトリの内容を確認（日付順）
ls -lt ~/backups/valkey/
```

直近のバックアップファイルが存在し、ファイルサイズが0でないことを確認する。

```bash
# 最新のバックアップファイルのサイズ確認
ls -lh ~/backups/valkey/ | head -5
```

#### バックアップログの確認

```bash
# バックアップログの末尾を確認
tail -20 ~/logs/backup.log
```

`Backup completed: backup_YYYYMMDD_HHMMSS.tar.gz` のメッセージが出力されていることを確認する。エラーが出力されている場合は§6.1を参照。

### 3.2 手動バックアップの実行

リストア作業前や設定変更前など、任意のタイミングでバックアップを取得する場合の手順。

```bash
# バックアップスクリプトの実行
~/scripts/backup_valkey.sh
```

実行結果を確認する。

```bash
# バックアップファイルの生成確認
ls -lt ~/backups/valkey/ | head -3
```

> **注意:** バックアップスクリプトはValkeyコンテナが稼働中に実行すること。コンテナ停止中は `docker compose exec` が失敗する。

### 3.3 バックアップの検証

バックアップファイルが正常に作成されたことを検証する。

```bash
# tar.gzファイルの整合性チェック
tar tzf ~/backups/valkey/backup_YYYYMMDD_HHMMSS.tar.gz > /dev/null
echo $?
# 期待される出力: 0（正常）
```

```bash
# バックアップファイルの内容一覧を確認
tar tzf ~/backups/valkey/backup_YYYYMMDD_HHMMSS.tar.gz
```

`data/appendonlydir/` 配下にAOFファイルが含まれていることを確認する。

---

## 4. リストア手順

### 4.1 リストア前の確認事項

リストアを実施する前に、以下を確認する。

| 確認項目 | 確認方法 | 備考 |
|---------|---------|------|
| リストア対象のバックアップファイル | `ls -lt ~/backups/valkey/` | 最新または指定日時のファイルを選択 |
| バックアップファイルの整合性 | `tar tzf <ファイル> > /dev/null` | 終了コード0であること |
| 現在のValkeyデータ件数 | `docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" dbsize` | リストア前後の比較用 |
| 利用者への影響 | — | リストア中は全サービスが停止する |

> **警告:** リストアを実行すると、現在のValkeyデータは**すべて削除**される。リストア前に現在のデータのバックアップを取得すること（§3.2参照）。

### 4.2 リストア実行手順（6ステップ）

D-08 §2.4に基づくリストア手順。各ステップで確認ポイントを記載する。

#### ステップ1: コンテナ停止

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose stop valkey
```

**確認:** Valkeyコンテナが停止していることを確認する。

```bash
docker compose ps valkey
# STATUSが "Exited" であること
```

> **注意:** `docker compose stop valkey` はValkeyコンテナのみを停止する。他のサービスはValkey接続エラーとなるが、Valkey復旧後に自動回復する。全サービスを停止する場合は `docker compose down` を使用する（ただしコンテナが削除される）。

#### ステップ2: 既存データ削除

```bash
# Valkeyデータボリュームを削除
docker volume rm eapaka-radius-server-poc_valkey_data
```

**確認:** ボリュームが削除されたことを確認する。

```bash
docker volume ls | grep valkey_data
# 出力がないこと
```

> **注意:** ボリューム名はプロジェクト名（ディレクトリ名）に依存する。`docker volume ls` で実際のボリューム名を確認すること。

#### ステップ3: ボリューム再作成

```bash
docker volume create eapaka-radius-server-poc_valkey_data
```

**確認:** ボリュームが作成されたことを確認する。

```bash
docker volume ls | grep valkey_data
# eapaka-radius-server-poc_valkey_data が表示されること
```

#### ステップ4: バックアップからリストア

```bash
# バックアップファイルからデータを復元
docker run --rm \
  -v eapaka-radius-server-poc_valkey_data:/data \
  -v ~/backups/valkey:/backup \
  alpine \
  sh -c 'cd /data && tar xzf /backup/backup_YYYYMMDD_HHMMSS.tar.gz --strip-components=1'
```

> **注意:** `backup_YYYYMMDD_HHMMSS.tar.gz` は実際のバックアップファイル名に置き換えること。利用可能なファイルは `ls ~/backups/valkey/` で確認できる。

**確認:** データが復元されたことを確認する。

```bash
docker run --rm \
  -v eapaka-radius-server-poc_valkey_data:/data \
  alpine \
  ls -la /data/
# appendonlydir/ が存在すること
```

#### ステップ5: コンテナ起動

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose start valkey
```

**確認:** Valkeyコンテナが正常に起動したことを確認する。

```bash
# ヘルスチェックが完了するまで待機
sleep 10

docker compose ps valkey
# STATUSが "Up (healthy)" であること
```

#### ステップ6: データ確認

```bash
cd ~/eapaka-radius-server-poc/deployments

# Valkey接続確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" ping
# 期待される出力: PONG

# データ件数確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" dbsize
# リストア対象時点のデータ件数と一致すること

# メモリ使用量確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" info memory | grep used_memory_human
```

### 4.3 リストア後の確認

リストア完了後、以下の項目を確認する。

```bash
cd ~/eapaka-radius-server-poc/deployments

# 全コンテナの状態確認
docker compose ps
# 全サービスが "Up (healthy)" であること

# 認証動作確認（Valkey接続）
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" ping
# 期待される出力: PONG

# 加入者データの存在確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" keys "subscriber:*" | head -5

# ポリシーデータの存在確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" keys "policy:*" | head -5
```

> **注記:** 他のサービスがValkey接続エラーで不安定な場合は、全サービスを再起動する。

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose restart
sleep 30
docker compose ps
```

---

## 5. 設定ファイルのバックアップと復元

### 5.1 対象ファイル一覧

| ファイル | パス | 重要度 | 備考 |
|---------|------|--------|------|
| 環境変数ファイル | `~/eapaka-radius-server-poc/deployments/.env` | **高** | 認証情報含む、リポジトリ管理外 |
| logrotate設定 | `/etc/logrotate.d/eapaka-radius-server-poc` | 低 | root権限で管理 |
| crontab設定 | `crontab -l` の出力 | 低 | ユーザー別 |
| systemdサービスファイル | `/etc/systemd/system/eapaka-radius-server-poc.service` | 低 | root権限で管理 |

> **注記:** `docker-compose.yml`、Fluent Bit設定（`configs/fluent-bit/fluent-bit.yaml`）、lnavフォーマット定義はリポジトリ管理されているため、`git pull` で復元可能。手動バックアップの対象外とする。

### 5.2 手動バックアップ手順

設定ファイル群を一括でバックアップする。

```bash
# バックアップ用ディレクトリ作成
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=~/backups/config_${TIMESTAMP}
mkdir -p "${BACKUP_DIR}"

# .envファイルのバックアップ
cp ~/eapaka-radius-server-poc/deployments/.env "${BACKUP_DIR}/"

# logrotate設定のバックアップ
sudo cp /etc/logrotate.d/eapaka-radius-server-poc "${BACKUP_DIR}/"

# crontab設定のバックアップ
crontab -l > "${BACKUP_DIR}/crontab.txt"

# systemdサービスファイルのバックアップ
sudo cp /etc/systemd/system/eapaka-radius-server-poc.service "${BACKUP_DIR}/"

# バックアップ内容の確認
ls -la "${BACKUP_DIR}/"
```

> **注意:** `.env` ファイルには認証情報が含まれるため、バックアップファイルのパーミッションに注意すること。

```bash
chmod 600 "${BACKUP_DIR}/.env"
```

### 5.3 復元手順

設定ファイル群をバックアップから復元する。

```bash
# バックアップディレクトリの指定（実際の日時に置き換えること）
BACKUP_DIR=~/backups/config_YYYYMMDD_HHMMSS

# .envファイルの復元
cp "${BACKUP_DIR}/.env" ~/eapaka-radius-server-poc/deployments/.env
chmod 600 ~/eapaka-radius-server-poc/deployments/.env

# logrotate設定の復元
sudo cp "${BACKUP_DIR}/eapaka-radius-server-poc" /etc/logrotate.d/

# crontab設定の復元
crontab "${BACKUP_DIR}/crontab.txt"

# systemdサービスファイルの復元
sudo cp "${BACKUP_DIR}/eapaka-radius-server-poc.service" /etc/systemd/system/
sudo systemctl daemon-reload
```

復元後の確認:

```bash
# .envファイルのパーミッション確認
ls -la ~/eapaka-radius-server-poc/deployments/.env
# -rw------- であること

# logrotate設定の検証
sudo logrotate -d /etc/logrotate.d/eapaka-radius-server-poc
# エラーがないこと

# crontab設定の確認
crontab -l
# バックアップジョブが登録されていること

# systemdサービスの確認
sudo systemctl is-enabled eapaka-radius-server-poc
# enabled であること
```

---

## 6. トラブルシューティング

### 6.1 バックアップ失敗時の対処

**症状:** `~/logs/backup.log` にエラーが出力される、またはバックアップファイルが生成されない。

**確認手順:**

```bash
# バックアップログの確認
tail -30 ~/logs/backup.log

# Valkeyコンテナの状態確認
cd ~/eapaka-radius-server-poc/deployments
docker compose ps valkey
```

**主な原因と対処:**

| 原因 | エラーメッセージ例 | 対処 |
|------|------------------|------|
| Valkeyコンテナが停止している | `no such service` / `is not running` | `docker compose up -d valkey` でValkey起動後にバックアップを再実行 |
| ディスク容量不足 | `No space left on device` | §6.3の手順でディスク容量を確保後、再実行 |
| スクリプトの実行権限なし | `Permission denied` | `chmod +x ~/scripts/backup_valkey.sh` |
| バックアップディレクトリが存在しない | ディレクトリ関連のエラー | `mkdir -p ~/backups/valkey ~/logs` |

### 6.2 リストア失敗時の対処

**症状:** リストア後にValkeyが起動しない、またはデータが正しく復元されない。

**確認手順:**

```bash
# Valkeyのログ確認
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 50 valkey

# ボリューム内容の確認
docker run --rm \
  -v eapaka-radius-server-poc_valkey_data:/data \
  alpine \
  ls -la /data/
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| バックアップファイルが破損している | `tar tzf <ファイル> > /dev/null` で整合性を確認。別のバックアップファイルを使用 |
| ボリューム名が異なる | `docker volume ls` で実際のボリューム名を確認し、正しいボリューム名で再実行 |
| AOFファイルの互換性問題 | Valkeyログを確認。`valkey-check-aof --fix` での修復を試行（O-03 §4.1.4参照） |
| tar展開時のパス不整合 | `--strip-components` の値を調整。バックアップ内容を `tar tzf` で確認してパス構造を把握 |

**リストアが完全に失敗した場合の代替手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments

# 全サービス停止
docker compose down

# ボリュームを削除して再作成
docker volume rm eapaka-radius-server-poc_valkey_data
docker volume create eapaka-radius-server-poc_valkey_data

# 全サービスを起動（空のValkeyで起動）
docker compose up -d

# Admin TUIで加入者・ポリシーを再登録
```

> **注意:** 空のValkeyで起動した場合、加入者データ・ポリシーデータが失われる。Admin TUIのインポート機能（O-01参照）でデータを再投入する必要がある。

### 6.3 ディスク容量不足時の対処

**症状:** バックアップ失敗、ログ肥大化、Valkeyの書き込みエラー等。

**確認手順:**

```bash
# ホスト全体のディスク使用状況
df -h

# Docker関連の使用状況
docker system df -v

# バックアップファイルの容量
du -sh ~/backups/valkey/

# ログファイルの容量
du -sh ~/eapaka-radius-server-poc/deployments/logs_on_host/*
```

**対処手順:**

```bash
# 1. 保持期間を超えたバックアップの手動削除
find ~/backups/valkey/ -name "backup_*.tar.gz" -mtime +7 -delete

# 2. 古いログファイルの削除（30日超過分）
find ~/eapaka-radius-server-poc/deployments/logs_on_host/ -name "*.log-*" -mtime +30 -delete

# 3. Docker不要リソースの削除
docker system prune -af

# 4. 削除後の容量確認
df -h
```

---

## 7. 運用チェックリスト

### 7.1 日次確認項目

日常運用で確認すべきバックアップ関連の項目。

| # | 確認項目 | 確認コマンド | 期待値 |
|---|---------|-------------|-------|
| 1 | 最新バックアップの存在 | `ls -lt ~/backups/valkey/ \| head -2` | 当日分のバックアップファイルが存在 |
| 2 | バックアップファイルサイズ | `ls -lh ~/backups/valkey/ \| head -2` | 0バイトでないこと |
| 3 | バックアップログにエラーなし | `tail -5 ~/logs/backup.log` | `Backup completed` メッセージ |
| 4 | ディスク使用率 | `df -h /` | 使用率80%未満 |
| 5 | バックアップ保持数 | `ls ~/backups/valkey/ \| wc -l` | 7件以下（保持期間7日） |

### 7.2 リストア完了確認項目

リストア実施後に確認すべき項目。

| # | 確認項目 | 確認コマンド | 期待値 |
|---|---------|-------------|-------|
| 1 | Valkeyコンテナ状態 | `docker compose ps valkey` | Up (healthy) |
| 2 | Valkey接続 | `docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" ping` | PONG |
| 3 | データ件数 | `docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" dbsize` | バックアップ時点の件数と一致 |
| 4 | 加入者データ | `docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" keys "subscriber:*" \| wc -l` | 0件でないこと |
| 5 | 全コンテナ状態 | `docker compose ps` | 全サービスUp (healthy) |
| 6 | 認証テスト | 認証リクエストの送信・成功確認 | Access-Accept応答 |

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-02-28 | 初版作成。バックアップ方針、バックアップ手順（自動・手動）、リストア手順（6ステップ）、設定ファイルのバックアップと復元、トラブルシューティング、運用チェックリストを体系化。 |
