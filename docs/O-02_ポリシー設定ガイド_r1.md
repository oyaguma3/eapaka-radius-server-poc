# O-02 ポリシー設定ガイド (r1)

## 1. 概要

### 1.1 目的

本ドキュメントは、EAP-AKA/AKA' RADIUS PoC環境における認可ポリシーの設計思想と具体的な設定手順を説明する実務ガイドである。認証成功後のアクセス制御（どのNAS・SSIDからの接続を許可するか、VLAN割り当て、セッションタイムアウト設定）について、ポリシー評価の仕組みからフォーム操作、設定パターン、トラブルシューティングまでを網羅する。

### 1.2 対象読者

- 運用担当者
- E2Eテスト実施者

### 1.3 前提条件

- Admin TUI操作の基本を理解済みであること（O-01 操作ガイド参照）
- 加入者データ（subscriber）が登録済みであること
- B-02（アプリケーションデプロイ手順書）の手順に従いデプロイ済みであること

### 1.4 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| D-05 Admin TUI詳細設計書・前半 (r9) | ポリシーフォーム仕様（§4.4）、Default allow 警告ダイアログ（§3.5） |
| D-02 Valkey データ設計仕様書 (r10) | policy:{IMSI} のデータ構造（§C） |
| O-01 操作ガイド (r1) | 画面遷移の基本操作（§5）、CSVインポート（§6.1）、キーバインド（§8.1） |
| O-05 ログ解析ガイド (r3) | ポリシー関連 event_id によるログ調査 |

---

## 2. ポリシー評価の仕組み

### 2.1 評価フロー概要

認証成功後（Post-Auth）にAuth Serverが実行するポリシー評価の流れを示す。

```
認証成功 (EAP-AKA/AKA' Success)
    │
    ▼
policy:{IMSI} を Valkey から取得
    │
    ├─ 取得失敗 ──────────────────────────── Access-Reject
    │                                        (AUTH_POLICY_NOT_FOUND)
    ▼
ルール配列を先頭から順次評価
    │
    ├─ ルール[0]: NAS-ID一致? ─ No ── 次のルールへ
    │                          Yes
    │                           └─ SSID一致? ─ No ── 次のルールへ
    │                                          Yes
    │                                           └─ Access-Accept ★
    │                                              (VLAN/Timeout付加)
    ├─ ルール[1]: (同様に評価)
    │    :
    ├─ ルール[N]: (同様に評価)
    │
    ▼
全ルール不一致 → Default Action で判定
    │
    ├─ Default = "allow" ── Access-Accept（ルール付加なし）
    │
    └─ Default = "deny" ─── Access-Reject
                             (AUTH_POLICY_DENIED)
```

### 2.2 NAS-IDマッチング

ポリシールールの `NAS ID` フィールドと、RADIUSリクエスト中の NAS-Identifier 属性を**完全一致**で比較する。

- **大文字・小文字を区別する**（`Customer01` と `customer01` は一致しない）
- ワイルドカードは使用不可（NAS-IDレベルでは個別指定が必要）
- NAS-Identifier属性はNAS機器の設定に依存するため、実際のRADIUSリクエストで送信される値を確認すること

### 2.3 SSIDマッチング

RADIUSリクエスト中の Called-Station-Id 属性からSSID部分を抽出し、ルールの `Allowed SSIDs` リストと比較する。

**SSID抽出の仕組み:**

Called-Station-Id は通常 `MACアドレス:SSID名` の形式で送信される。Auth Serverはコロン（`:`）以降をSSID名として抽出する。

| Called-Station-Id の値 | 抽出されるSSID |
|------------------------|---------------|
| `00-11-22-33-44-55:MyWiFi` | `MyWiFi` |
| `AA-BB-CC-DD-EE-FF:CORP-WIFI` | `CORP-WIFI` |
| `SimpleSSID` | `SimpleSSID`（コロンなしの場合は全体） |

**マッチング規則:**

- **大文字・小文字を区別しない**（`CORP-WIFI` と `corp-wifi` は一致する）
- **ワイルドカード `*`**: Allowed SSIDs に `*` が含まれていれば、すべてのSSIDに一致する
- 複数SSIDが指定されている場合、いずれか1つに一致すれば許可される

### 2.4 Default Action の動作

全ルールが不一致だった場合に適用されるアクションを指定する。

| Default Action | 動作 | 用途 |
|---------------|------|------|
| `deny`（推奨） | Access-Reject を返す。明示的にルールで許可されたNAS・SSIDの組み合わせのみ接続可能 | 本番環境・セキュリティ重視の運用 |
| `allow` | Access-Accept を返す（ルール付加情報なし）。ルールに一致しなくてもすべて許可される | テスト環境・一時的な運用 |

> **注意:** Default を `allow` に設定して保存する場合、Admin TUI上で警告ダイアログが表示される（§3.6参照）。

### 2.5 ルール一致時の動作

ルールに一致した場合、常に **Access-Accept**（接続許可）となる。加えて、ルールに設定された以下の値がRADIUS Accept応答に付加される。

| ルールフィールド | RADIUS属性 | 備考 |
|----------------|-----------|------|
| VLAN ID | Tunnel-Private-Group-Id 等 | 空の場合は付加しない |
| Session Timeout | Session-Timeout | 0 の場合は付加しない（NASデフォルト適用） |

### 2.6 ポリシー未設定の場合

IMSI に対応するポリシー（`policy:{IMSI}`）が Valkey に登録されていない場合、**一律 Access-Reject** となる。

- Auth Serverログに `AUTH_POLICY_NOT_FOUND` イベントが記録される
- Admin TUIの加入者一覧画面では、ポリシー未設定の加入者は行頭に `!` マークが付き、Yellow/Orange色で強調表示される（O-01 §3.1参照）

加入者を登録した後は、必ず対応するポリシーも登録すること。

---

## 3. ポリシー設定の操作手順

Admin TUIでのポリシー設定操作を説明する。メインメニューからの画面遷移や一覧画面の基本操作（キーバインド等）は O-01 §5 および §8.1 を参照のこと。

### 3.1 ポリシー一覧画面

メインメニューで `3` キーを押すと、ポリシー一覧画面に遷移する。

```
┌ Authorization Policy List 1-9 of 9 (Page 1/1) ─────────────────────────┐
│ IMSI              Default   Rules                                        │
│ 001010000000000   allow     No rules                                     │
│ 001010000000001   allow     No rules                                     │
│ 001010000000002   deny      No rules                                     │
│ 001010000000003   deny      1 rule                                       │
│ 001010000000004   deny      2 rules                                      │
│  :                :         :                                            │
└──────────────────────────────────────────────────────────────────────────┘
```

**カラム説明:**

| カラム | 内容 |
|--------|------|
| IMSI | 加入者のIMSI（15桁） |
| Default | デフォルトアクション。`allow` = Yellow/Orange色、`deny` = Green色で表示 |
| Rules | ルール数。`No rules` / `1 rule` / `N rules` 形式で表示 |

**キーバインド:** 一覧画面共通キー（O-01 §8.1参照）。`F2`/`n` で新規作成、`Enter`/`F3`/`e` で編集、`F4`/`d` で削除。

### 3.2 ポリシー新規作成

一覧画面で `F2` または `n` キーを押すと、ポリシー詳細フォームが新規作成モードで表示される。

```
┌ Policy Details ──────────────────────────────────────────────────────┐
│                                                                      │
│  IMSI             [                    ]                              │
│  Default Action   [deny ▼]                                          │
│                                                                      │
│  < Add Rule >  < Save >  < Cancel >                                 │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
┌ Rules ───────────────────────────────────────────────────────────────┐
│ (No rules defined)                                                    │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

**入力項目:**

| フィールド | 必須 | 説明 |
|-----------|------|------|
| IMSI | Yes | 15桁のIMSI。登録済み加入者のIMSIを入力する |
| Default Action | Yes | ドロップダウンから `deny`（推奨）または `allow` を選択 |

> **推奨:** まずDefault Actionを `deny` に設定し、その後ルールを追加して必要なNAS・SSIDのみ許可する構成が安全である。

### 3.3 ルールの追加

フォーム上の `Add Rule` ボタンを押すと、ルール編集ダイアログが表示される。

```
┌ Edit Rule ───────────────────────────────────────────┐
│                                                        │
│  NAS ID          [                                  ]  │
│  Allowed SSIDs   [                                  ]  │
│  VLAN ID         [          ]                          │
│  Session Timeout [          ]                          │
│                                                        │
│       < OK >  < Cancel >                               │
│                                                        │
└────────────────────────────────────────────────────────┘
```

**入力項目:**

| フィールド | 必須 | 入力例 | 説明 |
|-----------|------|--------|------|
| NAS ID | Yes | `Customer01` | NAS識別子。NAS機器のNAS-Identifier属性値と完全一致させる |
| Allowed SSIDs | Yes | `CORP-WIFI,GUEST` | 許可するSSID。カンマ区切りで複数指定可。`*` で全SSID許可 |
| VLAN ID | No | `10` | VLAN ID。空の場合はVLAN割り当てなし |
| Session Timeout | No | `7200` | セッションタイムアウト（秒）。空または `0` で未設定（NASデフォルト適用） |

入力完了後、`OK` ボタンでルールが追加される。

### 3.4 ルールの編集・削除

ルールリストで既存のルールを選択（`Enter` またはマウスクリック）すると、ルール編集ダイアログが表示される。編集時はボタンが3つになる。

```
┌ Edit Rule ───────────────────────────────────────────┐
│                                                        │
│  NAS ID          [Customer01                        ]  │
│  Allowed SSIDs   [TESTSSID-01,TESTSSID-02           ]  │
│  VLAN ID         [10        ]                          │
│  Session Timeout [7200      ]                          │
│                                                        │
│       < OK >  < Delete >  < Cancel >                   │
│                                                        │
└────────────────────────────────────────────────────────┘
```

| ボタン | 動作 |
|--------|------|
| OK | 編集内容を反映してダイアログを閉じる |
| Delete | ルールを削除してダイアログを閉じる |
| Cancel | 変更を破棄してダイアログを閉じる |

### 3.5 フォーカス切替

ポリシー詳細フォームは上部のフォーム領域と下部のルールリスト領域に分かれている。`F6` キーで両領域間のフォーカスを切り替える。

| キー | 動作 |
|------|------|
| `F6` | フォーム ↔ ルールリスト間のフォーカス切替 |
| `Esc` / `Tab` | ルールリストからフォームへ戻る |

ルールリストにフォーカスがある状態で `Enter` を押すと、選択中のルールの編集ダイアログが開く。

### 3.6 保存時の挙動

`Save` ボタン（または `Ctrl+S`）を押すと、以下の処理が実行される。

1. **バリデーション**: IMSI、Default Action、各ルールの入力値を検証（§3.7参照）
2. **Default allow 警告**: Default Action が `allow` の場合、警告ダイアログが表示される

```
┌─────────────────────────────────────────────────────────┐
│  Warning: Setting Default to "allow"                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  When Default is "allow", authentication will succeed   │
│  for any SSID not explicitly listed in rules, as long   │
│  as the subscriber's credentials (Ki/OPc) are valid.    │
│                                                         │
│  This may allow unintended network access.              │
│                                                         │
│  Are you sure you want to save with Default = "allow"?  │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  [Save Anyway]                              [Cancel]    │
└─────────────────────────────────────────────────────────┘
```

3. **保存**: Valkeyへの書き込みが成功すると、ステータスバーに `Policy created: {IMSI}` または `Policy updated: {IMSI}` と表示される

### 3.7 バリデーション規則

フォーム保存時およびCSVインポート時に適用されるバリデーション規則を示す。

| フィールド | 規則 |
|-----------|------|
| IMSI | 15桁の数字（必須） |
| Default Action | `allow` または `deny`（必須） |
| NAS ID | 1〜64文字（必須。空文字不可） |
| Allowed SSIDs | 1文字以上の文字列（必須。カンマ区切りで複数指定可） |
| VLAN ID | 空文字（未設定）または数値文字列 |
| Session Timeout | 空文字（未設定）または0以上の整数 |

バリデーションエラー時は、ステータスバーにエラー内容が表示され、保存は実行されない。

---

## 4. 設定パターンと具体例

### 4.1 基本パターン: 特定NAS・SSIDのみ許可（Default deny）

最も一般的かつ安全な設定パターン。指定したNAS・SSIDの組み合わせのみ接続を許可し、それ以外はすべて拒否する。

| フィールド | 設定値 |
|-----------|--------|
| IMSI | `001010000000003` |
| Default Action | `deny` |
| ルール[1] NAS ID | `Customer01` |
| ルール[1] Allowed SSIDs | `TESTSSID-01` |
| ルール[1] VLAN ID | `10` |
| ルール[1] Session Timeout | `7200` |

**動作:**
- NAS-ID=`Customer01`、SSID=`TESTSSID-01` → Access-Accept（VLAN=10, Timeout=7200s）
- NAS-ID=`Customer01`、SSID=`OTHER-SSID` → Access-Reject（SSID不一致）
- NAS-ID=`OtherNAS`、SSID=`TESTSSID-01` → Access-Reject（NAS-ID不一致）

### 4.2 複数SSID許可

Allowed SSIDs にカンマ区切りで複数のSSIDを指定する。

| フィールド | 設定値 |
|-----------|--------|
| ルール NAS ID | `Customer01` |
| ルール Allowed SSIDs | `CORP-WIFI,GUEST` |

**動作:**
- SSID=`CORP-WIFI` → 一致（大文字小文字区別なし。`corp-wifi` でも一致する）
- SSID=`GUEST` → 一致
- SSID=`OTHER` → 不一致

### 4.3 VLAN割り当て

VLAN ID フィールドに値を設定すると、ルール一致時のRADIUS Accept応答にVLAN関連属性が付加される。

| フィールド | 設定値 | 説明 |
|-----------|--------|------|
| VLAN ID | `10` | VLAN 10 に割り当て |
| VLAN ID | （空） | VLAN割り当てなし（NASデフォルト） |

> **注意:** VLAN割り当てが実際に機能するには、NAS側でVLAN対応の設定が必要である。Default Action による Accept時（ルール不一致時）はルール付加情報がないため、VLANは付加されない。

### 4.4 セッションタイムアウト設定

Session Timeout に秒数を設定すると、ルール一致時のRADIUS Accept応答にSession-Timeout属性が付加される。

| 設定値 | 動作 |
|--------|------|
| `7200` | 7200秒（2時間）後にセッション切断 |
| `3600` | 3600秒（1時間）後にセッション切断 |
| `0` または空 | 未設定（NASのデフォルトタイムアウトが適用される） |

### 4.5 全NAS許可（Default allow + ルールなし）

テスト環境向けの簡易設定。ルールを定義せず、Default を `allow` にすることで、すべてのNAS・SSIDからの接続を許可する。

| フィールド | 設定値 |
|-----------|--------|
| Default Action | `allow` |
| ルール | なし |

> **注意:** この設定は認証情報（Ki/OPc）が正しければすべての接続を許可するため、本番環境では推奨しない。テスト環境でのみ使用すること。保存時に警告ダイアログが表示される（§3.6参照）。

### 4.6 複数ルール設定

複数のルールを定義することで、NAS・SSIDの組み合わせごとに異なるVLAN/Timeoutを割り当てられる。

**ルール評価順序の重要性:** ルールは配列の先頭（ルール[1]）から順に評価され、**最初に一致したルールが適用される**。それ以降のルールは評価されない。

**設定例:**

```
┌ Rules ───────────────────────────────────────────────────────────────┐
│ [1] NAS: Customer01                                                   │
│ SSIDs: TESTSSID-01, TESTSSID-02 | VLAN: 10 | Timeout: 7200s          │
│ [2] NAS: Customer02                                                   │
│ SSIDs: Guest | VLAN: 20 | Timeout: 1800s                             │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

| 条件 | 一致ルール | 結果 |
|------|-----------|------|
| NAS=`Customer01`, SSID=`TESTSSID-01` | ルール[1] | Accept（VLAN=10, Timeout=7200s） |
| NAS=`Customer01`, SSID=`TESTSSID-02` | ルール[1] | Accept（VLAN=10, Timeout=7200s） |
| NAS=`Customer02`, SSID=`Guest` | ルール[2] | Accept（VLAN=20, Timeout=1800s） |
| NAS=`Customer02`, SSID=`TESTSSID-01` | なし | Default Action に従う |

---

## 5. CSVによる一括設定

大量のポリシーを一括で登録する場合は、CSVインポート機能を使用する。インポート操作の詳細手順は O-01 §6.1 を参照のこと。

### 5.1 ポリシーCSVフォーマット

**ヘッダー行:**

```csv
imsi,default,rules_json
```

| カラム | 必須 | 説明 |
|--------|------|------|
| `imsi` | Yes | 15桁の数字（加入者IMSI） |
| `default` | Yes | デフォルトアクション（`allow` または `deny`） |
| `rules_json` | Yes | ルール配列のJSON文字列。ルールなしの場合は `[]` |

### 5.2 CSVサンプル

```csv
imsi,default,rules_json
001010000000003,deny,"[{""nas_id"":""Customer01"",""allowed_ssids"":[""TESTSSID-01"",""TESTSSID-02""],""vlan_id"":""10"",""session_timeout"":7200}]"
001010000000004,deny,"[{""nas_id"":""Customer01"",""allowed_ssids"":[""CORP-WIFI""],""vlan_id"":""10"",""session_timeout"":3600},{""nas_id"":""Customer02"",""allowed_ssids"":[""Guest""],""vlan_id"":""20"",""session_timeout"":1800}]"
001010000000005,allow,[]
```

**各行の説明:**

| 行 | パターン | 説明 |
|----|---------|------|
| 1行目 | deny + 1ルール | NAS=Customer01、SSID=TESTSSID-01/02 のみ許可 |
| 2行目 | deny + 2ルール | 2つのNAS・SSID組み合わせを許可 |
| 3行目 | allow + ルールなし | すべての接続を許可（テスト用） |

### 5.3 rules_json の構造

`rules_json` カラムはPolicyRuleオブジェクトのJSON配列である。CSV内ではダブルクォートを `""` でエスケープする。

**PolicyRule オブジェクト:**

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `nas_id` | string | Yes | NAS識別子 |
| `allowed_ssids` | string[] | Yes | 許可SSIDの配列 |
| `vlan_id` | string | No | VLAN ID（省略時は空文字） |
| `session_timeout` | number | No | セッションタイムアウト秒（省略時は0） |

**JSON例（整形表示）:**

```json
[
  {
    "nas_id": "Customer01",
    "allowed_ssids": ["CORP-WIFI", "GUEST"],
    "vlan_id": "10",
    "session_timeout": 7200
  }
]
```

### 5.4 インポート手順

CSVインポートの操作手順は O-01 §6.1 を参照のこと。ポリシーインポート固有の注意点を以下に示す。

- **Data Type** ドロップダウンで `Policies` を選択する
- 既存のIMSIに対するポリシーが存在する場合、**上書き**される
- バリデーション（Phase 1）では、CSV全行のIMSI形式・Default値・rules_json のJSON構文とフィールド検証が実行される
- バリデーションエラーは行番号付きで表示される（例: `line 3: invalid IMSI format`）

---

## 6. トラブルシューティング

### 6.1 認証成功後にネットワーク接続が拒否される

**症状:** EAP-AKA/AKA'認証自体は成功するが、RADIUS応答がAccess-Rejectとなりネットワーク接続できない。

**原因と対処:**

| 原因 | ログ event_id | 対処 |
|------|--------------|------|
| ポリシーが未設定 | `AUTH_POLICY_NOT_FOUND` | 該当IMSIのポリシーを作成する。加入者一覧で `!` マーク付きの行を確認（O-01 §3.1） |
| ルール不一致かつDefault=deny | `AUTH_POLICY_DENIED` | ルールのNAS ID・Allowed SSIDsを確認し、接続元のNAS・SSIDと一致するよう修正する |

### 6.2 意図しないSSIDからの接続が許可される

**症状:** 許可していないはずのSSIDからの接続が成功する。

**確認ポイント:**

1. **Default Action の確認**: Default が `allow` になっていないか確認する。`allow` の場合、ルールに一致しないすべての接続が許可される
2. **ワイルドカード `*` の確認**: Allowed SSIDs に `*` が設定されているルールがないか確認する。`*` はすべてのSSIDに一致する
3. **ルール評価順序の確認**: 複数ルールがある場合、先頭のルールが意図せず広範囲に一致していないか確認する

### 6.3 NAS-IDが一致しない

**症状:** 正しいSSIDなのにルール不一致となる。

**確認ポイント:**

1. **大文字・小文字の確認**: NAS-IDは完全一致（大文字・小文字区別あり）。ルールの NAS ID 値と、NAS機器が送信するNAS-Identifier属性値が一文字も違わず一致していることを確認する
2. **NAS設定の確認**: NAS機器のRADIUS設定で、NAS-Identifier属性がどのような値で送信されるか確認する
3. **ログでの確認**: Auth Serverのログで受信したNAS-Identifier値を確認する

### 6.4 VLAN割り当てが反映されない

**症状:** ルールにVLAN IDを設定したが、接続時にVLAN割り当てが行われない。

**確認ポイント:**

1. **ルール一致の確認**: ルールが実際に一致しているか確認する。Default Action による Accept の場合はルール付加情報（VLAN含む）が付加されない
2. **NAS側のVLAN対応**: NAS機器がRADIUS応答のVLAN属性に対応しているか確認する
3. **VLAN IDの値**: ルールのVLAN ID が空でないことを確認する。空の場合はVLAN属性が付加されない

### 6.5 ログでの確認方法

ポリシー関連の問題を調査する際は、Auth Serverのログで以下の event_id を確認する。ログの詳細な検索方法は O-05 §5.1 を参照のこと。

| event_id | Level | 意味 |
|----------|-------|------|
| `AUTH_POLICY_NOT_FOUND` | INFO | 該当IMSIのポリシーが未設定 |
| `AUTH_POLICY_DENIED` | INFO | ポリシールールに不一致（Default=deny） |

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-02-27 | 初版作成 |
