# D-04 ログ仕様設計書 (r13)

## 1. ログアーキテクチャ概要

- **生成:** Go標準ライブラリ `log/slog` による構造化ログ (JSON) 出力。
- **収集:** コンテナ標準出力 (stdout) を Docker Log Driver (fluentd) がキャプチャ。
- **集約:** Fluent Bit がタグ付けしてホストOS上のファイルへ転送。
- **解析:** ホストOS上の **`lnav`** を用いて、フィルタリング・SQL分析・監視を行う。

## 2. 共通仕様 (Common Schema)

全てのノードは以下のフィールドを必ず含む JSON 形式で出力する。

| **フィールド名** | **型** | **説明**                             | **例**                          |
| ---------------- | ------ | ------------------------------------ | ------------------------------- |
| **`time`**       | String | タイムスタンプ (RFC3339Nano)         | `"2025-12-25T10:00:00.123Z"`    |
| **`level`**      | String | ログレベル                           | `"INFO"`, `"WARN"`, `"ERROR"`   |
| **`app`**        | String | アプリケーション名                   | `"auth-server"`, `"vector-gateway"`, `"vector-api"` |
| **`msg`**        | String | 人間可読なメッセージ                 | `"authentication success"`      |
| **`trace_id`**   | String | **EAP Context UUIDと完全一致するID** | `"550e8400-e29b..."`            |
| **`event_id`**   | String | **機械可読なイベント識別子**         | `"AUTH_OK"`, `"ACCT_START"` |
| **`src`**        | String | ソースコード位置 (Debug/Errorのみ)   | `"main.go:123"`                 |

### 2.1 データ型の厳格化ルール

`lnav` でのSQL集計と、パケットキャプチャとの突合容易性を両立するため、以下の型ルールを厳守する。

- **数値型 (Number/Int64):** 集計・統計・大小比較を行う項目のみ。
  - `latency_ms`, `session_time`, `input_octets`, `output_octets`, `target_count`, `http_status`, `retry_count`, `downtime_ms`, `recovery_time_ms`, `failure_count`, `resync_count`, `attempt`
- **文字列型 (String):** 識別子、ビット列、Hex表記に意味があるもの。
  - `imsi`, `sqn` (Hex), `vlan_id`, `packet_code`, `eap_type`, `http_method`, `identity`, `identity_type`, `error_code`, `backend_id`, `backend_name`, `plmn`

## 3. ノード別詳細仕様

### 3.1 Auth Server (認証サーバー)

認証フローの中核。Trace IDの発行源となる。

#### 3.1.1 システム・通信エラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **ERROR** | `SYS_ERR` | システム障害（Panic等） | `error`, `stacktrace` |
| **ERROR** | `VALKEY_CONN_ERR` | Valkey接続失敗 | `error`, `retry_count` (Int) |
| **ERROR** | `VALKEY_AUTH_ERR` | Valkey認証失敗 | `error` |
| **INFO**  | `VALKEY_CONN_RESTORED` | Valkey接続復旧 | `downtime_ms` (Int) |
| **ERROR** | `VECTOR_API_ERR` | Vector Gateway呼び出し失敗 | `error`, `http_status` (Int), `latency_ms` (Int) |

#### 3.1.2 Circuit Breaker

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `CB_OPEN` | Circuit Breaker Open遷移 | `cb_name`, `failure_count` (Int) |
| **INFO**  | `CB_HALF_OPEN` | Circuit Breaker Half-Open遷移 | `cb_name` |
| **INFO**  | `CB_CLOSE` | Circuit Breaker Close遷移 | `cb_name`, `recovery_time_ms` (Int) |

#### 3.1.3 RADIUSプロトコルエラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `RADIUS_PARSE_ERR` | RADIUSパケットパース失敗 | `src_ip`, `reason` |
| **WARN**  | `RADIUS_AUTH_ERR` | Message-Authenticator検証失敗 | `src_ip` |
| **WARN**  | `RADIUS_NO_SECRET` | Shared Secret不明（client未登録かつ環境変数未設定） | `src_ip` |
| **WARN**  | `RADIUS_UNKNOWN_CODE` | 未知のRADIUSコード | `src_ip`, `code` |

#### 3.1.4 EAPプロトコルエラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `EAP_PARSE_ERR` | EAPパケットパース失敗 | `src_ip`, `reason` |
| **WARN**  | `EAP_UNKNOWN_SUBTYPE` | 未知のEAPサブタイプ（AT_xxx） | `src_ip`, `subtype` |
| **INFO**  | `EAP_UNSUPPORTED_TYPE` | 非対応EAP方式検出（EAP-SIM等） | `src_ip`, `eap_type` |
| **WARN**  | `EAP_IDENTITY_INVALID` | Identity形式不正（IMSI抽出失敗） | `src_ip`, `identity` |
| **INFO**  | `EAP_PSEUDONYM_FALLBACK` | 仮名/高速再認証からフル認証へ誘導 | `src_ip`, `identity_type` |
| **WARN**  | `EAP_CLIENT_ERROR` | AKA-Client-Error受信 | `src_ip`, `imsi`, `error_code` |
| **WARN**  | `EAP_AUTH_REJECT` | AKA-Authentication-Reject受信 | `src_ip`, `imsi` |
| **WARN**  | `EAP_INVALID_STATE` | 不正な状態遷移検出（期待と異なるEAPメッセージ受信） | `trace_id`, `current_state`, `received_msg` |

#### 3.1.5 認証エラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `AUTH_RES_MISMATCH` | AT_RESとXRES不一致 | `trace_id`, `imsi` |
| **WARN**  | `AUTH_MAC_INVALID` | AT_MAC検証失敗 | `trace_id`, `imsi` |
| **INFO**  | `AUTH_IMSI_NOT_FOUND` | IMSI未登録（Vector API 404） | `trace_id`, `imsi` |
| **INFO**  | `AUTH_POLICY_NOT_FOUND` | ポリシー未設定 | `trace_id`, `imsi` |
| **INFO**  | `AUTH_POLICY_DENIED` | ポリシールール不一致 | `trace_id`, `imsi`, `nas_id`, `ssid` |
| **WARN**  | `AUTH_CONTEXT_NOT_FOUND` | EAPコンテキスト不在（State不正） | `trace_id` |
| **WARN**  | `AUTH_TIMEOUT` | EAPコンテキストTTL超過 | `trace_id`, `stage` |
| **WARN**  | `AUTH_RESYNC_LIMIT` | 再同期リトライ上限超過（32回） | `trace_id`, `imsi`, `resync_count` (Int) |

#### 3.1.6 認証成功・正常イベント

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `PKT_RECV` | パケット受信（Access-Request） | `src_ip`, `packet_code` |
| **INFO**  | `AUTH_OK` | 認証成功（Access-Accept） | `src_ip`, `imsi`, `session_uuid`, `latency_ms` (Int) |
| **DEBUG** | `DBG_DUMP` | 詳細解析（AVPダンプ、生データ） | `avp_list` |

### 3.2 Acct Server (課金サーバー)

課金実績の欠損がないことを証明するための記録。

#### 3.2.1 システム・通信エラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **ERROR** | `VALKEY_CONN_ERR` | Valkey接続失敗 | `error`, `retry_count` (Int) |
| **INFO**  | `VALKEY_CONN_RESTORED` | Valkey接続復旧 | `downtime_ms` (Int) |
| **ERROR** | `DB_WRITE_ERR` | Valkey書き込み失敗 | `error`, `src_ip` |

#### 3.2.2 RADIUSプロトコルエラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `RADIUS_PARSE_ERR` | RADIUSパケットパース失敗 | `src_ip`, `reason` |
| **WARN**  | `RADIUS_AUTH_ERR` | Authenticator検証失敗 | `src_ip` |
| **WARN**  | `RADIUS_NO_SECRET` | Shared Secret不明 | `src_ip` |
| **WARN**  | `RADIUS_UNKNOWN_CODE` | 未知のAcct-Status-Type | `src_ip`, `code` |

#### 3.2.3 データ不整合

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `ACCT_SESSION_NOT_FOUND` | sess:{UUID}不在 | `src_ip`, `class_uuid` |
| **WARN**  | `ACCT_SESSION_EXPIRED` | セッションTTL超過（24h経過で自動削除済み） | `src_ip`, `class_uuid` |
| **WARN**  | `ACCT_DUPLICATE_START` | 重複Start受信 | `src_ip`, `acct_session_id` |
| **WARN**  | `ACCT_SEQUENCE_ERR` | 順序異常（StopなしでStart等） | `src_ip`, `acct_session_id`, `reason` |

#### 3.2.4 課金記録・正常イベント

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `PKT_RECV` | パケット受信（Accounting-Request, Status-Server） | `src_ip`, `packet_code` |
| **INFO**  | `ACCT_START` | Accounting-Start受信 | `src_ip`, `imsi`, `acct_session_id` |
| **INFO**  | `ACCT_INTERIM` | Accounting-Interim受信 | `src_ip`, `imsi`, `acct_session_id`, `input_octets` (Int), `output_octets` (Int) |
| **INFO**  | `ACCT_STOP` | Accounting-Stop受信 | `src_ip`, `imsi`, `acct_session_id`, `input_octets` (Int), `output_octets` (Int), `session_time` (Int) |

### 3.3 Vector Gateway (ルーティングノード)

Auth Serverから受信したリクエストを適切なバックエンドにルーティングする。Trace IDの中継点となる。

#### 3.3.1 ルーティングイベント

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **DEBUG** | `PLMN_ROUTE_MATCH` | PLMNマッチでバックエンド選択 | `trace_id`, `plmn`, `backend_id` |
| **DEBUG** | `PLMN_ROUTE_UNMATCH` | PLMNマップに未登録（デフォルト動作） | `trace_id`, `imsi`（マスク済み） |

#### 3.3.2 バックエンド通信

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `BACKEND_INTERNAL_CALL` | 内部Vector API呼び出し | `trace_id`, `imsi`（マスク済み）, `backend_id`, `backend_name` |
| **ERROR** | `BACKEND_INTERNAL_ERR` | 内部Vector API呼び出し失敗 | `trace_id`, `error`, `http_status` (Int), `latency_ms` (Int) |

#### 3.3.3 リクエストエラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `REQUEST_INVALID` | リクエスト形式不正（IMSI形式エラー等） | `trace_id`, `reason` |
| **WARN**  | `BACKEND_NOT_IMPLEMENTED` | 未実装接続方式IDが指定された（501返却） | `trace_id`, `backend_id` |

#### 3.3.4 正常イベント

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `GW_REQUEST_OK` | リクエスト処理成功 | `trace_id`, `imsi`（マスク済み）, `backend_id`, `latency_ms` (Int), `http_status` (Int) |

#### 3.3.5 将来追加予定（外部API連携時）

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `BACKEND_EXTERNAL_CALL` | 外部API呼び出し | `trace_id`, `imsi`（マスク済み）, `backend_id`, `external_endpoint` |
| **ERROR** | `BACKEND_EXTERNAL_ERR` | 外部API呼び出し失敗 | `trace_id`, `error`, `http_status` (Int), `latency_ms` (Int) |
| **ERROR** | `EXTERNAL_AUTH_ERR` | 外部API認証失敗 | `trace_id`, `backend_id` |
| **WARN**  | `EXTERNAL_RATE_LIMIT` | 外部API Rate Limit | `trace_id`, `backend_id` |

### 3.4 Vector API (計算ノード)

Auth Server（またはVector Gateway）から伝搬されたTrace IDを記録する。

#### 3.4.1 システム・通信エラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **ERROR** | `VALKEY_CONN_ERR` | Valkey接続失敗 | `error`, `retry_count` (Int) |
| **INFO**  | `VALKEY_CONN_RESTORED` | Valkey接続復旧 | `downtime_ms` (Int) |

#### 3.4.2 計算エラー

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `CALC_ERR` | IMSI不在（404応答） | `imsi`, `http_status` (Int), `reason` |
| **WARN**  | `CALC_ERR` | IMSIフォーマット不正、計算エラー | `imsi`, `http_status` (Int), `reason` |
| **ERROR** | `CALC_ERR` | Milenage計算の予期せぬエラー | `error`, `imsi`, `http_status` (Int) |

#### 3.4.3 SQN再同期

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `SQN_RESYNC` | SQN再同期実行成功 | `imsi`, `sqn_old` (Hex), `sqn_new` (Hex) |
| **WARN**  | `SQN_RESYNC_MAC_ERR` | AUTS MAC検証失敗 | `imsi` |
| **WARN**  | `SQN_RESYNC_FORMAT_ERR` | AUTS形式不正（14バイトでない） | `imsi` |
| **WARN**  | `SQN_RESYNC_DECODE_ERR` | SQN抽出失敗 | `imsi` |

#### 3.4.4 正常イベント

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **INFO**  | `CALC_OK` | APIアクセス成功（ベクター生成完了） | `imsi`, `method`, `path`, `latency_ms` (Int), `http_status` (Int) |

#### 3.4.5 SQN競合

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **WARN**  | `SQN_CONFLICT_RETRY` | SQN更新競合検出、リトライ実行 | `imsi`, `attempt` (Int) |
| **WARN**  | `SQN_CONFLICT_ERR` | SQN更新競合がリトライ上限を超過（409応答） | `imsi`, `retry_count` (Int) |

### 3.5 Admin TUI (管理ツール)

管理操作の監査証跡 (Audit Trail) およびデータクリーンアップログ。

| **Level** | **event_id** | **内容・条件** | **必須属性 (Key)** |
| --------- | ------------ | -------------- | ------------------ |
| **ERROR** | `OP_ERR` | 操作失敗 | `error`, `operation` |
| **WARN**  | `BULK_OP` | 危険な操作（大量削除など） | `operation`, `target_count` (Int) |
| **WARN**  | `IDX_USER_CLEANUP_ERR` | idx:userクリーンアップ失敗（表示は継続） | `imsi`, `error` |
| **INFO**  | `AUDIT_LOG` | 操作記録（加入者/ポリシーの作成・修正・削除、ツール起動） | `admin_user`, `operation`, `target_imsi` |
| **DEBUG** | `IDX_USER_CLEANUP` | idx:userクリーンアップ成功 | `imsi`, `removed_count` (Int) |

#### 3.5.1 idx:userクリーンアップログ

Session Detail画面でIMSI検索時、`idx:user:{IMSI}` インデックスに残存するゴミデータ（存在しないセッションへの参照）をクリーンアップする際のログ。

| event_id | レベル | 発生条件 | 備考 |
|----------|--------|---------|------|
| `IDX_USER_CLEANUP` | DEBUG | クリーンアップ成功時 | 削除したUUID数を `removed_count` で出力 |
| `IDX_USER_CLEANUP_ERR` | WARN | クリーンアップ失敗時 | 画面表示は継続、ログ出力のみ |

**ログ出力例:**

```json
{
  "time": "2026-01-27T10:30:00.000Z",
  "level": "DEBUG",
  "app": "admin-tui",
  "event_id": "IDX_USER_CLEANUP",
  "msg": "cleaned up stale session references",
  "imsi": "440101234567890",
  "removed_count": 3
}
```

> **注記:** クリーンアップ処理の詳細はD-07「Admin TUI詳細設計書【後半】」セクション6.10を参照。

## 4. 実装要件 (Go Implementation)

### 4.1 Trace ID の統合と伝搬 (Unified Tracing)

ログの `trace_id`、Valkey上のEAP Context Key、RADIUS State属性を完全に一致させる。

1. **Auth Server:**
   - `Access-Request` (Identity) 受信時にUUIDを生成。
   - **Log:** `slog.With("trace_id", uuid)` でロガーをセットアップ。
   - **DB:** `eap:{UUID}` キーとしてValkeyへ保存。
   - **API Call:** Vector Gateway コール時、HTTPヘッダ `X-Trace-ID` にこのUUIDをセット。
2. **Vector Gateway:**
   - Middlewareで `X-Trace-ID` ヘッダを読み取る。
   - 読み取ったIDを `slog` のコンテキストにセットし、自身のログ出力時に `trace_id` として出力する。
   - 内部Vector APIコール時、同一の `X-Trace-ID` をヘッダに付与して伝搬する。
3. **Vector API:**
   - Middlewareで `X-Trace-ID` ヘッダを読み取る。
   - 読み取ったIDを `slog` のコンテキストにセットし、自身のログ出力時に `trace_id` として出力する。

### 4.2 Circuit Breaker ログ実装

`sony/gobreaker` のフック機能を利用し、状態変化を確実に記録する。

```go
// Auth Server実装イメージ
OnStateChange: func(name string, from State, to State) {
    switch to {
    case StateOpen:
        slog.Warn("circuit breaker opened",
            "event_id", "CB_OPEN",
            "cb_name", name,
            "failure_count", 5)
    case StateHalfOpen:
        slog.Info("circuit breaker half-open",
            "event_id", "CB_HALF_OPEN",
            "cb_name", name)
    case StateClosed:
        slog.Info("circuit breaker closed",
            "event_id", "CB_CLOSE",
            "cb_name", name,
            "recovery_time_ms", recoveryTime.Milliseconds())
    }
}
```

### 4.3 Valkey接続復旧検知

```go
var lastConnError time.Time
var mu sync.Mutex

func executeWithConnTracking(ctx context.Context, fn func() error) error {
    err := fn()
    
    mu.Lock()
    defer mu.Unlock()
    
    if err != nil {
        if isConnectionError(err) {
            lastConnError = time.Now()
        }
        return err
    }
    
    // 接続復旧を検知
    if !lastConnError.IsZero() {
        downtime := time.Since(lastConnError)
        slog.Info("valkey connection restored",
            "event_id", "VALKEY_CONN_RESTORED",
            "downtime_ms", downtime.Milliseconds())
        lastConnError = time.Time{}
    }
    return nil
}
```

### 4.4 IMSIマスキング設定

セキュリティ上、ログに出力するIMSIは中央部分をマスクする。

#### 4.4.1 環境変数による制御

| 環境変数 | デフォルト | 対象コンポーネント | 説明 |
|---------|-----------|------------------|------|
| `LOG_MASK_IMSI` | `true` | Auth Server, Acct Server, Vector Gateway, Vector API | `false` でマスキング無効化（デバッグ用） |

**Admin TUIはIMSIマスキング対象外:**
- Admin TUIは `LOG_MASK_IMSI` 環境変数の設定にかかわらず、IMSIをマスキングしない
- 画面表示・監査ログともIMSIを常に生値で表示/記録する
- 理由: 管理操作や監査証跡でIMSIを確実に識別できる運用を優先

**設定の一元管理:**
- 4コンポーネントで同一の環境変数名を使用
- Docker Composeの `.env` ファイルで一括設定可能
- 詳細は D-08「インフラ設定・運用設計書」を参照

**用途:**
- **本番環境**: `LOG_MASK_IMSI=true`（デフォルト）でプライバシー保護
- **開発・デバッグ環境**: `LOG_MASK_IMSI=false` で問題調査時にIMSI全桁を確認可能

#### 4.4.2 マスキング仕様

| 設定値 | 動作 | 出力例（入力: `440101234567890`） |
|--------|------|--------------------------------|
| `true`（デフォルト） | 先頭6桁 + マスク + 末尾1桁 | `440101********0` |
| `false` | マスクなし（全桁表示） | `440101234567890` |

#### 4.4.3 実装例

```go
// 全コンポーネント共通実装イメージ
type Config struct {
    LogMaskIMSI bool `envconfig:"LOG_MASK_IMSI" default:"true"`
}

func maskIMSI(imsi string, enabled bool) string {
    if !enabled {
        return imsi
    }
    if len(imsi) <= 6 {
        return imsi
    }
    return imsi[:6] + "********" + imsi[len(imsi)-1:]
}

// 使用例
slog.Info("calling internal vector API",
    "event_id", "BACKEND_INTERNAL_CALL",
    "trace_id", traceID,
    "imsi", maskIMSI(req.IMSI, cfg.LogMaskIMSI),
    "backend_id", "00",
    "backend_name", "vector-api")
```

#### 4.4.4 注意事項

**セキュリティ:**
- `LOG_MASK_IMSI=false` の設定は、ログファイルへのアクセス制御が適切に行われている環境でのみ使用すること
- デバッグ目的でマスキングを無効化した場合、調査完了後は速やかに `true` に戻すこと

**Auth Serverの適用範囲:**
- Auth Serverでは、IMSIは認証フロー全体（Identity受信、Vector Gateway呼び出し、ポリシー評価、セッション作成）で使用される
- 詳細な適用箇所は D-09「Auth Server詳細設計書」セクション3.5を参照

**Acct Serverの適用範囲:**

- Acct Serverでは、IMSIは課金ログ（ACCT_START, ACCT_INTERIM, ACCT_STOP）で使用される
- 詳細な適用箇所は D-10「Acct Server詳細設計書」を参照

**lnav運用への影響:**

- IMSIマスキング有効時（デフォルト）、lnavでの特定IMSI絞り込み検索が不可能になる
  - 例: `;SELECT * FROM logline WHERE imsi = '440101234567890'` は機能しない
  - マスク後の値（`440101********0`）での検索は可能だが、同一プレフィックスの加入者を区別できない
- **代替手段:**
  - `trace_id` による認証フロー追跡を推奨
  - 特定IMSIの調査が必要な場合は、開発/ステージング環境で `LOG_MASK_IMSI=false` に設定して再現
- 詳細は O-05「ログ解析ガイド」（実装完了後に作成予定）を参照

**Admin TUIの除外:**
- Admin TUIはIMSIマスキングの対象外であり、`LOG_MASK_IMSI` 環境変数は参照しない
- 管理画面では常にIMSI全桁を表示し、監査ログ（`AUDIT_LOG`）にもIMSI生値を出力する
- これにより、管理者が加入者を一意に識別でき、監査証跡として機能する

### 4.5 セキュリティ要件 (Security)

以下の機密情報は、**いかなるログレベルであっても絶対に出力してはならない**。

- Ki (秘密鍵)
- OPc
- Radius Shared Secret
- Session Keys (CK, IK, MS-MPPE-*-Key)
- 完全なIMSI（`LOG_MASK_IMSI=true` 時は全コンポーネントでマスク）

## 5. 運用・解析環境 (lnav Configuration)

ホストOS上の `lnav` でログを快適に閲覧するための設定ファイルを、リポジトリ構成に合わせて配置する。

**ファイル配置:** `~/.lnav/formats/eap_aka_log.json` (リポジトリ内の `deployments/lnav_formats/` からコピー)

```json
{
    "eap_aka_log": {
        "title": "EAP-AKA System Logs",
        "description": "Structured logs from Go RADIUS PoC",
        "url": "http://localhost",
        "json": true,
        "key_field": "time",
        "level_field": "level",
        "body_field": "msg",
        "timestamp_format": "%Y-%m-%dT%H:%M:%S.%L%Z",
        "value": {
            "imsi": { "kind": "string", "identifier": true },
            "trace_id": { "kind": "string", "identifier": true },
            "event_id": { "kind": "string", "identifier": true },
            "backend_id": { "kind": "string", "identifier": true },
            "plmn": { "kind": "string", "identifier": true },
            "latency_ms": { "kind": "integer" },
            "input_octets": { "kind": "integer" },
            "output_octets": { "kind": "integer" },
            "retry_count": { "kind": "integer" },
            "downtime_ms": { "kind": "integer" },
            "failure_count": { "kind": "integer" },
            "resync_count": { "kind": "integer" },
            "http_status": { "kind": "integer" }
        },
        "line_format": [
            { "field": "time" }, " ",
            { "field": "level" }, " ",
            { "field": "app" }, " ",
            { "field": "event_id", "default": "-" }, " ",
            "[", { "field": "imsi", "default": "no-imsi" }, "] ",
            { "field": "msg" }
        ]
    }
}
```

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | - | 初版 |
| r2 | - | Trace ID統合、Circuit Breakerログ、セキュリティ要件追加 |
| r3 | 2025-12-30 | event_id細分化（AUTH_FAIL→認証エラー8種、PACKET_INVALID→RADIUS/EAPエラー各種、DATA_INTEG_ERR→Acctデータエラー4種）、新規event_id追加（EAP_PSEUDONYM_FALLBACK、AUTH_RESYNC_LIMIT、SQN_RESYNC_*等）、Valkey接続復旧検知追加 |
| r4 | 2026-01-05 | Vector Gateway追加：セクション3.3新設（PLMN_ROUTE_MATCH, PLMN_ROUTE_UNMATCH, BACKEND_NOT_IMPLEMENTED, BACKEND_INTERNAL_CALL, BACKEND_INTERNAL_ERR, REQUEST_INVALID, GW_REQUEST_OK）、将来追加予定の外部API用event_id定義、セクション4.1のTrace ID伝搬にVector Gateway追加、セクション4.4にIMSIマスキング実装追加、lnav設定にbackend_id/plmn/http_status追加 |
| r5 | 2026-01-12 | EAP_INVALID_STATE追加（D-03/D-09との整合）：不正な状態遷移検出時のevent_id |
| r6 | 2026-01-17 | IMSIマスキングの環境変数対応（LOG_MASK_IMSI）：セクション4.4を拡張、Vector Gateway / Vector APIで共通の設定方式を定義 |
| r7 | 2026-01-18 | IMSIマスキング対象コンポーネントにAuth Server追加: セクション4.4.1更新、セクション4.4.4にAuth Server適用範囲・lnav運用影響を追記、セクション4.5の文言更新 |
| r8 | 2026-01-20 | IMSIマスキング仕様追加: 全4コンポーネント（Auth Server, Acct Server, Vector Gateway, Admin TUI）のIMSIマスキング仕様を統一的に定義。セクション6新設。 |
| r9 | 2026-01-21 | Acct Server Status-Server対応: セクション3.2.4にPKT_RECV追加、見出しを「課金記録・正常イベント」に変更 |
| r10 | 2026-01-26 | SQN競合制御対応: セクション3.4.5新設（SQN_CONFLICT_RETRY, SQN_CONFLICT_ERR追加）、セクション2.1の数値型リストにattempt追加 |
| r11 | 2026-01-27 | IMSIマスキング適用範囲明確化: Admin TUIをマスキング対象外として明記（セクション4.4.1, 4.4.4に追記） |
| r12 | 2026-01-27 | Admin TUI event_id追加: セクション3.5にIDX_USER_CLEANUP（DEBUG）/IDX_USER_CLEANUP_ERR（WARN）追加、セクション3.5.1新設（idx:userクリーンアップログ仕様） |
| r13 | 2026-02-18 | タイトル版数表記修正（r11→r13）、関連ドキュメント版数更新 |
