# O-05 ログ解析ガイド (r1)

## 1. 概要

### 1.1 目的

本ドキュメントは、EAP-AKA/AKA' RADIUS PoC環境において、実機環境でのログ解析・障害調査を行うための実務ガイドである。D-04（ログ仕様設計書）で定義されたログアーキテクチャ・event_id体系・lnavフォーマットを活用し、効率的な障害調査手順を提供する。

### 1.2 対象読者

- E2Eテスト実施者
- 運用担当者

### 1.3 前提条件

- B-02（アプリケーションデプロイ手順書）の手順に従いデプロイ済みであること
- lnavフォーマットファイルが配置済みであること（B-02 §10参照）
- lnavがホストOSにインストール済みであること

### 1.4 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| D-04 ログ仕様設計書 (r13) | ログフォーマット、event_id体系、IMSIマスキング仕様、lnavフォーマット定義 |
| D-08 インフラ設定・運用設計書 (r10) | Fluent Bit設定、logrotate設定、ログ出力パス |
| B-02 アプリケーションデプロイ手順書 (r2) | lnavフォーマットファイル配置手順（§10） |
| T-01 テスト戦略書 (r2) | E2Eテスト時のログ確認方針 |

---

## 2. ログアーキテクチャ概要

### 2.1 ログ収集フロー

```
┌─────────────────────────────────────────────────────────┐
│  Docker Compose 環境                                      │
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ auth-server   │  │ acct-server   │  │vector-gateway│   │
│  │ (Go slog/JSON)│  │ (Go slog/JSON)│  │(Go slog/JSON)│   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │stdout           │stdout           │stdout       │
│  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐   │
│  │ vector-api    │  │   valkey      │  │              │   │
│  │ (Go slog/JSON)│  │              │  │              │   │
│  └──────┬───────┘  └──────┬───────┘  └──────────────┘   │
│         │stdout           │stdout                         │
│         ▼                 ▼                               │
│  ┌─────────────────────────────────────┐                  │
│  │     Docker Log Driver (fluentd)      │                  │
│  └──────────────┬──────────────────────┘                  │
│                 │ forward                                  │
│  ┌──────────────▼──────────────────────┐                  │
│  │     Fluent Bit (タグ付け・分割)       │                  │
│  └──────────────┬──────────────────────┘                  │
└─────────────────┼─────────────────────────────────────────┘
                  │ ファイル出力
                  ▼
  ┌─────────────────────────────────────┐
  │  ホストOS ログディレクトリ              │
  │  ~/eapaka-radius-server-poc/         │
  │    deployments/logs_on_host/         │
  │    ├── auth-server.log               │
  │    ├── acct-server.log               │
  │    ├── vector-gateway.log            │
  │    ├── vector-api.log                │
  │    ├── valkey.log                    │
  │    └── others.log                    │
  └──────────────┬──────────────────────┘
                 │
                 ▼
  ┌─────────────────────────────────────┐
  │  lnav (フォーマット適用・SQL分析)      │
  └─────────────────────────────────────┘
```

### 2.2 ログファイル一覧

| ファイル名 | 出力元 | 推定容量/日 |
|-----------|--------|------------|
| `auth-server.log` | Auth Server（認証サーバー） | 〜10MB |
| `acct-server.log` | Acct Server（課金サーバー） | 〜5MB |
| `vector-gateway.log` | Vector Gateway（ルーティングノード） | 〜5MB |
| `vector-api.log` | Vector API（計算ノード） | 〜5MB |
| `valkey.log` | Valkey（KVS） | 〜1MB |
| `others.log` | 上記以外のコンテナ | 〜1MB |

**ログディレクトリパス:**

```
~/eapaka-radius-server-poc/deployments/logs_on_host/
```

---

## 3. ログフォーマットとフィールド

### 3.1 共通フィールド

すべてのアプリケーションログは以下のフィールドを含むJSON形式で出力される。

| フィールド名 | 型 | 説明 | 例 |
|-------------|------|------|-----|
| `time` | String | タイムスタンプ (RFC3339Nano) | `"2026-02-22T10:00:00.123Z"` |
| `level` | String | ログレベル | `"INFO"`, `"WARN"`, `"ERROR"`, `"DEBUG"` |
| `app` | String | アプリケーション名 | `"auth-server"` |
| `msg` | String | 人間可読メッセージ | `"authentication success"` |
| `trace_id` | String | EAP Context UUID | `"550e8400-e29b-..."` |
| `event_id` | String | 機械可読イベント識別子 | `"AUTH_OK"` |
| `src` | String | ソースコード位置（Debug/Errorのみ） | `"main.go:123"` |

### 3.2 数値型フィールド（SQL集計可能）

以下のフィールドは数値型で出力され、lnavのSQLクエリで集計・比較が可能。

| フィールド名 | 説明 | 使用コンポーネント |
|-------------|------|-----------------|
| `latency_ms` | レスポンス遅延 (ms) | Auth Server, Vector Gateway, Vector API |
| `session_time` | セッション時間 (秒) | Acct Server |
| `input_octets` | 受信バイト数 | Acct Server |
| `output_octets` | 送信バイト数 | Acct Server |
| `target_count` | 操作対象件数 | Admin TUI |
| `http_status` | HTTPステータスコード | Vector Gateway, Vector API |
| `retry_count` | リトライ回数 | Auth Server, Acct Server, Vector API |
| `downtime_ms` | ダウンタイム (ms) | Auth Server, Acct Server, Vector API |
| `recovery_time_ms` | 復旧時間 (ms) | Auth Server |
| `failure_count` | 障害カウント | Auth Server |
| `resync_count` | 再同期回数 | Auth Server |
| `attempt` | 試行回数 | Vector API |

### 3.3 文字列型フィールド（識別子・Hex表記）

| フィールド名 | 説明 |
|-------------|------|
| `imsi` | 加入者識別番号（マスキング対象） |
| `sqn` | シーケンス番号（Hex表記） |
| `vlan_id` | VLAN ID |
| `packet_code` | RADIUSパケットコード |
| `eap_type` | EAP方式 |
| `identity` | EAP Identity |
| `identity_type` | Identity種別 |
| `backend_id` | バックエンドID |
| `plmn` | PLMN（キャリア識別） |

### 3.4 IMSIマスキング

環境変数 `LOG_MASK_IMSI` によりIMSI出力を制御する。

| 設定値 | 動作 | 出力例（入力: `440101234567890`） |
|--------|------|--------------------------------|
| `true`（デフォルト） | 先頭6桁 + マスク + 末尾1桁 | `440101********0` |
| `false` | マスクなし（全桁表示） | `440101234567890` |

**対象コンポーネント:** auth-server, acct-server, vector-gateway, vector-api

**注意:** Admin TUIは `LOG_MASK_IMSI` の対象外。常にIMSI全桁を表示・記録する。

**マスキング有効時の検索への影響:**

- マスキング有効時、lnavでの特定IMSI検索は不可（同一プレフィックスの加入者を区別できない）
- **代替手段:** `trace_id` による認証フロー追跡を推奨
- 特定IMSIの調査が必要な場合は `LOG_MASK_IMSI=false` に設定して再現する

### 3.5 JSON構造の読み方

ログファイルの各行は1つのJSON オブジェクトである。以下はログ出力例。

```json
{
  "time": "2026-02-22T10:00:00.123Z",
  "level": "INFO",
  "app": "auth-server",
  "msg": "authentication success",
  "trace_id": "550e8400-e29b-41d4-a716-446655440000",
  "event_id": "AUTH_OK",
  "imsi": "440101********0",
  "src_ip": "192.168.1.1",
  "session_uuid": "a1b2c3d4-...",
  "latency_ms": 45
}
```

lnavではフォーマットファイルにより自動的に以下の表示形式に変換される。

```
2026-02-22T10:00:00.123Z INFO auth-server AUTH_OK [440101********0] authentication success
```

---

## 4. lnavの基本操作

### 4.1 起動方法

```bash
# 単一ファイルを開く
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/auth-server.log

# 複数ファイルを開く（コンポーネント横断分析）
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/auth-server.log \
     ~/eapaka-radius-server-poc/deployments/logs_on_host/vector-gateway.log \
     ~/eapaka-radius-server-poc/deployments/logs_on_host/vector-api.log

# ワイルドカードで全ログファイルを開く
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log

# フォーマット設定の検証（エラーがないことを確認）
lnav -C
```

### 4.2 ナビゲーション（キーバインド）

#### 移動

| キー | 動作 |
|------|------|
| `j` / `↓` | 次の行へ |
| `k` / `↑` | 前の行へ |
| `Space` / `PgDn` | 次のページ |
| `b` / `PgUp` | 前のページ |
| `g` | ファイル先頭へ |
| `G` | ファイル末尾へ |
| `e` / `E` | 次の/前のエラー行へジャンプ |
| `w` / `W` | 次の/前の警告行へジャンプ |

#### 検索

| キー | 動作 |
|------|------|
| `/` | 正規表現で前方検索 |
| `?` | 正規表現で後方検索 |
| `n` | 次の検索結果へ |
| `N` | 前の検索結果へ |

#### 時間操作

| キー | 動作 |
|------|------|
| `1` - `6` | 次の10秒/1分/10分/1時間/1日/翌日20:00へジャンプ |
| `!1` - `!6` | 前の時間単位へジャンプ |
| `d` / `D` | 次の/前の日付へジャンプ |

### 4.3 フィルタリング

```
# 特定のevent_idのみ表示
:filter-in event_id AUTH_OK

# エラーレベルのみ表示
:filter-in level ERROR

# 特定のアプリケーションのみ表示
:filter-in app auth-server

# 特定のevent_idを除外
:filter-out event_id DBG_DUMP

# フィルタをクリア
:reset-session
```

### 4.4 テキスト検索

```
# IMSIで検索（マスキング済み）
/440101\*{8}0

# trace_idで検索
/550e8400-e29b-41d4-a716-446655440000

# エラーメッセージで検索
/connection refused

# 複合検索（正規表現）
/AUTH_RES_MISMATCH|AUTH_MAC_INVALID
```

### 4.5 SQLモード

lnavでは `;` キーでSQLモードに入り、ログをリレーショナルデータとして分析できる。

```sql
-- テーブル名は logline
;SELECT * FROM logline LIMIT 10

-- 利用可能なカラム確認
;.schema logline
```

**主要カラム（lnavフォーマット定義による）:**

| カラム名 | 型 | 説明 |
|---------|------|------|
| `log_time` | timestamp | ログ出力時刻 |
| `log_level` | text | ログレベル |
| `log_body` | text | メッセージ本文 |
| `imsi` | text | IMSI |
| `trace_id` | text | トレースID |
| `event_id` | text | イベントID |
| `backend_id` | text | バックエンドID |
| `plmn` | text | PLMN |
| `latency_ms` | integer | レスポンス遅延 |
| `input_octets` | integer | 受信バイト数 |
| `output_octets` | integer | 送信バイト数 |
| `retry_count` | integer | リトライ回数 |
| `downtime_ms` | integer | ダウンタイム |
| `failure_count` | integer | 障害カウント |
| `resync_count` | integer | 再同期回数 |
| `http_status` | integer | HTTPステータスコード |

---

## 5. event_idリファレンス

### 5.1 Auth Server

#### システム・通信エラー

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `SYS_ERR` | ERROR | システム障害（Panic等） | **要対処** — スタックトレースを確認し根本原因を特定 |
| `VALKEY_CONN_ERR` | ERROR | Valkey接続失敗 | **要対処** — Valkeyプロセス・ネットワーク確認 |
| `VALKEY_AUTH_ERR` | ERROR | Valkey認証失敗 | **要対処** — パスワード設定確認 |
| `VALKEY_CONN_RESTORED` | INFO | Valkey接続復旧 | 情報 — `downtime_ms` で影響時間を確認 |
| `VECTOR_API_ERR` | ERROR | Vector Gateway呼び出し失敗 | **要対処** — Vector Gatewayの状態確認 |

#### Circuit Breaker

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `CB_OPEN` | WARN | Circuit Breaker Open遷移 | **要注意** — 後続リクエストが即時拒否される |
| `CB_HALF_OPEN` | INFO | Circuit Breaker Half-Open遷移 | 情報 — 復旧試行中 |
| `CB_CLOSE` | INFO | Circuit Breaker Close遷移 | 情報 — 正常復旧完了 |

#### RADIUSプロトコルエラー

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `RADIUS_PARSE_ERR` | WARN | RADIUSパケットパース失敗 | 要調査 — 不正パケットの送信元確認 |
| `RADIUS_AUTH_ERR` | WARN | Message-Authenticator検証失敗 | 要調査 — Shared Secret不一致の可能性 |
| `RADIUS_NO_SECRET` | WARN | Shared Secret不明 | 要調査 — クライアント登録確認 |
| `RADIUS_UNKNOWN_CODE` | WARN | 未知のRADIUSコード | 情報 — 想定外パケット |

#### EAPプロトコルエラー

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `EAP_PARSE_ERR` | WARN | EAPパケットパース失敗 | 要調査 — パケットキャプチャと照合 |
| `EAP_UNKNOWN_SUBTYPE` | WARN | 未知のEAPサブタイプ | 情報 — 未対応のAT属性 |
| `EAP_UNSUPPORTED_TYPE` | INFO | 非対応EAP方式検出（EAP-SIM等） | 情報 — クライアント設定確認 |
| `EAP_IDENTITY_INVALID` | WARN | Identity形式不正 | 要調査 — IMSI抽出失敗 |
| `EAP_PSEUDONYM_FALLBACK` | INFO | 仮名/高速再認証からフル認証へ誘導 | 情報 — 正常動作 |
| `EAP_CLIENT_ERROR` | WARN | AKA-Client-Error受信 | 要調査 — クライアント側エラー |
| `EAP_AUTH_REJECT` | WARN | AKA-Authentication-Reject受信 | 要調査 — クライアントが認証を拒否 |
| `EAP_INVALID_STATE` | WARN | 不正な状態遷移検出 | 要調査 — 期待と異なるEAPメッセージ |

#### 認証エラー

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `AUTH_RES_MISMATCH` | WARN | AT_RESとXRES不一致 | **要調査** — SIMデータ不整合の可能性 |
| `AUTH_MAC_INVALID` | WARN | AT_MAC検証失敗 | **要調査** — 鍵導出異常の可能性 |
| `AUTH_IMSI_NOT_FOUND` | INFO | IMSI未登録（Vector API 404） | 要確認 — 加入者データ未登録 |
| `AUTH_POLICY_NOT_FOUND` | INFO | ポリシー未設定 | 要確認 — ポリシーデータ未登録 |
| `AUTH_POLICY_DENIED` | INFO | ポリシールール不一致 | 情報 — NAS/SSID制限による拒否 |
| `AUTH_CONTEXT_NOT_FOUND` | WARN | EAPコンテキスト不在 | 要調査 — State不正、セッション消失 |
| `AUTH_TIMEOUT` | WARN | EAPコンテキストTTL超過 | 情報 — クライアント応答遅延 |
| `AUTH_RESYNC_LIMIT` | WARN | 再同期リトライ上限超過（32回） | **要調査** — SQN不整合の根本原因を特定 |

#### 認証成功・正常イベント

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `PKT_RECV` | INFO | パケット受信（Access-Request） | 情報 — 正常動作 |
| `AUTH_OK` | INFO | 認証成功（Access-Accept） | 情報 — 正常完了 |
| `DBG_DUMP` | DEBUG | 詳細解析（AVPダンプ） | デバッグ用 |

### 5.2 Acct Server

#### システム・通信エラー

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `VALKEY_CONN_ERR` | ERROR | Valkey接続失敗 | **要対処** — Valkeyプロセス確認 |
| `VALKEY_CONN_RESTORED` | INFO | Valkey接続復旧 | 情報 |
| `DB_WRITE_ERR` | ERROR | Valkey書き込み失敗 | **要対処** — データ欠損の可能性 |

#### RADIUSプロトコルエラー

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `RADIUS_PARSE_ERR` | WARN | RADIUSパケットパース失敗 | 要調査 |
| `RADIUS_AUTH_ERR` | WARN | Authenticator検証失敗 | 要調査 |
| `RADIUS_NO_SECRET` | WARN | Shared Secret不明 | 要調査 |
| `RADIUS_UNKNOWN_CODE` | WARN | 未知のAcct-Status-Type | 情報 |

#### データ不整合

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `ACCT_SESSION_NOT_FOUND` | WARN | セッション不在 | 要調査 — 認証なしの課金リクエスト |
| `ACCT_SESSION_EXPIRED` | WARN | セッションTTL超過（24h経過） | 情報 — 自動削除済み |
| `ACCT_DUPLICATE_START` | WARN | 重複Start受信 | 要調査 — NAS再送の可能性 |
| `ACCT_SEQUENCE_ERR` | WARN | 順序異常 | 要調査 — StopなしでStart等 |

#### 課金記録・正常イベント

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `PKT_RECV` | INFO | パケット受信（Accounting-Request, Status-Server） | 情報 |
| `ACCT_START` | INFO | Accounting-Start受信 | 情報 — セッション開始 |
| `ACCT_INTERIM` | INFO | Accounting-Interim受信 | 情報 — 中間更新 |
| `ACCT_STOP` | INFO | Accounting-Stop受信 | 情報 — セッション終了 |

### 5.3 Vector Gateway

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `PLMN_ROUTE_MATCH` | DEBUG | PLMNマッチでバックエンド選択 | デバッグ用 |
| `PLMN_ROUTE_UNMATCH` | DEBUG | PLMNマップに未登録 | デバッグ用 |
| `BACKEND_INTERNAL_CALL` | INFO | 内部Vector API呼び出し | 情報 |
| `BACKEND_INTERNAL_ERR` | ERROR | 内部Vector API呼び出し失敗 | **要対処** — Vector API状態確認 |
| `REQUEST_INVALID` | WARN | リクエスト形式不正 | 要調査 |
| `BACKEND_NOT_IMPLEMENTED` | WARN | 未実装接続方式ID指定 | 情報 — 501応答 |
| `GW_REQUEST_OK` | INFO | リクエスト処理成功 | 情報 |

### 5.4 Vector API

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `VALKEY_CONN_ERR` | ERROR | Valkey接続失敗 | **要対処** |
| `VALKEY_CONN_RESTORED` | INFO | Valkey接続復旧 | 情報 |
| `CALC_ERR` | INFO/WARN/ERROR | 計算エラー（レベルは原因による） | レベルに応じて対処 |
| `SQN_RESYNC` | INFO | SQN再同期成功 | 情報 — 正常動作 |
| `SQN_RESYNC_MAC_ERR` | WARN | AUTS MAC検証失敗 | 要調査 |
| `SQN_RESYNC_FORMAT_ERR` | WARN | AUTS形式不正 | 要調査 |
| `SQN_RESYNC_DECODE_ERR` | WARN | SQN抽出失敗 | 要調査 |
| `CALC_OK` | INFO | ベクター生成成功 | 情報 |
| `SQN_CONFLICT_RETRY` | WARN | SQN更新競合、リトライ実行 | 情報 — 自動リトライ |
| `SQN_CONFLICT_ERR` | WARN | SQN更新競合リトライ上限超過 | **要調査** — 409応答 |

### 5.5 Admin TUI

| event_id | Level | 内容 | 対処要否 |
|----------|-------|------|---------|
| `OP_ERR` | ERROR | 操作失敗 | **要対処** |
| `BULK_OP` | WARN | 危険な操作（大量削除など） | **要注意** — 意図した操作か確認 |
| `IDX_USER_CLEANUP_ERR` | WARN | idx:userクリーンアップ失敗 | 情報 — 表示は継続 |
| `AUDIT_LOG` | INFO | 操作記録 | 情報 — 監査証跡 |
| `IDX_USER_CLEANUP` | DEBUG | idx:userクリーンアップ成功 | デバッグ用 |

---

## 6. 頻出クエリ集

### 6.1 基本フィルタリング（lnavコマンド）

```
# event_id別ログ抽出
:filter-in event_id AUTH_OK

# 複数のevent_idで抽出（正規表現）
:filter-in event_id AUTH_OK|AUTH_RES_MISMATCH|AUTH_MAC_INVALID

# アプリケーション別ログ表示
:filter-in app auth-server

# エラーレベルのみ表示
:filter-in level ERROR

# WARN以上を表示
:filter-in level ERROR|WARN

# 特定のtrace_idで絞り込み
:filter-in trace_id 550e8400-e29b-41d4-a716-446655440000

# フィルタのクリア
:reset-session
```

### 6.2 SQL分析クエリ

#### 特定IMSIの認証履歴取得

```sql
-- マスキング無効時
;SELECT log_time, event_id, log_body
 FROM logline
 WHERE imsi = '440101234567890'
 ORDER BY log_time

-- マスキング有効時（プレフィックスで絞り込み）
;SELECT log_time, event_id, log_body
 FROM logline
 WHERE imsi = '440101********0'
 ORDER BY log_time
```

#### trace_idによるフロー追跡（複数ファイル横断）

```sql
;SELECT log_time, log_level, log_body, event_id, log_body
 FROM logline
 WHERE trace_id = '550e8400-e29b-41d4-a716-446655440000'
 ORDER BY log_time
```

#### エラー発生頻度の集計（event_id別カウント）

```sql
;SELECT event_id, count(*) as cnt
 FROM logline
 WHERE log_level IN ('ERROR', 'WARNING')
 GROUP BY event_id
 ORDER BY cnt DESC
```

#### 時間帯別エラー分布

```sql
;SELECT strftime('%Y-%m-%d %H:00', log_time) as hour,
        count(*) as error_count
 FROM logline
 WHERE log_level = 'ERROR'
 GROUP BY hour
 ORDER BY hour
```

#### 認証成功率の算出

```sql
;SELECT
   count(CASE WHEN event_id = 'AUTH_OK' THEN 1 END) as success,
   count(CASE WHEN event_id IN ('AUTH_RES_MISMATCH', 'AUTH_MAC_INVALID',
     'AUTH_IMSI_NOT_FOUND', 'AUTH_POLICY_DENIED', 'AUTH_RESYNC_LIMIT')
     THEN 1 END) as failure,
   ROUND(100.0 * count(CASE WHEN event_id = 'AUTH_OK' THEN 1 END) /
     NULLIF(count(CASE WHEN event_id = 'AUTH_OK' THEN 1 END) +
     count(CASE WHEN event_id IN ('AUTH_RES_MISMATCH', 'AUTH_MAC_INVALID',
       'AUTH_IMSI_NOT_FOUND', 'AUTH_POLICY_DENIED', 'AUTH_RESYNC_LIMIT')
       THEN 1 END), 0), 1) as success_rate_pct
 FROM logline
```

#### アプリケーション別ログ件数

```sql
;SELECT log_level, count(*) as cnt
 FROM logline
 GROUP BY log_level
 ORDER BY cnt DESC
```

---

## 7. 認証フロー追跡手順

### 7.1 EAP-AKA認証フローのログ出現順序

正常な認証フローでは、以下の順序でログが出力される。

```
[Auth Server]   PKT_RECV          ← Access-Request (EAP-Identity) 受信
                                     trace_id 発行
    ↓
[Auth Server]   (Vector Gateway呼び出し)
    ↓
[Vector GW]     BACKEND_INTERNAL_CALL  ← 内部Vector API呼び出し
    ↓
[Vector API]    CALC_OK           ← ベクター生成成功
    ↓
[Vector GW]     GW_REQUEST_OK     ← ルーティング完了
    ↓
[Auth Server]   PKT_RECV          ← Access-Request (EAP-AKA Challenge応答) 受信
    ↓
[Auth Server]   AUTH_OK           ← 認証成功、Access-Accept送信
```

### 7.2 trace_idを使った複数コンポーネント横断追跡

**手順1:** Auth Serverのログから対象のtrace_idを特定する。

```sql
-- 直近の認証成功から trace_id を取得
;SELECT log_time, trace_id, imsi
 FROM logline
 WHERE event_id = 'AUTH_OK'
 ORDER BY log_time DESC
 LIMIT 10
```

**手順2:** 取得したtrace_idで全コンポーネントのログを横断検索する。

```sql
-- 全ログファイルを開いた状態で実行
;SELECT log_time, log_level, event_id, log_body
 FROM logline
 WHERE trace_id = '<取得したtrace_id>'
 ORDER BY log_time
```

**手順3:** 各ステップで以下を確認する。

| ステップ | event_id | 確認項目 |
|---------|----------|---------|
| パケット受信 | `PKT_RECV` | `src_ip`, `packet_code` が正しいこと |
| ルーティング | `BACKEND_INTERNAL_CALL` | `backend_id`, `backend_name` が期待値であること |
| ベクター生成 | `CALC_OK` | `latency_ms` が許容範囲内であること |
| ルーティング完了 | `GW_REQUEST_OK` | `http_status` が 200 であること |
| 認証成功 | `AUTH_OK` | `latency_ms` が許容範囲内、`session_uuid` が発行されていること |

### 7.3 Accountingフロー追跡

課金フローは以下の順序で出力される。

```
[Acct Server]   PKT_RECV     ← Accounting-Request 受信
    ↓
[Acct Server]   ACCT_START   ← セッション開始
    ↓ (一定間隔)
[Acct Server]   ACCT_INTERIM ← 中間更新（input_octets, output_octets）
    ↓
[Acct Server]   ACCT_STOP    ← セッション終了（session_time, 最終カウンター）
```

**特定セッションの課金レコード追跡:**

```sql
;SELECT log_time, event_id, imsi,
        input_octets, output_octets
 FROM logline
 WHERE event_id IN ('ACCT_START', 'ACCT_INTERIM', 'ACCT_STOP')
 ORDER BY log_time
```

---

## 8. 障害調査パターン

各パターンは「症状 → 確認手順 → 原因特定 → 対処」の流れで記載する。

### 8.1 認証失敗の調査

#### AUTH_RES_MISMATCH（XRES不一致）

**症状:** クライアントが送信したAT_RES（認証応答）がサーバーのXRES（期待値）と一致しない。

**確認手順:**

1. 対象のtrace_idを特定する。
   ```sql
   ;SELECT log_time, trace_id, imsi
    FROM logline
    WHERE event_id = 'AUTH_RES_MISMATCH'
    ORDER BY log_time DESC
    LIMIT 10
   ```

2. trace_idで認証フロー全体を確認する。
   ```sql
   ;SELECT log_time, event_id, log_body
    FROM logline
    WHERE trace_id = '<trace_id>'
    ORDER BY log_time
   ```

3. Vector APIでのベクター生成が成功しているか確認する（`CALC_OK` の存在）。

**原因特定:**
- SIMカードのKi/OPcとValkeyに登録された加入者データの不一致
- SQNずれ（再同期が必要だが `EAP_AUTH_REJECT` で拒否された場合）
- テスト用SIMと本番データの混在

**対処:**
- Admin TUIで加入者データ（Ki, OPc）を確認・修正する
- SQN再同期が発生している場合は `SQN_RESYNC` ログを確認する

#### AUTH_MAC_INVALID（MAC検証失敗）

**症状:** AT_MACの検証に失敗。鍵導出に問題がある可能性。

**確認手順:**

1. 対象のtrace_idとIMSIを特定する。
   ```sql
   ;SELECT log_time, trace_id, imsi
    FROM logline
    WHERE event_id = 'AUTH_MAC_INVALID'
    ORDER BY log_time DESC
   ```

2. 同一IMSIで `AUTH_OK` が過去にあったか確認する（以前は成功していたか）。
   ```sql
   ;SELECT log_time, event_id
    FROM logline
    WHERE imsi = '<対象IMSI>'
      AND event_id IN ('AUTH_OK', 'AUTH_MAC_INVALID')
    ORDER BY log_time DESC
    LIMIT 20
   ```

**原因特定:**
- Ki/OPcの不一致（加入者データ登録誤り）
- EAP-AKA/AKA' の方式選択ミス

**対処:**
- Admin TUIで加入者データを確認する
- パケットキャプチャとの照合で EAP方式を確認する

#### AUTH_IMSI_NOT_FOUND（IMSI未登録）

**症状:** Vector API が 404 を返却。加入者データが未登録。

**確認手順:**

1. 対象IMSIを確認する。
   ```sql
   ;SELECT log_time, imsi
    FROM logline
    WHERE event_id = 'AUTH_IMSI_NOT_FOUND'
    ORDER BY log_time DESC
   ```

2. Admin TUIで加入者データの存在を確認する。

**対処:**
- Admin TUIで加入者データを登録する
- IMSIの形式が正しいか確認する（15桁の数字列）

#### EAP_IDENTITY_INVALID（Identity不正）

**症状:** EAP Identityからの IMSI 抽出に失敗。

**確認手順:**

1. ログから `identity` フィールドの値を確認する。
   ```
   :filter-in event_id EAP_IDENTITY_INVALID
   ```

2. パケットキャプチャでEAP Identityペイロードを確認し、ログの `identity` と照合する。

**原因特定:**
- クライアントが不正なIdentity形式を送信している
- プレフィックス（`0`, `6`）が期待と異なる

**対処:**
- クライアント（サプリカント）の設定を確認する

### 8.2 接続障害の調査

#### Valkey接続障害（VALKEY_CONN_ERR → VALKEY_CONN_RESTORED）

**症状:** ValkeyへのKVS接続が失敗し、サービスが停止する。

**確認手順:**

1. 接続障害の発生・復旧タイムラインを確認する。
   ```sql
   ;SELECT log_time, event_id, downtime_ms, retry_count
    FROM logline
    WHERE event_id IN ('VALKEY_CONN_ERR', 'VALKEY_CONN_RESTORED')
    ORDER BY log_time
   ```

2. Valkeyコンテナのヘルスチェック状態を確認する。
   ```bash
   cd ~/eapaka-radius-server-poc/deployments && docker compose ps valkey
   ```

**原因特定:**
- Valkeyプロセスのクラッシュ
- メモリ上限（512MB）超過による `noeviction` 拒否
- ネットワーク障害

**対処:**
- `docker compose logs valkey` でValkeyのログを確認する
- メモリ使用量を確認する：`docker compose exec valkey valkey-cli -a $VALKEY_PASSWORD INFO memory`

#### Circuit Breaker状態遷移の追跡

**症状:** Auth ServerからVector Gatewayへの呼び出しが Circuit Breaker により遮断される。

**確認手順:**

1. Circuit Breakerの状態遷移を時系列で確認する。
   ```sql
   ;SELECT log_time, event_id, log_body
    FROM logline
    WHERE event_id IN ('CB_OPEN', 'CB_HALF_OPEN', 'CB_CLOSE')
    ORDER BY log_time
   ```

2. CB_OPENの直前に `VECTOR_API_ERR` が集中していないか確認する。
   ```sql
   ;SELECT log_time, event_id, http_status, latency_ms
    FROM logline
    WHERE event_id IN ('VECTOR_API_ERR', 'CB_OPEN')
    ORDER BY log_time DESC
    LIMIT 20
   ```

**原因特定:**
- Vector Gateway / Vector APIの障害
- ネットワーク遅延によるタイムアウト

**対処:**
- Vector Gateway / Vector APIのコンテナ状態を確認する
- `CB_CLOSE` が出力されていれば自動復旧済み

#### VECTOR_API_ERR（Vector Gateway呼び出し失敗）

**症状:** Auth ServerからVector Gatewayへの呼び出しが失敗。

**確認手順:**

1. エラー詳細を確認する。
   ```sql
   ;SELECT log_time, http_status, latency_ms, log_body
    FROM logline
    WHERE event_id = 'VECTOR_API_ERR'
    ORDER BY log_time DESC
    LIMIT 10
   ```

2. 対応する時間帯のVector Gatewayログを確認する。
   ```sql
   ;SELECT log_time, event_id, log_body
    FROM logline
    WHERE event_id IN ('BACKEND_INTERNAL_ERR', 'REQUEST_INVALID')
    ORDER BY log_time DESC
    LIMIT 10
   ```

**原因特定:**
- `http_status` = 0 → 接続自体の失敗（DNS解決失敗、ネットワーク不通）
- `http_status` = 500 → Vector API内部エラー
- `http_status` = 502/503 → Vector APIコンテナ停止

**対処:**
- コンテナの起動状態を確認する
- `latency_ms` が大きい場合はタイムアウト設定（`VECTOR_GATEWAY_INTERNAL_TIMEOUT`）を確認する

### 8.3 SQN再同期の調査

#### SQN_RESYNC（正常な再同期フロー）

**症状:** UICCとサーバー間のSQN（シーケンス番号）ずれが検出され、再同期が実行された。

**確認手順:**

```sql
;SELECT log_time, event_id, imsi, log_body
 FROM logline
 WHERE event_id IN ('SQN_RESYNC', 'SQN_RESYNC_MAC_ERR',
   'SQN_RESYNC_FORMAT_ERR', 'SQN_RESYNC_DECODE_ERR')
 ORDER BY log_time DESC
 LIMIT 20
```

**正常な再同期フロー:**
1. Auth Serverが `EAP_AUTH_REJECT` を検出
2. SQN再同期要求をVector APIに送信
3. Vector APIが `SQN_RESYNC`（成功）を出力

**異常パターン:**
- `SQN_RESYNC_MAC_ERR` → AUTS MAC検証失敗。Ki/OPcの不一致が疑われる
- `SQN_RESYNC_FORMAT_ERR` → AUTS形式不正（14バイトでない）
- `SQN_RESYNC_DECODE_ERR` → SQN抽出失敗

#### AUTH_RESYNC_LIMIT（再同期上限超過）

**症状:** 同一IMSIで再同期が32回を超え、認証が拒否された。

**確認手順:**

```sql
;SELECT log_time, imsi, resync_count
 FROM logline
 WHERE event_id = 'AUTH_RESYNC_LIMIT'
 ORDER BY log_time DESC
```

**対処:**
- Ki/OPcの不一致が根本原因である可能性が高い
- Admin TUIで加入者データを確認・再登録する
- 物理SIMカードの交換を検討する

#### SQN_CONFLICT_RETRY / SQN_CONFLICT_ERR（SQN更新競合）

**症状:** 同一IMSIに対する同時リクエストでSQN更新が競合。

**確認手順:**

```sql
;SELECT log_time, event_id, imsi, log_body
 FROM logline
 WHERE event_id IN ('SQN_CONFLICT_RETRY', 'SQN_CONFLICT_ERR')
 ORDER BY log_time DESC
```

**対処:**
- `SQN_CONFLICT_RETRY` → 自動リトライで解決するため通常は対処不要
- `SQN_CONFLICT_ERR` → リトライ上限超過。同一IMSIへの同時認証リクエストが過剰に集中している

### 8.4 課金データ不整合の調査

#### ACCT_SESSION_NOT_FOUND

**症状:** Accounting-Request受信時にセッションデータがValkeyに存在しない。

**確認手順:**

```sql
;SELECT log_time, log_body
 FROM logline
 WHERE event_id = 'ACCT_SESSION_NOT_FOUND'
 ORDER BY log_time DESC
```

**原因特定:**
- 認証なしの課金リクエスト（NASの設定不備）
- Valkeyのデータ消失（障害復旧後）
- セッションTTL（24h）超過

**対処:**
- Auth Serverログで対応する `AUTH_OK` が存在するか確認する
- Valkeyの障害履歴を確認する

#### ACCT_DUPLICATE_START

**症状:** 同一セッションに対してAccounting-Startが重複して受信された。

**確認手順:**

```sql
;SELECT log_time, log_body
 FROM logline
 WHERE event_id = 'ACCT_DUPLICATE_START'
 ORDER BY log_time DESC
```

**原因特定:**
- NASによるAccounting-Requestの再送
- NAS再起動によるセッション再開

**対処:**
- 通常はNASの正常な再送動作であり、対処不要

#### ACCT_SEQUENCE_ERR

**症状:** 課金イベントの順序が異常（例：StopなしでStartが到着）。

**確認手順:**

```sql
;SELECT log_time, event_id, log_body
 FROM logline
 WHERE event_id IN ('ACCT_START', 'ACCT_INTERIM', 'ACCT_STOP', 'ACCT_SEQUENCE_ERR')
 ORDER BY log_time DESC
 LIMIT 30
```

**対処:**
- NASの動作を確認する
- 前回セッションのSTOPが欠落していないか確認する

---

## 9. パフォーマンス分析

### 9.1 レスポンスタイム分析

#### Auth Server 認証レスポンスタイム

```sql
;SELECT
   count(*) as total,
   ROUND(AVG(latency_ms), 1) as avg_ms,
   MAX(latency_ms) as max_ms,
   MIN(latency_ms) as min_ms
 FROM logline
 WHERE event_id = 'AUTH_OK'
   AND latency_ms IS NOT NULL
```

#### Vector API ベクター生成レスポンスタイム

```sql
;SELECT
   count(*) as total,
   ROUND(AVG(latency_ms), 1) as avg_ms,
   MAX(latency_ms) as max_ms,
   MIN(latency_ms) as min_ms
 FROM logline
 WHERE event_id = 'CALC_OK'
   AND latency_ms IS NOT NULL
```

#### Vector Gateway ルーティングレスポンスタイム

```sql
;SELECT
   count(*) as total,
   ROUND(AVG(latency_ms), 1) as avg_ms,
   MAX(latency_ms) as max_ms,
   MIN(latency_ms) as min_ms
 FROM logline
 WHERE event_id = 'GW_REQUEST_OK'
   AND latency_ms IS NOT NULL
```

### 9.2 時間帯別スループット分析

```sql
;SELECT
   strftime('%Y-%m-%d %H:00', log_time) as hour,
   count(CASE WHEN event_id = 'AUTH_OK' THEN 1 END) as auth_ok,
   count(CASE WHEN event_id = 'ACCT_START' THEN 1 END) as acct_start,
   count(CASE WHEN event_id = 'ACCT_STOP' THEN 1 END) as acct_stop
 FROM logline
 WHERE event_id IN ('AUTH_OK', 'ACCT_START', 'ACCT_STOP')
 GROUP BY hour
 ORDER BY hour
```

### 9.3 ボトルネック特定手順

1. **全体のレスポンスタイム分布を確認する。**

   ```sql
   ;SELECT
      CASE
        WHEN latency_ms < 50 THEN '< 50ms'
        WHEN latency_ms < 100 THEN '50-100ms'
        WHEN latency_ms < 500 THEN '100-500ms'
        ELSE '> 500ms'
      END as range,
      count(*) as cnt
    FROM logline
    WHERE event_id = 'AUTH_OK'
      AND latency_ms IS NOT NULL
    GROUP BY range
    ORDER BY range
   ```

2. **遅延が大きいリクエストのtrace_idを取得する。**

   ```sql
   ;SELECT log_time, trace_id, latency_ms
    FROM logline
    WHERE event_id = 'AUTH_OK'
      AND latency_ms > 500
    ORDER BY latency_ms DESC
    LIMIT 10
   ```

3. **取得したtrace_idで各コンポーネントの処理時間を比較する。**

   ```sql
   ;SELECT log_time, event_id, latency_ms, log_body
    FROM logline
    WHERE trace_id = '<遅延trace_id>'
    ORDER BY log_time
   ```

4. **コンポーネント間の処理時間を比較し、ボトルネックを特定する。**
   - `CALC_OK` の `latency_ms` が大きい → Vector API（Milenage計算 or Valkeyアクセス）
   - `GW_REQUEST_OK` の `latency_ms` が大きい → Vector Gateway（ルーティング処理）
   - `AUTH_OK` の `latency_ms` が大きく、他が正常 → Auth Server（EAP処理、Valkeyアクセス）

---

## 10. E2Eテスト時のログ確認チェックリスト

### 10.1 テスト前の準備

- [ ] ログディレクトリの確認
  ```bash
  ls -la ~/eapaka-radius-server-poc/deployments/logs_on_host/
  ```

- [ ] 既存ログの退避（必要に応じて）
  ```bash
  mkdir -p ~/eapaka-radius-server-poc/deployments/logs_on_host/backup_$(date +%Y%m%d)
  cp ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log \
     ~/eapaka-radius-server-poc/deployments/logs_on_host/backup_$(date +%Y%m%d)/
  ```

- [ ] IMSIマスキング設定の確認
  ```bash
  # .envファイルでLOG_MASK_IMSIの設定を確認
  grep LOG_MASK_IMSI ~/eapaka-radius-server-poc/deployments/.env
  ```
  - E2Eテストで特定IMSIの追跡が必要な場合は `LOG_MASK_IMSI=false` を検討する
  - 変更した場合はコンテナの再起動が必要

- [ ] lnavフォーマット設定の確認
  ```bash
  lnav -C
  ```

- [ ] 全コンテナの起動確認
  ```bash
  cd ~/eapaka-radius-server-poc/deployments && docker compose ps
  ```

### 10.2 テスト実行中のリアルタイム監視

lnavは新しいログ行を自動的に追尾する（tail -f 相当）。

```bash
# 全ログをリアルタイム監視
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log

# 認証関連のみ監視（lnav起動後にフィルタ設定）
:filter-in event_id PKT_RECV|AUTH_OK|AUTH_RES_MISMATCH|AUTH_MAC_INVALID
```

**リアルタイム監視中のキー操作:**
- `G` — 最新行にジャンプ（末尾追尾に戻る）
- `e` — 次のエラー行にジャンプ（エラー発生を即座に確認）
- `w` — 次の警告行にジャンプ

### 10.3 テスト後の確認項目

#### エラーログの有無確認

```sql
-- ERRORレベルのログ一覧
;SELECT log_time, event_id, log_body
 FROM logline
 WHERE log_level = 'ERROR'
 ORDER BY log_time
```

```sql
-- WARNINGレベルのログ一覧
;SELECT log_time, event_id, log_body
 FROM logline
 WHERE log_level = 'WARNING'
 ORDER BY log_time
```

#### 認証成功率の確認

```sql
;SELECT
   count(CASE WHEN event_id = 'AUTH_OK' THEN 1 END) as success_count,
   count(CASE WHEN event_id IN ('AUTH_RES_MISMATCH', 'AUTH_MAC_INVALID',
     'AUTH_IMSI_NOT_FOUND', 'AUTH_POLICY_DENIED')
     THEN 1 END) as failure_count
 FROM logline
```

#### 課金レコード整合性の確認

```sql
-- セッションごとのSTART/STOP対応確認
;SELECT
   imsi,
   count(CASE WHEN event_id = 'ACCT_START' THEN 1 END) as starts,
   count(CASE WHEN event_id = 'ACCT_STOP' THEN 1 END) as stops
 FROM logline
 WHERE event_id IN ('ACCT_START', 'ACCT_STOP')
 GROUP BY imsi
```

#### 認証フローの追跡性確認

```sql
-- trace_idの一貫性確認（各コンポーネントに同一trace_idが出力されているか）
;SELECT trace_id,
        count(DISTINCT event_id) as event_types,
        GROUP_CONCAT(DISTINCT event_id) as events
 FROM logline
 WHERE trace_id IS NOT NULL
   AND trace_id != ''
 GROUP BY trace_id
 ORDER BY log_time DESC
 LIMIT 10
```

### 10.4 テスト結果のログエビデンス保全

テスト完了後、ログファイルをエビデンスとして保全する。

```bash
# タイムスタンプ付きでバックアップ
EVIDENCE_DIR=~/eapaka-radius-server-poc/test_evidence/$(date +%Y%m%d_%H%M%S)
mkdir -p "$EVIDENCE_DIR"
cp ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log "$EVIDENCE_DIR/"

# エビデンス一覧の確認
ls -la "$EVIDENCE_DIR/"
```

---

## 11. Admin TUI監査ログの確認

### 11.1 監査ログ（AUDIT_LOG）の確認方法

Admin TUIの操作は `AUDIT_LOG` イベントとして記録される。

```sql
-- 全監査ログの確認
;SELECT log_time, log_body
 FROM logline
 WHERE event_id = 'AUDIT_LOG'
 ORDER BY log_time DESC
```

### 11.2 操作履歴の追跡

```sql
-- 操作種別ごとの件数
;SELECT log_body, count(*) as cnt
 FROM logline
 WHERE event_id = 'AUDIT_LOG'
 GROUP BY log_body
 ORDER BY cnt DESC
```

**記録される操作種別:**
- 加入者データの作成（create）
- 加入者データの更新（update）
- 加入者データの削除（delete）
- CSVインポート（import）
- CSVエクスポート（export）
- ツール起動

### 11.3 危険な操作の検出

```sql
-- 大量削除等の危険操作
;SELECT log_time, log_body
 FROM logline
 WHERE event_id = 'BULK_OP'
 ORDER BY log_time DESC
```

### 11.4 操作エラーの確認

```sql
;SELECT log_time, log_body
 FROM logline
 WHERE event_id = 'OP_ERR'
 ORDER BY log_time DESC
```

### 11.5 IMSIマスキングに関する注意事項

Admin TUIは `LOG_MASK_IMSI` 環境変数の対象外であり、以下の特徴がある。

- **画面表示:** 常にIMSI全桁を表示する
- **監査ログ（`AUDIT_LOG`）:** IMSIを生値で記録する（`target_imsi` フィールド）
- **理由:** 管理操作や監査証跡でIMSIを確実に識別できる運用を優先

そのため、Admin TUIの `others.log`（または Admin TUI のログ出力先）には、マスキングされていないIMSIが含まれる。ログファイルのアクセス制御に留意すること。

---

## 12. ログローテーションとアーカイブ

### 12.1 logrotateの設定

logrotateにより、ログファイルは以下のとおりローテーションされる。

| 項目 | 設定値 |
|------|--------|
| ローテーション間隔 | 日次（daily） |
| 保持世代 | 30世代（rotate 30） |
| 圧縮 | gzip（compress, delaycompress） |
| ファイル名形式 | `{app}.log-{YYYYMMDD}` |

### 12.2 logrotateの動作確認

```bash
# logrotate設定ファイルの確認
cat /etc/logrotate.d/eapaka-radius-server-poc

# 手動テスト（dry-run）
sudo logrotate -d /etc/logrotate.d/eapaka-radius-server-poc

# 手動実行（強制ローテーション）
sudo logrotate -f /etc/logrotate.d/eapaka-radius-server-poc
```

### 12.3 ローテーション済みログの検索

```bash
# ローテーション済みファイルの一覧
ls -la ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log-*

# 圧縮ファイルの内容確認
zcat ~/eapaka-radius-server-poc/deployments/logs_on_host/auth-server.log-20260220.gz | head -20

# 圧縮ファイルを展開してlnavで閲覧
gunzip -k ~/eapaka-radius-server-poc/deployments/logs_on_host/auth-server.log-20260220.gz
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/auth-server.log-20260220

# 圧縮ファイル内の検索（grepを使用）
zgrep 'AUTH_RES_MISMATCH' ~/eapaka-radius-server-poc/deployments/logs_on_host/auth-server.log-*.gz
```

### 12.4 ログ保持期間と容量見積もり

| 項目 | 値 |
|------|-----|
| 保持期間 | 30日 |
| 1日あたりの推定容量（全ファイル合計） | 〜27MB |
| 30日間の推定容量（非圧縮） | 〜810MB |
| 30日間の推定容量（gzip圧縮後） | 〜80-100MB |

> 上記は想定負荷での見積もり。実際の容量はトラフィック量やログレベルにより変動する。

---

## 13. 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-02-22 | 初版作成 |
