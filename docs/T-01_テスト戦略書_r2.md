# T-01 テスト戦略書 (r2)

## 1. 概要

### 1.1 目的

本ドキュメントは、EAP-AKA RADIUS PoC環境のテスト戦略を定義する。テストレベルの定義、テスト対象範囲、テスト環境構成、モック戦略、テストデータ戦略、および品質ゲート（合格基準）を明確化し、効率的かつ効果的なテスト実施を可能にする。

### 1.2 スコープ

**本書で扱う範囲：**

- テストレベル定義（単体テスト、結合テスト、E2Eテスト）
- コンポーネント別テスト方針
- テスト環境構成
- モック戦略・テストダブルの使い分け
- テストデータ戦略
- 品質ゲート（合格基準）

**本書で扱わない範囲：**

| 範囲 | 参照先 |
|------|--------|
| 単体テストの詳細ケース | T-02 単体テスト仕様書 |
| 結合テストのシナリオ詳細 | T-03 結合テスト仕様書 |
| E2Eテストのシナリオ詳細 | T-04 E2Eテスト仕様書 |
| コーディング規約 | E-02 コーディング規約（簡易版） |
| 共通ライブラリ設計 | E-03 共通ライブラリ(pkg)設計書 |

### 1.3 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| D-01 ミニPC版設計仕様書 (r6) | システム構成、コンポーネント一覧 |
| D-02 Valkeyデータ設計仕様書 (r9) | データ構造、TTL設定、SQN競合制御方針 |
| D-03 Vector-API/ステートマシン設計書 (r4) | API仕様、EAP-AKA状態遷移、Vector Gateway経由 |
| D-04 ログ仕様設計書 (r11) | ログフォーマット、event_id定義、IMSIマスキング |
| D-06 エラーハンドリング詳細設計書 (r5) | 異常系パターン、タイムアウト値、SQN競合エラー |
| D-08 インフラ設定・運用設計書 (r7) | Docker Compose構成、テストベクターモード環境変数 |
| D-09 Auth Server詳細設計書 (r7) | パッケージ構成、インターフェース定義 |
| D-10 Acct Server詳細設計書 (r3) | パッケージ構成、重複検出 |
| D-11 Vector API詳細設計書 (r5) | テストモード実装、Milenage計算、SQN競合制御 |
| D-12 Vector Gateway詳細設計書 (r3) | PLMNルーティング、ベースイメージ方針 |
| E-01 開発環境セットアップガイド (r2) | 環境構築、環境変数設定 |
| E-02 コーディング規約（簡易版）(r1) | インターフェース設計、mockgen利用 |
| E-03 共通ライブラリ(pkg)設計書 (r1) | 共通インターフェース定義 |

### 1.4 PoC固有の考慮事項

本プロジェクトはPoC（Proof of Concept）であり、以下の方針を採用する。

| 項目 | 方針 |
|------|------|
| カバレッジ目標 | 主要パス重視（網羅率より実用性を優先） |
| E2Eテスト範囲 | 最小限のシナリオ（正常系＋主要異常系） |
| CI/CD | PoC段階では手動実行、将来検討として記載 |
| 性能テスト | PoC対象外として明記 |
| セキュリティテスト | PoC対象外（本番移行時に別途検討） |

---

## 2. テストレベル定義

### 2.1 テストピラミッド

本プロジェクトでは、以下のテストピラミッドに基づきテストを構成する。

```
                    /\
                   /  \
                  / E2E\        ← 少量（実機必須、高コスト）
                 /______\
                /        \
               /  結合    \     ← 中量（Docker Compose）
              /____________\
             /              \
            /    単体        \  ← 大量（モック活用、低コスト）
           /__________________\
```

| レベル | 比率目安 | 実行頻度 | 実行時間目安 |
|--------|---------|---------|-------------|
| 単体テスト | 70% | 開発時毎回 | 数秒〜1分 |
| 結合テスト | 25% | 機能完成時 | 1〜5分 |
| E2Eテスト | 5% | リリース前 | 5〜15分 |

### 2.2 単体テスト

**目的:** 個々の関数・メソッド・パッケージの動作を検証する。

| 項目 | 内容 |
|------|------|
| 対象 | 関数、メソッド、パッケージ単位 |
| 依存関係 | モックで置換（外部依存を排除） |
| 実行環境 | ローカル開発環境 |
| フレームワーク | Go標準 `testing` パッケージ |
| モック生成 | `mockgen`（uber-go/mock） |
| カバレッジツール | `go test -cover` |

**テスト対象レイヤー:**

| レイヤー | テスト内容 | モック対象 |
|---------|-----------|-----------|
| handler | リクエスト解析、レスポンス生成 | usecase |
| usecase | ビジネスロジック | repository, client |
| store | データアクセスロジック | Valkeyクライアント（miniredis） |
| domain | ドメインロジック（計算、検証） | なし（純粋関数） |

### 2.3 結合テスト

**目的:** 複数コンポーネント間の連携を検証する。

| 項目 | 内容 |
|------|------|
| 対象 | コンポーネント間連携、データフロー |
| 依存関係 | 実Valkey、実コンポーネント |
| 実行環境 | Docker Compose環境 |
| テストツール | Go標準 `testing`、httptest、radtest |
| データ準備 | テスト用初期データをValkeyに投入 |

**テスト範囲:**

| 連携パターン | 検証内容 |
|-------------|---------|
| Auth Server → Vector Gateway → Vector API | 認証ベクター取得フロー |
| Auth Server → Valkey | EAPコンテキスト管理、セッション作成 |
| Acct Server → Valkey | セッション更新、重複検出 |
| Admin TUI → Valkey | 加入者管理、ポリシー管理、セッション参照 |

### 2.4 E2Eテスト

**目的:** 実機を用いたエンドツーエンドの動作を検証する。

| 項目 | 内容 |
|------|------|
| 対象 | システム全体の動作 |
| 依存関係 | 実機SIM、実機AP（Wi-Fi アクセスポイント） |
| 実行環境 | 本番相当環境（ミニPC） |
| テストツール | eapaka_test（自作）、実SIM端末 |
| データ準備 | 実SIMに対応する加入者データを登録 |

**前提条件:**

| 項目 | 要件 |
|------|------|
| テスト用SIM | EAP-AKA対応SIM（IMSI/Ki/OPc既知） |
| Wi-Fi AP | WPA2-Enterprise対応、RADIUS設定可能 |
| 端末 | SIM挿入可能なWi-Fi対応デバイス |
| ネットワーク | AP → Auth Server/Acct Serverへの疎通 |

---

## 3. テスト対象と範囲

### 3.1 コンポーネント別テスト方針

5つのGoアプリケーションに対するテスト方針を定義する。

| コンポーネント | 単体テスト | 結合テスト | E2Eテスト |
|---------------|-----------|-----------|----------|
| Auth Server | ○ | ○ | ○ |
| Acct Server | ○ | ○ | ○ |
| Vector API | ○ | ○ | ○ |
| Vector Gateway | ○ | ○ | ○ |
| Admin TUI | ○ | ○ | △（手動確認） |

**凡例:** ○=自動テスト、△=手動テスト

### 3.2 Auth Server テスト方針

**パッケージ別テスト内容:**

| パッケージ | 単体テスト内容 |
|-----------|---------------|
| `config` | 環境変数読み込み、デフォルト値、バリデーション |
| `server` | PacketServer初期化、SecretSource動作 |
| `handler` | RADIUSパケット処理、レスポンス生成 |
| `radius` | パケット解析、属性抽出 |
| `eap` | EAPパケット解析、状態遷移 |
| `eap/aka` | EAP-AKA処理、MAC検証、MSK生成 |
| `vector` | VectorClientインターフェース、Circuit Breaker動作 |
| `policy` | ポリシー評価、AVP生成 |
| `session` | コンテキスト管理、セッション管理 |
| `store` | Valkey CRUD操作（miniredis使用） |

**結合テストシナリオ例:**

- EAP-AKA認証成功フロー（Identity → Challenge → Success）
- EAP-AKA'認証成功フロー
- 再同期フロー（AUTS受信 → 再Challenge）
- フル認証誘導フロー（Pseudonym → Identity要求）
- 認証失敗フロー（XRES不一致）

### 3.3 Acct Server テスト方針

**パッケージ別テスト内容:**

| パッケージ | 単体テスト内容 |
|-----------|---------------|
| `config` | 環境変数読み込み、デフォルト値 |
| `server` | UDPサーバー初期化、SecretSource動作 |
| `handler` | Accountingパケット処理 |
| `radius` | Acct-Status-Type判定、属性抽出 |
| `session` | セッション更新ロジック |
| `store` | Valkey操作、重複検出（miniredis使用） |

**結合テストシナリオ例:**

- Accounting-Start → Interim → Stop フロー
- 重複リクエスト検出（Acct-Session-Id重複）
- Status-Server応答

### 3.4 Vector API テスト方針

**パッケージ別テスト内容:**

| パッケージ | 単体テスト内容 |
|-----------|---------------|
| `config` | 環境変数読み込み、テストモード設定 |
| `server` | Ginサーバー初期化、ミドルウェア |
| `handler` | HTTPリクエスト処理、バリデーション |
| `usecase` | ベクター生成ロジック、再同期処理 |
| `milenage` | Milenage計算（3GPP TS 35.208テストベクター検証） |
| `sqn` | SQNインクリメント、デルタ検証 |
| `store` | 加入者データCRUD（miniredis使用） |
| `testmode` | テストモード判定、固定ベクター生成 |

**結合テストシナリオ例:**

- 正常ベクター生成（IMSI存在）
- 再同期処理（AUTS解析 → SQN更新）
- エラー応答（IMSI未登録、SQN範囲外）
- テストモード動作（固定ベクター返却）

### 3.5 Vector Gateway テスト方針

**パッケージ別テスト内容:**

| パッケージ | 単体テスト内容 |
|-----------|---------------|
| `config` | 環境変数読み込み、PLMNマップ解析 |
| `server` | Ginサーバー初期化 |
| `handler` | HTTPリクエスト転送 |
| `router` | PLMNルーティングロジック |
| `backend` | バックエンド接続管理 |

**結合テストシナリオ例:**

- 内部Vector APIへのパススルー
- PLMNベースルーティング（マップ設定時）
- 未登録PLMNのデフォルト動作
- X-Trace-ID伝搬確認

### 3.6 Admin TUI テスト方針

**パッケージ別テスト内容:**

| パッケージ | 単体テスト内容 |
|-----------|---------------|
| `config` | 環境変数読み込み |
| `store` | Valkey CRUD操作（miniredis使用） |
| `model` | データ変換、バリデーション |
| `ui` | 画面ロジック（UIフレームワーク依存部は除外） |

**手動テスト項目:**

- 加入者登録・編集・削除
- ポリシー設定
- セッション一覧表示・詳細表示
- インポート/エクスポート機能

### 3.7 テスト対象外（PoC除外項目）

以下はPoC範囲外とし、テスト対象としない。

| 項目 | 除外理由 |
|------|---------|
| 性能テスト | PoC目的は機能検証であり、性能要件は未定義 |
| 負荷テスト | 同上 |
| セキュリティテスト（ペネトレーション等） | 本番移行時に別途実施 |
| 可用性テスト（フェイルオーバー等） | PoC構成は単一ノード |
| 外部API連携（Vector Gateway Phase 2以降） | PoC Phase 1では内部パススルーのみ |
| Admin TUI UIレンダリングテスト | TUIフレームワーク依存、手動確認で代替 |

---

## 4. テスト環境

### 4.1 単体テスト環境

**構成:**

```
開発マシン（ローカル）
├── Go 1.25.x
├── テスト対象パッケージ
├── モック（mockgen生成）
└── miniredis（インメモリValkey）
```

**依存ツール:**

| ツール | 用途 | インストール |
|--------|------|-------------|
| Go 1.25.x | テスト実行 | E-01参照 |
| mockgen | モック生成 | `go install go.uber.org/mock/mockgen@latest` |
| miniredis | インメモリValkey | `go get github.com/alicebob/miniredis/v2` |

**実行方法:**

```bash
# 単一パッケージ
cd apps/auth-server
go test ./internal/handler/...

# 全パッケージ
go test ./...

# カバレッジ付き
go test -cover ./...

# 詳細カバレッジレポート
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### 4.2 結合テスト環境

**構成:**

```
Docker Compose環境
├── auth-server（テスト対象）
├── acct-server（テスト対象）
├── vector-gateway（テスト対象）
├── vector-api（テスト対象）
├── valkey（実インスタンス）
└── fluent-bit（ログ収集、任意）
```

**環境変数設定:**

```bash
# deployments/.env.test
VALKEY_PASSWORD=test_password_12345
RADIUS_SECRET_KEY=testing123
LOG_MASK_IMSI=false
TEST_VECTOR_ENABLED=true
TEST_VECTOR_IMSI_PREFIX=00101
```

**実行方法:**

```bash
cd deployments

# テスト用環境起動
docker compose -f docker-compose.yml -f docker-compose.test.yml up -d

# テスト実行
go test -tags=integration ./tests/integration/...

# 環境停止
docker compose down -v
```

### 4.3 E2Eテスト環境

**構成:**

```
ミニPC（Ubuntu Server）
├── Docker Compose環境（全コンポーネント）
├── Admin TUI（ホスト実行）
│
├── Wi-Fi AP（WPA2-Enterprise設定）
│   └── RADIUS設定: auth-server:1812, acct-server:1813
│
└── テスト端末（SIM挿入）
    └── Wi-Fi接続試行
```

**必要機材:**

| 機材 | 要件 | 備考 |
|------|------|------|
| ミニPC | Ubuntu Server 24.04、Docker対応 | D-08参照 |
| Wi-Fi AP | WPA2-Enterprise対応 | RADIUS設定可能なもの |
| テスト用SIM | EAP-AKA対応、IMSI/Ki/OPc既知 | sysmoISIM-SJA5 など検証用SIM |
| テスト端末 | SIM挿入可能、Wi-Fi対応 | スマートフォン等 |

**事前準備:**

1. Admin TUIで加入者データ登録（テストSIMのIMSI/Ki/OPc）
2. Admin TUIでRADIUSクライアント登録（APのIPアドレス）
3. Admin TUIでポリシー設定（テスト用SSID）
4. APのRADIUS設定（Auth/Acct Server指定）

---

## 5. モック戦略

### 5.1 モック対象インターフェース

E-02およびD-09で定義されたインターフェースをモック対象とする。

**Auth Server:**

| インターフェース | 定義場所 | モック用途 |
|-----------------|---------|-----------|
| `ContextStore` | `internal/session/interfaces.go` | EAPコンテキスト操作のモック |
| `SessionStore` | `internal/session/interfaces.go` | セッション操作のモック |
| `VectorClient` | `internal/vector/interfaces.go` | Vector Gateway呼び出しのモック |
| `PolicyStore` | `internal/policy/interfaces.go` | ポリシー取得のモック |
| `ClientStore` | `internal/store/interfaces.go` | RADIUSクライアント取得のモック |
| `Evaluator` | `internal/policy/interfaces.go` | ポリシー評価のモック |

**Vector API:**

| インターフェース | 定義場所 | モック用途 |
|-----------------|---------|-----------|
| `MilenageCalculator` | `internal/usecase/interfaces.go` | Milenage計算のモック |
| `ResyncProcessor` | `internal/usecase/interfaces.go` | 再同期処理のモック |
| `SQNManager` | `internal/usecase/interfaces.go` | SQN管理のモック |
| `SubscriberStore` | `internal/store/interfaces.go` | 加入者データ操作のモック |
| `TestVectorProvider` | `internal/testmode/interfaces.go` | テストモード判定のモック |

### 5.2 モック生成方法（mockgen）

**go:generate ディレクティブの記載:**

```go
// internal/usecase/interfaces.go

//go:generate mockgen -source=interfaces.go -destination=mock_interfaces.go -package=usecase

type SubscriberRepository interface {
    Get(ctx context.Context, imsi string) (*Subscriber, error)
    Create(ctx context.Context, sub *Subscriber) error
    Update(ctx context.Context, sub *Subscriber) error
    Delete(ctx context.Context, imsi string) error
}
```

**モック生成実行:**

```bash
# 個別パッケージ
cd apps/auth-server/internal/usecase
go generate ./...

# プロジェクト全体
cd apps/auth-server
go generate ./...
```

**生成されるファイル:**

```
internal/
├── usecase/
│   ├── interfaces.go       # インターフェース定義
│   └── mock_interfaces.go  # 自動生成モック
└── session/
    ├── interfaces.go
    └── mock_interfaces.go
```

### 5.3 テストダブルの使い分け

| 種類 | 用途 | 使用場面 |
|------|------|---------|
| **Mock** | 呼び出し検証、戻り値制御 | usecase、handlerのテスト |
| **Stub** | 固定値返却 | 外部サービス応答の模倣 |
| **Fake** | 簡易実装 | miniredis（インメモリValkey） |
| **Spy** | 呼び出し記録 | ログ出力検証 |

**使用例:**

```go
// Mock使用例（mockgen生成モック）
func TestAuthHandler_Success(t *testing.T) {
    ctrl := gomock.NewController(t)
    defer ctrl.Finish()

    mockUsecase := NewMockAuthUsecase(ctrl)
    mockUsecase.EXPECT().
        Authenticate(gomock.Any(), gomock.Any()).
        Return(&AuthResult{Success: true}, nil)

    handler := NewAuthHandler(mockUsecase)
    // テスト実行...
}

// Fake使用例（miniredis）
func TestContextStore_Create(t *testing.T) {
    mr := miniredis.RunT(t)
    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})
    store := NewContextStore(client)

    err := store.Create(ctx, "trace-001", &EAPContext{IMSI: "440101234567890"})
    assert.NoError(t, err)

    // Valkeyの内容を直接検証
    val, _ := mr.HGet("eap:trace-001", "imsi")
    assert.Equal(t, "440101234567890", val)
}
```

### 5.4 miniredis利用ガイドライン

**概要:** miniredisは、Valkey/Redisのインメモリ実装であり、単体テストでの利用に適している。

**利用方針:**

| 項目 | 方針 |
|------|------|
| 使用レベル | 単体テスト |
| 対象パッケージ | store層、session層 |
| 初期化方法 | `miniredis.RunT(t)` でテストごとに新規インスタンス |
| データ検証 | `mr.HGet()`, `mr.Keys()` 等で直接検証可能 |

**注意事項:**

- miniredisは全てのValkey/Redisコマンドをサポートしているわけではない
- Lua スクリプトは部分的サポート
- クラスタモードは非サポート（PoC範囲では不要）

---

## 6. テストデータ戦略

### 6.1 テスト用IMSI/Ki/OPc

**3GPP TS 35.208 テストベクター（Test Set 1）:**

D-11で定義されたテストベクターを使用する。

| 項目 | 値 |
|------|-----|
| Ki | `465b5ce8b199b49faa5f0a2ee238a6bc` |
| OPc | `cd63cb71954a9f4e48a5994e37a02baf` |
| RAND | `23553cbe9637a89d218ae64dae47bf35` |
| SQN | `0xff9bb4d0b607` |
| AMF | `b9b9` |
| XRES | `a54211d5e3ba50bf` |
| CK | `b40ba9a3c58b2a05bbf0d987b21bf8cb` |
| IK | `f769bcd751044604127672711c6d3441` |

**テスト用IMSIプレフィックス:**

| プレフィックス | 用途 | 環境変数 |
|---------------|------|---------|
| `00101` | 単体テスト・結合テスト用 | `TEST_VECTOR_IMSI_PREFIX` |
| `99999` | E2Eテスト用（実SIMと衝突しない値） | 個別設定 |

**テスト用IMSI例:**

```
00101000000000001  # Test Set 1 用
00101000000000002  # 追加テストケース用
99999123456789012  # E2Eテスト用（実SIMと同じフォーマット）
```

### 6.2 テスト用RADIUSクライアント

**単体テスト・結合テスト用:**

| 項目 | 値 |
|------|-----|
| IP Address | `192.168.100.10` |
| Shared Secret | `testing123` |
| NAS-Identifier | `test-ap-001` |

**E2Eテスト用:**

| 項目 | 値 |
|------|-----|
| IP Address | 実AP のIPアドレス |
| Shared Secret | AP設定と一致させる |
| NAS-Identifier | AP設定と一致させる |

### 6.3 テストモード（D-11 testmode）

**概要:** D-11で定義されたテストモードを活用し、結合テストで固定ベクターを返却する。

**環境変数設定:**

| 環境変数 | 結合テスト時 | E2Eテスト時 |
|---------|------------|------------|
| `TEST_VECTOR_ENABLED` | `true` | `false` |
| `TEST_VECTOR_IMSI_PREFIX` | `00101` | （未使用） |

**テストモード動作:**

1. `TEST_VECTOR_ENABLED=true` かつ IMSIが `TEST_VECTOR_IMSI_PREFIX` で始まる場合
2. Valkey参照をスキップし、3GPP TS 35.208 テストベクターを返却
3. 実際のSIM認証情報が不要になり、テスト環境構築が容易

> **本番環境での注意事項:**
> - 本番環境では `TEST_VECTOR_ENABLED=false`（デフォルト）で運用すること
> - テストベクターモードが有効な場合、固定の認証ベクターが返却され、**セキュリティリスク**となる
> - `.env` ファイルにこれらの環境変数を明示的に設定する場合は、必ず `false` を指定すること
> - 環境変数の詳細はD-08「インフラ設定・運用設計書」セクション4.2を参照

**利点:**

- 結合テストで実加入者データ不要
- 固定値により再現性のあるテストが可能
- Milenage計算の正確性を既知のベクターで検証可能

### 6.4 テストデータ投入方法

**単体テスト:** テストコード内でminiredisに直接投入

```go
func setupTestData(t *testing.T, mr *miniredis.Miniredis) {
    // 加入者データ
    mr.HSet("sub:00101000000000001",
        "ki", "465b5ce8b199b49faa5f0a2ee238a6bc",
        "opc", "cd63cb71954a9f4e48a5994e37a02baf",
        "amf", "8000",
        "sqn", "000000000001",
    )

    // RADIUSクライアント
    mr.HSet("client:192.168.100.10",
        "secret", "testing123",
        "name", "test-ap-001",
    )
}
```

**結合テスト:** Docker Compose起動後にvalkey-cliで投入

```bash
# スクリプト: tests/integration/setup_test_data.sh
docker compose exec valkey valkey-cli -a ${VALKEY_PASSWORD} <<EOF
HSET sub:00101000000000001 ki "465b5ce8b199b49faa5f0a2ee238a6bc" opc "cd63cb71954a9f4e48a5994e37a02baf" amf "8000" sqn "000000000001"
HSET client:192.168.100.10 secret "testing123" name "test-ap-001"
EOF
```

**E2Eテスト:** Admin TUIで手動登録、または初期データファイルをインポート

---

## 7. 品質ゲート（合格基準）

### 7.1 単体テスト基準

| 項目 | 基準 | 備考 |
|------|------|------|
| テスト成功率 | 100% | 全テストケースがPASS |
| 主要パスカバレッジ | 80%以上 | handler, usecase, store層 |
| 全体カバレッジ | 60%以上 | 参考値（必須ではない） |
| 静的解析 | エラー0件 | `go vet ./...` |
| フォーマット | 差分0件 | `gofmt -d .` |

**カバレッジ計測対象:**

| パッケージ | 必須カバレッジ |
|-----------|---------------|
| `internal/handler` | 80% |
| `internal/usecase` | 80% |
| `internal/store` | 80% |
| `internal/session` | 80% |
| `internal/milenage` | 90%（計算ロジック重要） |
| `internal/sqn` | 90%（計算ロジック重要） |
| `internal/config` | 70% |
| その他 | 60% |

### 7.2 結合テスト基準

| 項目 | 基準 | 備考 |
|------|------|------|
| テスト成功率 | 100% | 全シナリオがPASS |
| 正常系シナリオ | 全件PASS | 認証成功、課金記録 |
| 主要異常系シナリオ | 全件PASS | 認証失敗、再同期、タイムアウト |
| データ整合性 | 検証PASS | Valkeyデータの期待値一致 |

**必須シナリオ:**

| No. | シナリオ | 検証内容 |
|-----|---------|---------|
| INT-001 | EAP-AKA正常認証 | Identity → Challenge → Success |
| INT-002 | EAP-AKA'正常認証 | EAP-AKA'プロトコルでの認証成功 |
| INT-003 | 再同期フロー | AUTS受信 → SQN更新 → 再Challenge |
| INT-004 | 認証失敗（XRES不一致） | Failure応答 |
| INT-005 | Accountingフロー | Start → Interim → Stop |
| INT-006 | Vector Gateway経由 | X-Trace-ID伝搬確認 |

### 7.3 E2Eテスト基準

| 項目 | 基準 | 備考 |
|------|------|------|
| テスト成功率 | 100% | 全シナリオがPASS |
| 実機認証成功 | 1件以上 | 実SIMでWi-Fi接続成功 |
| ログ出力確認 | 正常 | 認証フローがログで追跡可能 |

**必須シナリオ:**

| No. | シナリオ | 検証内容 |
|-----|---------|---------|
| E2E-001 | 実SIM認証成功 | Wi-Fi接続成功、IP取得 |
| E2E-002 | Accounting記録 | セッション情報がValkeyに記録 |
| E2E-003 | Admin TUI確認 | セッション一覧に表示 |

### 7.4 静的解析基準

| ツール | 基準 | 実行コマンド |
|--------|------|-------------|
| go vet | エラー0件 | `go vet ./...` |
| gofmt | 差分0件 | `gofmt -d .` |
| staticcheck | エラー0件（推奨） | `staticcheck ./...` |
| golangci-lint | エラー0件（推奨） | `golangci-lint run` |

**設定ファイル例（.golangci.yml）:**

```yaml
run:
  timeout: 5m

linters:
  enable:
    - gofmt
    - govet
    - errcheck
    - staticcheck
    - unused
    - gosimple
    - ineffassign

issues:
  exclude-rules:
    - path: _test\.go
      linters:
        - errcheck
```

---

## 8. CI/CD連携（将来検討）

### 8.1 現状（PoC段階）

PoC段階では、テストは手動で実行する。

**手動実行フロー:**

```
1. 開発者がローカルで単体テスト実行
   └─ go test ./...

2. 機能完成時に結合テスト実行
   └─ Docker Compose起動 → テストスクリプト実行

3. リリース前にE2Eテスト実行
   └─ ミニPC環境で実機テスト
```

### 8.2 将来構想

本番移行時には、以下のCI/CDパイプラインを検討する。

**GitHub Actions構成案:**

```yaml
# .github/workflows/test.yml（将来検討）
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Run unit tests
        run: go test -cover ./...

  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test
    services:
      valkey:
        image: valkey/valkey:9.0
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Run integration tests
        run: go test -tags=integration ./tests/integration/...
```

**検討事項:**

| 項目 | 検討内容 |
|------|---------|
| トリガー | Push/PR時に自動実行 |
| 並列実行 | 単体テスト → 結合テスト（依存関係） |
| キャッシュ | Go modules、Dockerイメージ |
| E2Eテスト | 実機必須のため自動化困難、手動維持 |

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-01-25 | 初版作成 |
| r2 | 2026-01-27 | レビュー反映: 関連ドキュメント参照バージョン更新（Phase 1-4反映）、セクション6.3にテストベクターモードの本番環境注意事項を追加 |
