# O-03 障害対応手順書 (r1)

## 1. 概要

### 1.1 目的

本手順書は、EAP-AKA RADIUS PoC環境の**サービス運用中**に発生する障害について、検知・切り分け・復旧・エスカレーションの手順を体系的にまとめたものである。

デプロイ時の問題についてはB-02 §13「トラブルシューティング」を参照すること。

### 1.2 対象読者

- 運用担当者（一次対応）
- 開発担当者（二次対応・エスカレーション先）

### 1.3 前提条件

- B-02に基づくデプロイが完了し、全サービスが正常稼働していること
- O-05「ログ解析ガイド」の基本操作（lnavの使い方、event_idの意味）を理解していること
- ホストOSへのSSHアクセスが可能であること

### 1.4 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| D-04 ログ仕様設計書 (r15) | event_id定義、ログフォーマット仕様 |
| D-06 エラーハンドリング詳細設計書 (r6) | エラー分類・重大度、耐障害性パターン |
| D-08 インフラ設定・運用設計書 (r12) | ヘルスチェック設定、バックアップ・リストア、運用手順 |
| B-02 アプリケーションデプロイ手順書 (r7) | デプロイ手順、デプロイ時トラブルシューティング |
| O-01 操作ガイド (r1) | Admin TUI操作手順 |
| O-05 ログ解析ガイド (r3) | lnav操作、event_idリファレンス、障害調査パターン |

### 1.5 障害対応の基本フロー

障害対応は以下の4ステップで実施する。

```
  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
  │  1.検知   │───▶│ 2.切り分け│───▶│  3.復旧   │───▶│  4.記録   │
  │          │    │          │    │          │    │          │
  │ ログ監視  │    │ コンポーネ│    │ 再起動    │    │ 障害報告  │
  │ ヘルスチェ│    │ ント別判定│    │ データ復旧│    │ エビデンス│
  │ ック      │    │          │    │ 設定修正  │    │ 保全     │
  └──────────┘    └──────────┘    └──────────┘    └──────────┘
                         │
                    一次対応で
                    解決不可の場合
                         │
                         ▼
                  ┌──────────────┐
                  │ エスカレーション│
                  │ （§6参照）     │
                  └──────────────┘
```

---

## 2. 障害検知

### 2.1 障害レベル定義

D-06 §2.2に基づく4段階の重大度レベルを定義する。

| レベル | 定義 | ログレベル | 対応方針 |
|--------|------|-----------|---------|
| **Critical** | サービス継続不可 | ERROR | 即座に復旧手順を実行 |
| **Error** | 個別リクエスト失敗 | ERROR / WARN | ログ記録、原因調査 |
| **Warning** | 潜在的問題 | WARN | ログ記録、頻度監視 |
| **Info** | 正常範囲内の注目イベント | INFO | ログ記録 |

### 2.2 監視対象event_id一覧

D-04 §4〜§8で定義されるevent_idを、運用上の対応アクション有無で3段階に分類する。

#### 即対応（Critical） — 復旧手順を即実行

| event_id | ノード | 説明 | 参照 |
|----------|--------|------|------|
| SYS_ERR | Auth Server | システム障害（Panic等） | §4.1 |
| VALKEY_CONN_ERR | Auth / Acct / Vector API | Valkey接続失敗 | §4.1 |
| VALKEY_AUTH_ERR | Auth Server | Valkey認証失敗 | §4.1 |
| VECTOR_API_ERR | Auth Server | Vector Gateway呼び出し失敗 | §4.2 |
| DB_WRITE_ERR | Acct Server | Valkey書き込み失敗 | §4.3 |
| BACKEND_INTERNAL_ERR | Vector Gateway | 内部Vector API呼び出し失敗 | §4.4 |
| OP_ERR | Admin TUI | 操作失敗 | — |

#### 監視（Warning） — 原因調査・頻度監視

| event_id | ノード | 説明 | 参照 |
|----------|--------|------|------|
| CB_OPEN | Auth Server | Circuit Breaker Open遷移 | §4.2 |
| AUTH_RES_MISMATCH | Auth Server | AT_RESとXRES不一致 | §4.2 |
| AUTH_MAC_INVALID | Auth Server | AT_MAC検証失敗 | §4.2 |
| AUTH_CONTEXT_NOT_FOUND | Auth Server | EAPコンテキスト不在 | §4.2 |
| AUTH_RESYNC_LIMIT | Auth Server | 再同期リトライ上限超過 | §4.2 |
| ACCT_SESSION_NOT_FOUND | Acct Server | セッション不在 | §4.3 |
| ACCT_SESSION_EXPIRED | Acct Server | セッションTTL超過 | §4.3 |
| ACCT_DUPLICATE_START | Acct Server | 重複Start受信 | §4.3 |
| ACCT_SEQUENCE_ERR | Acct Server | 順序異常 | §4.3 |
| REQUEST_INVALID | Vector Gateway | リクエスト形式不正 | §4.4 |
| SQN_CONFLICT_ERR | Vector API | SQN更新競合リトライ上限超過 | §4.5 |
| SQN_RESYNC_MAC_ERR | Vector API | AUTS MAC検証失敗 | §4.5 |
| CALC_ERR | Vector API | 計算エラー | §4.5 |

#### 情報（Info） — 運用上の正常ケースを含む

| event_id | ノード | 説明 |
|----------|--------|------|
| AUTH_IMSI_NOT_FOUND | Auth Server | IMSI未登録（Vector API 404） |
| AUTH_POLICY_NOT_FOUND | Auth Server | ポリシー未設定 |
| AUTH_POLICY_DENIED | Auth Server | ポリシールール不一致 |
| EAP_UNSUPPORTED_TYPE | Auth Server | 非対応EAP方式検出 |
| EAP_PSEUDONYM_FALLBACK | Auth Server | 仮名からフル認証へ誘導 |
| VALKEY_CONN_RESTORED | Auth / Acct / Vector API | Valkey接続復旧 |
| CB_HALF_OPEN | Auth Server | Circuit Breaker Half-Open遷移 |
| CB_CLOSE | Auth Server | Circuit Breaker Close復帰 |
| SQN_RESYNC | Vector API | SQN再同期実行成功 |
| SQN_CONFLICT_RETRY | Vector API | SQN更新競合検出、リトライ実行 |

### 2.3 lnavによるリアルタイム監視手順

lnavを使用してログをリアルタイム監視する。詳細な操作方法はO-05 §4を参照。

```bash
# 全サービスのログをリアルタイム監視
lnav ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log

# ERRORレベルのみフィルタリング（lnav内で実行）
:filter-in log_level = "error"

# 特定のevent_idでフィルタリング
:filter-in event_id = "VALKEY_CONN_ERR"
```

ERROR/WARNレベルのイベント発生頻度をSQLで確認する（lnav内で `;` キーでSQLモードに入る）。

```sql
;SELECT event_id, count(*) as cnt
  FROM all_logs
  WHERE log_level IN ('error', 'warning')
    AND log_time > datetime('now', '-1 hour')
  GROUP BY event_id
  ORDER BY cnt DESC
```

### 2.4 ヘルスチェックによる定期確認手順

D-08 §4.3で定義されたヘルスチェックを手動で実行して状態を確認する。

```bash
# 全コンテナの状態確認
cd ~/eapaka-radius-server-poc/deployments
docker compose ps

# Valkey接続確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" ping

# Vector Gateway ヘルスチェック
curl -fsS http://localhost:8080/health

# Vector API ヘルスチェック
curl -fsS http://localhost:8081/health

# リソース使用状況
docker stats --no-stream
```

---

## 3. 障害切り分けフローチャート

### 3.1 初動確認フロー

障害報告を受けたら、以下のフローに従って全コンテナの状態を確認する。

```
[障害報告受信]
      │
      ▼
[docker compose ps で全コンテナ状態確認]
      │
      ├─ 停止中のコンテナあり ──▶ [§3.2 コンポーネント別切り分け]
      │                              │
      │                              ├─ valkey停止 ──────▶ §4.1 Valkey障害
      │                              ├─ auth-server停止 ─▶ §4.2 Auth Server障害
      │                              ├─ acct-server停止 ─▶ §4.3 Acct Server障害
      │                              ├─ vector-gw停止 ───▶ §4.4 Vector Gateway障害
      │                              ├─ vector-api停止 ──▶ §4.5 Vector API障害
      │                              ├─ fluent-bit停止 ──▶ §4.6 Fluent Bit障害
      │                              └─ 複数停止 ────────▶ §4.7 Docker/systemd障害
      │
      ├─ 全コンテナ稼働中 ──▶ [ログでエラー確認]
      │                          │
      │                          ├─ VALKEY_CONN_ERR ──▶ §4.1
      │                          ├─ VECTOR_API_ERR ───▶ §4.2
      │                          ├─ CB_OPEN ──────────▶ §4.2
      │                          ├─ AUTH_* エラー ─────▶ §4.2
      │                          ├─ ACCT_* エラー ─────▶ §4.3
      │                          ├─ BACKEND_* エラー ──▶ §4.4
      │                          ├─ SQN_*/CALC_ERR ───▶ §4.5
      │                          └─ ログ未出力 ────────▶ §4.6
      │
      └─ docker compose 自体が失敗 ──▶ §4.7 Docker/systemd障害
```

### 3.2 コンポーネント別切り分け判定表

| 症状 | 確認コマンド | 判定先 |
|------|------------|--------|
| Valkey接続エラーが複数ノードで発生 | `docker compose ps valkey` | §4.1 |
| 認証リクエストが全て失敗 | `docker compose logs --tail 20 auth-server` | §4.2 |
| Vector Gateway応答なし | `curl -fsS http://localhost:8080/health` | §4.4 |
| 課金データが記録されない | `docker compose logs --tail 20 acct-server` | §4.3 |
| ログファイルが更新されない | `ls -lt ~/eapaka-radius-server-poc/deployments/logs_on_host/` | §4.6 |
| コンテナが再起動を繰り返す | `docker compose ps`（Restarting表示） | §4.7 |

---

## 4. コンポーネント別障害対応

### 4.1 Valkey障害

#### 4.1.1 VALKEY_CONN_ERR — Valkey接続断

**症状:** Auth Server / Acct Server / Vector APIのログに `VALKEY_CONN_ERR` が出力され、全てのリクエストが失敗する。

**確認手順:**

```bash
# Valkeyコンテナの状態確認
cd ~/eapaka-radius-server-poc/deployments
docker compose ps valkey

# Valkeyログの確認
docker compose logs --tail 50 valkey

# 手動接続テスト
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" ping
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Valkeyコンテナが停止している | `docker compose up -d valkey` で再起動 |
| メモリ不足でValkeyがOOM Killed | `docker stats --no-stream` でメモリ確認後、§4.1.3参照 |
| AOFファイル破損 | §4.1.4参照 |

> **参考:** D-06 §4.4（Graceful Degradation）、O-05 §8.2（接続障害の調査）

#### 4.1.2 VALKEY_AUTH_ERR — Valkey認証失敗

**症状:** Auth Serverのログに `VALKEY_AUTH_ERR` が出力される。Valkey自体は稼働しているが接続が拒否される。

**確認手順:**

```bash
# Valkeyの応答確認（パスワードなし）
docker compose exec valkey valkey-cli ping

# .envのパスワード確認
grep VALKEY_PASSWORD ~/eapaka-radius-server-poc/deployments/.env
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| `.env` のパスワードとValkey設定が不一致 | `.env` の `VALKEY_PASSWORD` を確認し、全サービスを再起動 |
| コンテナ再ビルド時に環境変数が反映されていない | `docker compose down && docker compose up -d` で再起動 |

> **参考:** D-08 §2.1（Valkey設定）、B-02 §13.2

#### 4.1.3 メモリ超過

**症状:** Valkeyが応答しない、またはOOM Killedでコンテナが停止する。

**確認手順:**

```bash
# Valkeyメモリ使用量の確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" info memory

# コンテナのメモリ使用状況
docker stats --no-stream valkey

# OOM Killedの確認
docker inspect valkey --format='{{.State.OOMKilled}}'
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| セッションデータの蓄積 | 期限切れセッションの確認: `valkey-cli -a "${VALKEY_PASSWORD}" dbsize` |
| maxmemory設定が不適切 | D-08 §2.2のメモリ設定を確認し、必要に応じて調整 |

> **参考:** D-08 §2.2（メモリ設定）

#### 4.1.4 AOFファイル破損

**症状:** Valkeyが起動時にエラーで停止する。ログに `Bad file format reading the append only file` 等が出力される。

**確認手順:**

```bash
# Valkeyログの確認
docker compose logs --tail 50 valkey
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| 予期しないシャットダウンによるAOF破損 | AOF修復を試行: `docker compose exec valkey valkey-check-aof --fix /data/appendonly.aof` |
| AOF修復が不可能 | §5.3のバックアップリストア手順を実行 |

> **参考:** D-08 §2.4（バックアップ・リストア）

#### 4.1.5 Valkey復旧手順まとめ

```
[Valkey障害検知]
      │
      ├─ コンテナ停止 ──▶ docker compose up -d valkey
      │                       │
      │                  起動成功？
      │                  ├─ Yes ──▶ 復旧完了
      │                  └─ No ───▶ AOF破損？
      │                              ├─ Yes ──▶ valkey-check-aof --fix
      │                              │              │
      │                              │         修復成功？
      │                              │         ├─ Yes ──▶ 再起動
      │                              │         └─ No ───▶ バックアップリストア（§5.3）
      │                              └─ No ───▶ ログ確認・エスカレーション（§6）
      │
      └─ 接続エラー ──▶ パスワード確認 → 全サービス再起動（§5.2）
```

### 4.2 Auth Server障害

#### 4.2.1 VECTOR_API_ERR — Vector Gateway接続エラー

**症状:** Auth Serverのログに `VECTOR_API_ERR` が出力され、認証ベクターの取得に失敗する。全ての新規認証がAccess-Rejectとなる。

**確認手順:**

```bash
# Vector Gatewayの状態確認
curl -fsS http://localhost:8080/health

# Auth Serverのログでエラー詳細を確認
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 auth-server | grep VECTOR_API_ERR
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Vector Gatewayが停止している | `docker compose up -d vector-gw` で再起動 |
| Vector APIが停止している | `docker compose up -d vector-api` で再起動 |
| ネットワーク（Docker内部）の問題 | `docker compose down && docker compose up -d` で全サービス再起動 |

> **参考:** D-06 §3.1（Auth Serverエラー処理）、D-06 §4.1（タイムアウト設定）

#### 4.2.2 CB_OPEN — Circuit Breaker Open状態

**症状:** Auth Serverのログに `CB_OPEN` が出力される。Vector Gateway障害が継続し、Circuit BreakerがOpen状態に遷移したことを示す。Open状態中は全認証がAccess-Rejectとなる。

**確認手順:**

```bash
# Circuit Breaker状態遷移の確認
cd ~/eapaka-radius-server-poc/deployments
docker compose logs auth-server | grep -E "CB_OPEN|CB_HALF_OPEN|CB_CLOSE"
```

lnavで状態遷移を時系列で確認:

```sql
;SELECT log_time, event_id
  FROM all_logs
  WHERE event_id LIKE 'CB_%'
  ORDER BY log_time DESC
  LIMIT 20
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Vector Gateway/APIの一時的障害 | Vector Gateway/APIの復旧を確認（§4.4, §4.5）。30秒後にHalf-Openに自動遷移 |
| Vector Gateway/APIの永続的障害 | §4.4, §4.5の復旧手順を実行後、§5.4でCB復旧を確認 |

> **参考:** D-06 §4.3（Circuit Breaker設定: 失敗5回/10秒でOpen、30秒後Half-Open、成功2回でClose）

#### 4.2.3 AUTH_RES_MISMATCH / AUTH_MAC_INVALID — 認証失敗の頻発

**症状:** Auth Serverのログに `AUTH_RES_MISMATCH` または `AUTH_MAC_INVALID` が頻発する。特定または全ての加入者の認証が失敗する。

**確認手順:**

```bash
# 認証失敗の頻度確認
cd ~/eapaka-radius-server-poc/deployments
docker compose logs auth-server | grep -E "AUTH_RES_MISMATCH|AUTH_MAC_INVALID" | tail -20
```

lnavで影響範囲を確認:

```sql
;SELECT event_id, count(*) as cnt
  FROM all_logs
  WHERE event_id IN ('AUTH_RES_MISMATCH', 'AUTH_MAC_INVALID')
    AND log_time > datetime('now', '-1 hour')
  GROUP BY event_id
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| 特定加入者のKi/OPcが不正 | Admin TUIで該当加入者の認証情報を確認・修正（O-01 §3.3） |
| SQNの不整合 | §5.5のSQNリセット手順を実行 |
| 全加入者で発生する場合 | 開発担当者へエスカレーション（§6） |

> **参考:** O-05 §8.1（認証失敗の調査）

#### 4.2.4 AUTH_CONTEXT_NOT_FOUND — EAPコンテキスト消失

**症状:** Auth Serverのログに `AUTH_CONTEXT_NOT_FOUND` が出力される。EAP認証の途中でState属性に対応するコンテキストが見つからない。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 auth-server | grep AUTH_CONTEXT_NOT_FOUND
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| EAPコンテキストのTTL超過（クライアント応答遅延） | 通常は一時的。頻発する場合はネットワーク遅延を調査 |
| Valkey再起動によるコンテキスト消失 | 端末側で再認証が自動的に行われる。一時的な事象 |
| Auth Server再起動 | 進行中の認証セッションが失われる。端末側で再認証 |

> **参考:** D-06 §3.1（Auth Serverエラー処理）

#### 4.2.5 AUTH_RESYNC_LIMIT — SQN再同期上限超過

**症状:** Auth Serverのログに `AUTH_RESYNC_LIMIT` が出力される。特定加入者のSQN再同期が32回の上限を超過した。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs auth-server | grep AUTH_RESYNC_LIMIT
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| SQNの大幅な不整合 | §5.5のSQNリセット手順を実行 |
| 不正な端末からの攻撃的なリクエスト | 該当IMSIのログを調査し、必要に応じてポリシーで拒否設定（O-02参照） |

> **参考:** O-05 §8.3（SQN再同期の調査）

#### 4.2.6 SYS_ERR — パニック/システムエラー

**症状:** Auth Serverのログに `SYS_ERR` が出力される。プロセスのPanicやメモリ不足等のシステムレベルのエラー。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 50 auth-server | grep SYS_ERR

# コンテナの状態確認
docker compose ps auth-server
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Panic（プログラムバグ） | コンテナを再起動（§5.1）。ログを保全し開発担当者へエスカレーション（§6） |
| メモリ不足 | `docker stats --no-stream` でリソース確認。必要に応じてコンテナのリソース制限を調整 |

> **参考:** D-06 §2.2（重大度レベル定義）

### 4.3 Acct Server障害

#### 4.3.1 ACCT_SESSION_NOT_FOUND / ACCT_SESSION_EXPIRED — セッション不在

**症状:** Acct Serverのログに `ACCT_SESSION_NOT_FOUND` または `ACCT_SESSION_EXPIRED` が出力される。Accounting-Request（Interim/Stop）の処理対象セッションが見つからない。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 acct-server | grep -E "ACCT_SESSION_NOT_FOUND|ACCT_SESSION_EXPIRED"
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| セッションTTL超過（24h経過で自動削除） | 正常動作。長時間セッションの場合はInterim-Updateの間隔を確認 |
| Valkey再起動によるセッション消失 | Valkey復旧後、端末が再接続すれば新セッションが作成される |
| Accounting-Start未受信 | NAS側の設定を確認。Auth成功後にStartが送信されているかログで確認 |

> **参考:** O-05 §8.4（課金データ不整合の調査）

#### 4.3.2 DB_WRITE_ERR — Valkey書き込み失敗

**症状:** Acct Serverのログに `DB_WRITE_ERR` が出力される。課金データの保存に失敗している。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 acct-server | grep DB_WRITE_ERR

# Valkey接続状態の確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" ping
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Valkey接続断 | §4.1の手順でValkey復旧を実施 |
| Valkeyメモリ不足 | §4.1.3の手順でメモリ状況を確認 |

> **参考:** D-06 §3.2（Acct Serverエラー処理）

#### 4.3.3 ACCT_DUPLICATE_START / ACCT_SEQUENCE_ERR — 重複・順序異常

**症状:** Acct Serverのログに `ACCT_DUPLICATE_START` または `ACCT_SEQUENCE_ERR` が出力される。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs acct-server | grep -E "ACCT_DUPLICATE_START|ACCT_SEQUENCE_ERR" | tail -20
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| NASからの重複リクエスト送信 | 通常は一時的。NAS側のリトライ設定を確認 |
| ネットワーク遅延による再送 | 通常は一時的。頻発する場合はネットワーク品質を確認 |
| NAS側のAccounting設定不備 | NAS側のAccounting設定（Start/Interim/Stop送信順序）を確認 |

> **参考:** O-05 §8.4（課金データ不整合の調査）

### 4.4 Vector Gateway障害

#### 4.4.1 BACKEND_INTERNAL_ERR — バックエンド呼び出し失敗

**症状:** Vector Gatewayのログに `BACKEND_INTERNAL_ERR` が出力される。内部Vector APIへのリクエストが失敗している。

**確認手順:**

```bash
# Vector Gatewayのヘルスチェック
curl -fsS http://localhost:8080/health

# Vector APIのヘルスチェック
curl -fsS http://localhost:8081/health

# Vector Gatewayのエラーログ確認
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 vector-gw | grep BACKEND_INTERNAL_ERR
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Vector APIが停止している | `docker compose up -d vector-api` で再起動 |
| Vector APIのValkey接続障害 | §4.1の手順でValkey復旧を実施 |
| Vector APIの内部エラー | §4.5の手順で原因を調査 |

> **参考:** D-06 §3.3（Vector Gatewayエラー処理）

#### 4.4.2 REQUEST_INVALID — リクエスト形式不正

**症状:** Vector Gatewayのログに `REQUEST_INVALID` が出力される。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 vector-gw | grep REQUEST_INVALID
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| IMSI形式エラー | Auth Serverからのリクエスト内容を確認。加入者データのIMSI登録値を確認 |
| Auth Serverのバグ | ログを保全し開発担当者へエスカレーション（§6） |

> **参考:** D-06 §3.3（Vector Gatewayエラー処理）

### 4.5 Vector API障害

#### 4.5.1 SQN_CONFLICT_ERR — SQN競合エラー

**症状:** Vector APIのログに `SQN_CONFLICT_ERR` が出力される。SQN更新のリトライが上限を超過した。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs vector-api | grep -E "SQN_CONFLICT_RETRY|SQN_CONFLICT_ERR" | tail -20
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| 同一加入者への同時認証リクエスト | 通常は `SQN_CONFLICT_RETRY` でリトライ成功する。ERRが頻発する場合は負荷状況を確認 |
| Valkeyの応答遅延 | §4.1の手順でValkey状態を確認 |

> **参考:** O-05 §8.3（SQN再同期の調査）

#### 4.5.2 SQN_RESYNC_MAC_ERR — SQN再同期MAC検証失敗

**症状:** Vector APIのログに `SQN_RESYNC_MAC_ERR` が出力される。AUTS（Authentication Token for Synchronization）のMAC検証に失敗した。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs vector-api | grep SQN_RESYNC_MAC_ERR | tail -10
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Ki/OPcの不整合 | Admin TUIで該当加入者の認証情報を確認・修正（O-01 §3.3） |
| 不正な端末からのリクエスト | 該当IMSIのログを精査。必要に応じてポリシーで対応（O-02参照） |

> **参考:** O-05 §8.3（SQN再同期の調査）

#### 4.5.3 CALC_ERR — Milenage計算エラー

**症状:** Vector APIのログに `CALC_ERR` が出力される。認証ベクターの計算処理でエラーが発生した。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments
docker compose logs --tail 30 vector-api | grep CALC_ERR
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| IMSI未登録（404応答） | 正常動作。必要に応じてAdmin TUIで加入者を登録 |
| Ki/OPcのフォーマット不正 | Admin TUIで該当加入者の認証情報を確認（O-01 §3.3） |
| 予期せぬ内部エラー | ログを保全し開発担当者へエスカレーション（§6） |

> **参考:** D-06 §3.4（Vector APIエラー処理）

### 4.6 Fluent Bit / ログ出力障害

#### 4.6.1 ログ未出力

**症状:** `logs_on_host/` ディレクトリにログファイルが作成されない、またはログが更新されない。

**確認手順:**

```bash
# Fluent Bitコンテナの状態確認
cd ~/eapaka-radius-server-poc/deployments
docker compose ps fluent-bit

# Fluent Bitのログ確認
docker compose logs --tail 30 fluent-bit

# ログファイルの最終更新時刻を確認
ls -lt ~/eapaka-radius-server-poc/deployments/logs_on_host/
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| Fluent Bitが停止している | `docker compose up -d fluent-bit` で再起動 |
| 設定ファイルのエラー | `configs/fluent-bit/fluent-bit.yaml` の内容を確認 |
| ログディレクトリの権限不足 | `chmod 755 ~/eapaka-radius-server-poc/deployments/logs_on_host/` |

> **参考:** D-08 §3（Fluent Bit設定）、B-02 §13.3

#### 4.6.2 ログローテーション異常

**症状:** ログファイルが肥大化している、またはローテーションされたログが見つからない。

**確認手順:**

```bash
# ログファイルサイズの確認
du -sh ~/eapaka-radius-server-poc/deployments/logs_on_host/*

# logrotateの状態確認
sudo logrotate -d /etc/logrotate.d/eapaka-radius
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| logrotate設定が未適用 | D-08 §3のローテーション設定を確認・適用 |
| ディスク容量不足 | `df -h` で確認。古いログの削除: `find ~/eapaka-radius-server-poc/deployments/logs_on_host/ -name "*.log.*" -mtime +30 -delete` |

> **参考:** D-08 §3（Fluent Bit設定）、O-05 §12（ログローテーションとアーカイブ）

### 4.7 Docker / systemd障害

#### 4.7.1 コンテナ再起動ループ

**症状:** `docker compose ps` で特定のコンテナが `Restarting` 状態を繰り返す。

**確認手順:**

```bash
cd ~/eapaka-radius-server-poc/deployments

# コンテナ状態の確認
docker compose ps

# 再起動ループ中のコンテナのログ確認
docker compose logs --tail 50 <サービス名>

# コンテナの詳細情報
docker inspect <コンテナ名> --format='{{.State.ExitCode}} {{.State.Error}}'
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| 依存サービス（Valkey等）が起動していない | 依存サービスを先に起動してから対象サービスを再起動 |
| 環境変数の不備 | `.env` ファイルの設定値を確認 |
| イメージの破損 | `docker compose build --no-cache <サービス名>` で再ビルド |

> **参考:** B-02 §13.1（コンテナが起動しない場合）

#### 4.7.2 systemdサービス起動失敗

**症状:** ホストOS再起動後にサービスが自動起動しない。

**確認手順:**

```bash
# systemdサービスの状態確認
sudo systemctl status eapaka-radius.service

# サービスのログ確認
sudo journalctl -u eapaka-radius.service --no-pager -n 50

# Docker自体の状態確認
sudo systemctl status docker
```

**主な原因と対処:**

| 原因 | 対処 |
|------|------|
| systemdユニットファイルが未登録 | D-08 §6.1の手順でサービスを登録 |
| Dockerサービスが起動していない | `sudo systemctl start docker` → `docker compose up -d` |
| ディスク容量不足 | `df -h` で確認。`docker system prune -af` で不要リソースを削除 |

> **参考:** D-08 §6.1（起動・停止手順）

---

## 5. 復旧手順

### 5.1 個別コンテナ再起動

特定のサービスのみ再起動する場合。

```bash
cd ~/eapaka-radius-server-poc/deployments

# 対象サービスの再起動
docker compose restart <サービス名>

# 再起動後の状態確認
docker compose ps <サービス名>

# ログで正常起動を確認
docker compose logs --tail 10 <サービス名>
```

サービス名の一覧: `auth-server`, `acct-server`, `vector-gw`, `vector-api`, `valkey`, `fluent-bit`

### 5.2 全サービス再起動

全サービスを停止・再起動する場合。

```bash
cd ~/eapaka-radius-server-poc/deployments

# 全サービスの停止
docker compose down

# 全サービスの起動
docker compose up -d

# 全コンテナの状態確認
docker compose ps

# ヘルスチェック（全サービスが healthy になるまで待機）
sleep 30
docker compose ps
```

> **注意:** `docker compose down` はコンテナを削除するが、Valkeyのデータボリュームは保持される。

### 5.3 Valkeyデータ復旧（バックアップリストア）

D-08 §2.4に基づくバックアップからのリストア手順。

```bash
cd ~/eapaka-radius-server-poc/deployments

# 1. 全サービスの停止
docker compose down

# 2. 現在のValkeyデータボリュームを削除
docker volume rm deployments_valkey-data

# 3. バックアップファイルの確認（最新のバックアップを選択）
ls -lt ~/eapaka-radius-server-poc/backups/valkey/

# 4. Valkeyのみ起動してリストア
docker compose up -d valkey
sleep 5

# 5. バックアップからリストア（ファイル名は実際のバックアップに合わせる）
docker compose exec -T valkey valkey-cli -a "${VALKEY_PASSWORD}" --pipe < ~/eapaka-radius-server-poc/backups/valkey/<バックアップファイル名>

# 6. リストア結果の確認
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" dbsize

# 7. 全サービスの起動
docker compose up -d

# 8. 状態確認
docker compose ps
```

> **参考:** D-08 §2.4（バックアップ・リストア手順）

### 5.4 Circuit Breaker復旧確認

Circuit BreakerがOpen状態になった後、Vector Gateway/APIの復旧により自動的にClose状態に戻ることを確認する。

```bash
cd ~/eapaka-radius-server-poc/deployments

# 1. Vector Gateway/APIの状態確認
curl -fsS http://localhost:8080/health
curl -fsS http://localhost:8081/health

# 2. Circuit Breaker状態遷移をログで確認
docker compose logs auth-server | grep -E "CB_OPEN|CB_HALF_OPEN|CB_CLOSE" | tail -10
```

復旧フロー:
1. Vector Gateway/API復旧後、30秒でHalf-Open状態に自動遷移（`CB_HALF_OPEN`）
2. Half-Open状態で2回成功するとClose状態に復帰（`CB_CLOSE`）
3. `CB_CLOSE` がログに出力されれば復旧完了

> **参考:** D-06 §4.3（Circuit Breaker設定）

### 5.5 SQNリセット手順（Admin TUI経由）

特定加入者のSQN値をリセットする場合、Admin TUIを使用する。

```bash
# Admin TUIの起動
cd ~/eapaka-radius-server-poc/deployments
docker compose exec -it admin-tui /app/admin-tui
```

Admin TUI操作手順:
1. メインメニューから「Subscriber Management」を選択
2. 対象加入者を一覧から選択
3. 加入者の編集画面でSQN値を `000000000000`（初期値）にリセット
4. 保存を実行

> **参考:** O-01 §3.3（加入者の編集）

---

## 6. エスカレーション

### 6.1 対応体制

| 役割 | 担当 | 対応範囲 |
|------|------|---------|
| **一次対応者**（運用担当者） | 運用チーム | ヘルスチェック、サービス再起動、ログ確認、定型復旧作業 |
| **二次対応者**（開発担当者） | 開発チーム | ログ分析、設定修正、コード修正、非定型障害の調査 |

### 6.2 エスカレーション判断基準

以下のいずれかに該当する場合、二次対応者（開発担当者）へエスカレーションする。

| 条件 | 具体例 |
|------|--------|
| 再起動で復旧しない | コンテナ再起動を2回実施しても同じエラーが再発 |
| `SYS_ERR` が発生した | Panic等のシステムレベルのエラー |
| 原因が特定できない | ログを確認しても障害の原因が判断できない |
| データ不整合の疑い | Valkeyのデータが不正な状態と推測される |
| 全加入者に影響する障害 | `AUTH_RES_MISMATCH` 等が全加入者で発生 |
| セキュリティ懸念 | 不正なアクセスパターンの検出 |

### 6.3 ログエビデンスの保全方法

エスカレーション時には、障害発生時のログを保全して開発担当者に提供する。

```bash
# 障害発生時刻前後のログをバックアップ
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
mkdir -p ~/eapaka-radius-server-poc/incident_logs/${TIMESTAMP}

# 全サービスのログをコピー
cp ~/eapaka-radius-server-poc/deployments/logs_on_host/*.log \
   ~/eapaka-radius-server-poc/incident_logs/${TIMESTAMP}/

# docker compose psの出力を保存
cd ~/eapaka-radius-server-poc/deployments
docker compose ps > ~/eapaka-radius-server-poc/incident_logs/${TIMESTAMP}/container_status.txt

# docker statsの出力を保存
docker stats --no-stream > ~/eapaka-radius-server-poc/incident_logs/${TIMESTAMP}/resource_usage.txt

# Valkeyの情報を保存
docker compose exec valkey valkey-cli -a "${VALKEY_PASSWORD}" info \
   > ~/eapaka-radius-server-poc/incident_logs/${TIMESTAMP}/valkey_info.txt 2>/dev/null
```

> **参考:** O-05 §10.4（テスト結果のログエビデンス保全）

### 6.4 障害報告テンプレート

エスカレーション時には以下のテンプレートに沿って報告する。

```
## 障害報告

**発生日時:** YYYY-MM-DD HH:MM:SS
**報告者:** （氏名）
**障害レベル:** Critical / Error / Warning

### 症状
（ユーザーへの影響と確認された症状を記載）

### 影響範囲
- 影響サービス: （例: Auth Server, Acct Server）
- 影響ユーザー数: （例: 全ユーザー / 特定加入者のみ）

### 実施した対応
1. （実施した手順を時系列で記載）
2. ...

### 現在の状態
（復旧済み / 未復旧 / 一部復旧）

### エビデンス
- ログ保全先: ~/eapaka-radius-server-poc/incident_logs/YYYYMMDD_HHMMSS/
- 主要なevent_id: （例: SYS_ERR, VALKEY_CONN_ERR）

### 備考
（その他の観察事項）
```

---

## 7. 障害対応チェックリスト

障害対応時に使用するチェックリスト。対応完了後に確認する。

### 初動確認

- [ ] `docker compose ps` で全コンテナの状態を確認した
- [ ] 障害の影響範囲（全体/特定サービス/特定加入者）を特定した
- [ ] 障害レベル（Critical/Error/Warning）を判定した

### 切り分け・復旧

- [ ] §3のフローチャートに従い、障害コンポーネントを特定した
- [ ] §4の該当セクションの手順に従い対処を実施した
- [ ] 復旧後、`docker compose ps` で全サービスの正常稼働を確認した
- [ ] ヘルスチェック（§2.4）で全エンドポイントの応答を確認した

### 復旧後確認

- [ ] 認証リクエスト（Access-Request）が正常に処理されることを確認した
- [ ] 課金リクエスト（Accounting-Request）が正常に処理されることを確認した
- [ ] ログ出力が正常に行われていることを確認した
- [ ] Circuit Breakerの状態が `CB_CLOSE`（正常）であることを確認した

### 記録・報告

- [ ] 障害発生時のログエビデンスを保全した（§6.3）
- [ ] エスカレーションが必要な場合、障害報告を作成した（§6.4）
- [ ] 再発防止に必要な対応（設定変更等）を記録した

---

## 改訂履歴

| 版数 | 日付 | 内容 |
|------|------|------|
| r1 | 2026-02-27 | 初版作成。障害検知・切り分け・コンポーネント別対応・復旧手順・エスカレーション・チェックリストを体系化。 |
